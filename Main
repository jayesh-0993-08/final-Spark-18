<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>spark - Integrated Dashboard</title>
    <script src="https://cdn.tailwindcss.com" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.js" defer></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: #0f1020;
            --card: #0b1220;
            --accent1: #6EE7B7;
            --accent2: #7C4DFF;
            --neon: #00FFE1;
            --glass: rgba(255, 255, 255, 0.04);
            --muted: #bfc7d6;
            --radius: 14px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .camera-container {
            position: relative;
            width: 100%;
            padding-bottom: 60%;
        }

        video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 1.5rem;
            background-color: black;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        .attendance-marker {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        /* Neon Rescheduler Styles */
        .panel {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
            border: 1px solid rgba(124, 77, 255, 0.09);
            border-radius: var(--radius);
            padding: 16px;
            box-shadow: 0 10px 30px rgba(2, 6, 23, 0.6), 0 0 30px rgba(124, 77, 255, 0.04) inset;
        }

        .input,
        select,
        textarea {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.06);
            padding: 10px 12px;
            border-radius: 10px;
            color: #eaf6ff;
            outline: none;
        }

        .btn {
            background: linear-gradient(90deg, var(--accent2), var(--accent1));
            border: none;
            color: #041024;
            padding: 10px 14px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 6px 16px rgba(124, 77, 255, 0.18);
        }

        .subject-chip {
            background: linear-gradient(90deg, rgba(124, 77, 255, 0.12), rgba(110, 231, 183, 0.06));
            border-radius: 10px;
            padding: 8px;
            min-width: 260px;
            border: 1px solid rgba(255, 255, 255, 0.03);
            color: var(--neon);
            font-size: 13px;
        }

        table.grid {
            width: 100%;
            border-collapse: collapse;
        }

        table.grid th,
        table.grid td {
            border: 1px solid rgba(255, 255, 255, 0.04);
            padding: 10px;
            text-align: center;
            font-size: 14px;
        }

        .badge {
            padding: 6px 10px;
            border-radius: 999px;
            background: linear-gradient(90deg, #00ffe1, #7c4dff);
            color: #041018;
            font-weight: 700;
            font-size: 13px;
            box-shadow: 0 8px 18px rgba(124, 77, 255, 0.08);
        }
    </style>

    <script type="importmap">
    {
        "imports": {
            "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
    }
    </script>

    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // 1. PASTE YOUR NEW API KEY HERE
        // IMPORTANT: Replace with your own API key. Never commit API keys to version control.
        const API_KEY = "Enter your API key";


        try {
            if (!API_KEY || API_KEY === 'Enter your API key' || API_KEY.trim() === '') {
                console.warn('API key not set. AI features will be disabled.');
                window.geminiAI = {
                    sendMessage: async function (userMessage, onChunk) {
                        if (typeof onChunk === 'function') {
                            onChunk('❌ API key not configured. Please set your API key in the code.');
                        }
                    }
                };
            } else {
                const genAI = new GoogleGenerativeAI(API_KEY);

            const model = genAI.getGenerativeModel({
                model: "gemini-2.5-flash",
                systemInstruction: "You are a helpful assistant for the SmartClass student portal. Keep answers concise."
            });
            const chat = model.startChat({ history: [] });

            window.geminiAI = {
                sendMessage: async function (userMessage, onChunk) {
                    try {
                        if (!userMessage || typeof userMessage !== 'string') {
                            throw new Error('Invalid message');
                        }
                        const result = await chat.sendMessageStream(userMessage);
                        for await (const chunk of result.stream) {
                            if (chunk && chunk.text && typeof onChunk === 'function') {
                                onChunk(chunk.text());
                            }
                        }
                    } catch (error) {
                        console.error('Error sending message to AI:', error);
                        if (typeof onChunk === 'function') {
                            onChunk('❌ Error: ' + (error.message || 'Failed to get response'));
                        }
                        throw error;
                    }
                }
            };
            console.log("✅ AI System Initialized");
            }
        } catch (e) {
            console.error("AI Init Error:", e);
        }
    </script>

    <style>
        /* Gemini Chat Widget Styles */
        .gemini-chat-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 380px;
            max-height: 500px;
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4), 0 0 40px rgba(79, 172, 254, 0.1);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            overflow: hidden;
            z-index: 9999;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .gemini-chat-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .gemini-chat-header h3 {
            margin: 0;
            color: #0a0a1a;
            font-size: 16px;
            font-weight: 600;
        }

        .gemini-chat-header .gemini-icon {
            width: 28px;
            height: 28px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gemini-chat-messages {
            height: 320px;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .gemini-message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .gemini-message.user {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: #0a0a1a;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .gemini-message.assistant {
            background: rgba(255, 255, 255, 0.08);
            color: #e0e0e0;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .gemini-chat-input-container {
            padding: 16px;
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            gap: 10px;
        }

        .gemini-chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .gemini-chat-input:focus {
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.2);
        }

        .gemini-chat-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .gemini-send-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            border-radius: 10px;
            color: #0a0a1a;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .gemini-send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(79, 172, 254, 0.4);
        }

        .gemini-send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .gemini-typing {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
        }

        .gemini-typing span {
            width: 8px;
            height: 8px;
            background: #4facfe;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .gemini-typing span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .gemini-typing span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        .gemini-toggle-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 8px 30px rgba(79, 172, 254, 0.4);
            z-index: 9998;
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gemini-toggle-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 40px rgba(79, 172, 254, 0.5);
        }

        .gemini-toggle-btn svg {
            width: 28px;
            height: 28px;
            fill: #0a0a1a;
        }
    </style>
</head>

<body class="bg-gray-900 min-h-screen text-white">

    <!-- Global Error Handler for Debugging -->
    <script>
        window.onerror = function (msg, url, line, col, error) {
            console.error("Global Error:", msg, line, error);
            // Optional: alert("Error: " + msg + "\nLine: " + line);
        };
    </script>

    <!-- LANDING PAGE / AUTH SCREENS (Full Screen - Moved Outside Main App) -->
    <div id="auth-screens" class="min-h-screen flex flex-col justify-center items-center p-4">
        <!-- Role Selection Screen -->
        <div id="role-selection" class="flex flex-col items-center justify-center w-full max-w-6xl fade-in">
            <div class="text-center mb-16">
                <!-- Logo/Icon -->
                <div class="inline-flex items-center justify-center w-24 h-24 rounded-3xl bg-blue-600/10 mb-8">
                    <i class="fas fa-graduation-cap text-6xl text-blue-500"></i>
                </div>
                <h1 class="text-5xl md:text-6xl font-bold text-white mb-6 tracking-tight">Welcome to SPARK</h1>
                <p class="text-gray-400 text-xl max-w-2xl mx-auto">Your comprehensive platform for modern education
                    management. Select your role to get started.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 w-full px-4">
                <!-- Student Card -->
                <div class="bg-[#1a1c2e] p-10 rounded-3xl border border-gray-800 hover:border-blue-500 transition-all duration-300 group hover:-translate-y-2 hover:shadow-2xl hover:shadow-blue-500/10 flex flex-col items-center text-center cursor-pointer h-full"
                    onclick="enterStudentPortal()">
                    <div
                        class="w-24 h-24 rounded-full bg-blue-500/10 flex items-center justify-center mb-8 group-hover:scale-110 transition-transform duration-300">
                        <i class="fas fa-user-graduate text-4xl text-blue-400"></i>
                    </div>
                    <h3 class="text-3xl font-bold text-white mb-4">Student</h3>
                    <p class="text-gray-400 text-base mb-10 leading-relaxed flex-grow">Access your attendance, manage
                        your timetable, and receive personalized learning suggestions.</p>
                    <button onclick="enterStudentPortal()"
                        class="w-full py-4 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-bold text-lg transition-all shadow-lg hover:shadow-blue-500/25">
                        Login as Student
                    </button>

                </div>

                <!-- Teacher Card -->
                <div class="relative z-50 bg-[#1a1c2e] p-10 rounded-3xl border border-gray-800 hover:border-green-500 transition-all duration-300 group hover:-translate-y-2 hover:shadow-2xl hover:shadow-green-500/10 flex flex-col items-center text-center cursor-pointer h-full"
                    onclick="console.log('Teacher card clicked'); window.enterTeacherPortal()">
                    <div
                        class="w-24 h-24 rounded-full bg-green-500/10 flex items-center justify-center mb-8 group-hover:scale-110 transition-transform duration-300">
                        <i class="fas fa-chalkboard-teacher text-4xl text-green-400"></i>
                    </div>
                    <h3 class="text-3xl font-bold text-white mb-4">Teacher</h3>
                    <p class="text-gray-400 text-base mb-10 leading-relaxed flex-grow">Mark class attendance, update
                        scheduling, and manage academic resources.</p>
                    <button onclick="console.log('Teacher button clicked'); window.enterTeacherPortal()"
                        class="w-full py-4 rounded-xl bg-green-600 hover:bg-green-700 text-white font-bold text-lg transition-all shadow-lg hover:shadow-green-500/25">
                        Login as Teacher
                    </button>


                </div>

                <!-- Admin Card -->
                <div class="relative z-50 bg-[#1a1c2e] p-10 rounded-3xl border border-gray-800 hover:border-purple-500 transition-all duration-300 group hover:-translate-y-2 hover:shadow-2xl hover:shadow-purple-500/10 flex flex-col items-center text-center cursor-pointer h-full"
                    onclick="console.log('Admin card clicked'); window.enterAdminPortal()">
                    <div
                        class="w-24 h-24 rounded-full bg-purple-500/10 flex items-center justify-center mb-8 group-hover:scale-110 transition-transform duration-300">
                        <i class="fas fa-user-shield text-4xl text-purple-400"></i>
                    </div>
                    <h3 class="text-3xl font-bold text-white mb-4">Administrator</h3>
                    <p class="text-gray-400 text-base mb-10 leading-relaxed flex-grow">System configuration, user
                        management, and institutional oversight.</p>
                    <button onclick="console.log('Admin button clicked'); window.enterAdminPortal()"
                        class="w-full py-4 rounded-xl bg-purple-600 hover:bg-purple-700 text-white font-bold text-lg transition-all shadow-lg hover:shadow-purple-500/25">
                        Login as Admin
                    </button>


                </div>
            </div>
        </div>

        <!-- Student Login/Register (Hidden by default, shown after clicking Student) -->
        <div id="student-auth" class="hidden w-full max-w-md">
            <!-- Entry Screen: Unified Google Flow -->
            <div id="home-screen" class="bg-gray-800 p-8 rounded-3xl shadow-xl border border-gray-700">
                <header class="text-center mb-10">
                    <h1 class="text-3xl font-bold text-white mb-3">Student Portal</h1>
                    <p class="text-gray-400">Secure Access via Google & Face ID</p>
                </header>

                <div class="space-y-8">
                    <div id="google-btn-container" class="flex flex-col items-center gap-6">
                        <div id="g_id_onload"
                            data-client_id="238435003143-8n2s8od8bccersg0efjqm4r1gij8uaif.apps.googleusercontent.com"
                            data-context="signup" data-ux_mode="popup" data-callback="handleCredentialResponse"
                            data-auto_prompt="false">
                        </div>

                        <div class="g_id_signin" data-type="standard" data-shape="pill" data-theme="filled_blue"
                            data-text="continue_with" data-size="large" data-logo_alignment="left" data-width="320">
                        </div>

                        <p class="text-xs text-center text-gray-500 max-w-[280px]">
                            By continuing, you agree to verify your identity using Face Recognition for attendance
                            tracking.
                        </p>
                    </div>

                    <div class="flex items-center gap-4">
                        <div class="flex-1 border-t border-gray-700"></div>
                        <span class="text-sm text-gray-500">or</span>
                        <div class="flex-1 border-t border-gray-700"></div>
                    </div>

                    <button id="manual-entry-btn" onclick="showManualEntryForm()"
                        class="w-full py-3 px-4 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-medium text-base transition-all shadow-md hover:shadow-lg border border-indigo-500 hover:border-indigo-400">
                        <i class="fas fa-user-plus mr-2"></i>Manual Entry & Face Registration
                    </button>

                    <div id="manual-entry-container" class="hidden">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Full Name</label>
                                <input type="text" id="manual-fullname" placeholder="Enter your full name"
                                    class="w-full px-4 py-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Email Address</label>
                                <input type="email" id="manual-email" placeholder="Enter your email"
                                    class="w-full px-4 py-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">College ID</label>
                                <input type="text" id="manual-college-id" placeholder="Enter your college ID"
                                    class="w-full px-4 py-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                           
                            <!-- Face Registration Camera -->
                            <div class="mt-4">
                                <label class="block text-sm font-medium text-gray-300 mb-2">Face Registration</label>
                                <div id="manual-face-registration" class="camera-container rounded-lg overflow-hidden border-2 border-gray-600 relative bg-black" style="height: 300px;">
                                    <video id="manual-video-reg" class="block w-full h-full object-cover"></video>
                                    <canvas id="manual-canvas-reg" class="absolute top-0 left-0"></canvas>
                                    <div id="manual-face-status" class="absolute bottom-0 left-0 right-0 bg-black/70 text-white text-center py-2 text-sm">
                                        Position your face in front of the camera
                                    </div>
                                </div>
                                <button id="manual-start-camera-btn" onclick="startManualFaceRegistration()"
                                    class="w-full mt-2 py-2 px-4 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-medium text-sm transition-all">
                                    <i class="fas fa-camera mr-2"></i>Start Camera
                                </button>
                                <button id="manual-capture-face-btn" onclick="captureManualFace()"
                                    class="w-full mt-2 py-2 px-4 rounded-lg bg-green-600 hover:bg-green-700 text-white font-medium text-sm transition-all hidden">
                                    <i class="fas fa-check mr-2"></i>Capture Face
                                </button>
                            </div>

                            <button onclick="handleManualEntry()" id="manual-submit-btn"
                                class="w-full py-3 px-4 rounded-xl bg-green-600 hover:bg-green-700 text-white font-medium text-base transition-all shadow-md hover:shadow-lg disabled:bg-gray-600 disabled:cursor-not-allowed"
                                disabled>
                                <i class="fas fa-check mr-2"></i>Register & Continue
                            </button>
                            <button onclick="hideManualEntryForm()"
                                class="w-full text-center text-gray-400 hover:text-gray-300 text-sm transition-colors">
                                Cancel
                            </button>
                        </div>
                    </div>

                    <div class="pt-6 border-t border-gray-700">
                        <button onclick="backToRoles()"
                            class="w-full text-center text-gray-500 hover:text-gray-300 text-sm transition-colors">
                            &larr; Back to Role Selection
                        </button>
                    </div>
                </div>
            </div>



        </div>


        <!-- Loading -->
        <div id="loading" class="hidden text-center bg-gray-800 p-8 rounded-3xl shadow-xl">
            <svg class="animate-spin h-12 w-12 text-blue-500 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg"
                fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                </circle>
                <path class="opacity-75" fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                </path>
            </svg>
            <h3 class="text-xl font-bold text-white">Initializing AI</h3>
            <p class="text-gray-400 mt-2">Loading secure face models...</p>
        </div>
    </div>
    <!-- Navigation Bar (Hidden on Landing) -->
    <nav id="navbar" class="hidden bg-blue-600 text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-graduation-cap text-2xl"></i>
                    <span class="text-xl font-bold">spark</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="hidden md:flex flex-col text-right">
                        <span class="font-semibold" id="nav-username">User</span>
                        <span class="text-sm text-blue-200" id="nav-class">Computer Science</span>
                    </div>
                    <img id="nav-profile-photo" class="h-10 w-10 rounded-full border-2 border-white object-cover"
                        src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236366F1'%3E%3Cpath d='M12 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10zm0 2c-6.627 0-12 5.373-12 12h24c0-6.627-5.373-12-12-12z'/%3E%3C/svg%3E"
                        alt="Profile">
                    <button class="bg-blue-700 hover:bg-blue-800 px-4 py-2 rounded-lg transition"
                        onclick="logout()">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile Tabs (Hidden on Landing) -->
    <div id="mobile-tabs" class="hidden bg-gray-800 shadow-md md:hidden">
        <div class="flex overflow-x-auto">
            <button class="tab-btn px-4 py-3 font-medium text-blue-400 border-b-2 border-blue-400"
                data-tab="attendance">
                <i class="fas fa-fingerprint mr-2"></i>Attendance
            </button>
            <button class="tab-btn px-4 py-3 font-medium text-gray-400" data-tab="timetable">
                <i class="fas fa-calendar-alt mr-2"></i>Timetable
            </button>
            <button class="tab-btn px-4 py-3 font-medium text-gray-400" data-tab="rescheduler">
                <i class="fas fa-exchange-alt mr-2"></i>Rescheduler
            </button>
            <button class="tab-btn px-4 py-3 font-medium text-gray-400" data-tab="suggestions">
                <i class="fas fa-lightbulb mr-2"></i>Suggestions
            </button>
        </div>
    </div>

    <!-- MAIN APP CONTENT (Hidden initially) -->
    <div id="main-app" class="hidden container mx-auto px-4 py-6">
        <div class="flex flex-col md:flex-row gap-6">
            <!-- Sidebar (Desktop) -->
            <div class="hidden md:block w-full md:w-1/4 lg:w-1/5">
                <div class="bg-gray-800 rounded-lg shadow-md p-4 mb-6">
                    <div class="flex flex-col items-center text-center mb-6">
                        <img id="sidebar-profile-photo" class="h-24 w-24 rounded-full mb-4 border-4 border-blue-500 object-cover"
                            src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236366F1'%3E%3Cpath d='M12 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10zm0 2c-6.627 0-12 5.373-12 12h24c0-6.627-5.373-12-12-12z'/%3E%3C/svg%3E"
                            alt="Profile">
                        <h2 class="text-xl font-bold" id="sidebar-username">User</h2>
                        <p class="text-gray-400" id="sidebar-id">CS2021BATCH</p>
                        <p class="text-gray-400 text-xs mt-1" id="sidebar-batch">Batch: -</p>
                        <div class="mt-2 bg-green-800 text-green-200 text-xs px-2 py-1 rounded-full">ID Verified</div>
                    </div>

                    <nav class="space-y-2">
                        <button
                            class="tab-btn w-full text-left px-4 py-3 rounded-lg font-medium text-blue-400 bg-blue-900/50 border border-blue-500/20"
                            data-tab="dashboard-home">
                            <i class="fas fa-home mr-3"></i>Dashboard
                        </button>
                        <button
                            class="tab-btn w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700/50 hover:text-gray-200 transition-colors"
                            data-tab="attendance">
                            <i class="fas fa-fingerprint mr-3"></i>Attendance
                        </button>
                        <button
                            class="tab-btn w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700/50 hover:text-gray-200 transition-colors"
                            data-tab="timetable">
                            <i class="fas fa-calendar-alt mr-3"></i>Timetable
                        </button>
                        <!-- Rescheduler Removed from Student Panel -->
                        <button
                            class="tab-btn w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700/50 hover:text-gray-200 transition-colors"
                            data-tab="suggestions">
                            <i class="fas fa-lightbulb mr-3"></i>Suggestions
                        </button>
                        <button
                            class="tab-btn w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700/50 hover:text-gray-200 transition-colors"
                            data-tab="profile">
                            <i class="fas fa-user mr-3"></i>Profile
                        </button>
                        <button
                            class="tab-btn w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700/50 hover:text-gray-200 transition-colors"
                            data-tab="results">
                            <i class="fas fa-poll mr-3"></i>Results
                        </button>
                        <button
                            class="tab-btn w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700/50 hover:text-gray-200 transition-colors"
                            data-tab="study-material">
                            <i class="fas fa-book-open mr-3"></i>Study Material
                        </button>
                        <button
                            class="tab-btn w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700/50 hover:text-gray-200 transition-colors"
                            data-tab="routine">
                            <i class="fas fa-clock mr-3"></i>Daily Routine
                        </button>
                    </nav>
                </div>

                <div class="bg-gray-800 rounded-lg shadow-md p-4">
                    <h3 class="font-bold text-lg mb-3">Today's Schedule</h3>
                    <div class="space-y-3">
                        <div class="flex items-start">
                            <div class="bg-blue-900 text-blue-200 text-xs font-bold px-2 py-1 rounded mr-3">9:00</div>
                            <div>
                                <div class="font-medium">Data Structures</div>
                                <div class="text-xs text-gray-400">Room 302</div>
                            </div>
                        </div>
                        <div class="flex items-start">
                            <div class="bg-blue-900 text-blue-200 text-xs font-bold px-2 py-1 rounded mr-3">10:00</div>
                            <div>
                                <div class="font-medium">Algorithms</div>
                                <div class="text-xs text-gray-400">Room 305</div>
                            </div>
                        </div>
                        <div class="flex items-start">
                            <div class="bg-green-900 text-green-200 text-xs font-bold px-2 py-1 rounded mr-3">11:00
                            </div>
                            <div>
                                <div class="font-medium">Free Period</div>
                                <div class="text-xs text-gray-400">Library</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content (Dashboard & Tabs) -->
            <div class="w-full md:w-3/4 lg:w-4/5">
                <!-- Dashboard Content (Initially Hidden) -->
                <div id="dashboard-content">
                    <!-- Dashboard Home Tab -->
                    <div id="dashboard-home" class="tab-content active">
                        <!-- Welcome Banner -->
                        <div
                            class="relative overflow-hidden rounded-2xl bg-gradient-to-r from-[#4f46e5] to-[#7c3aed] p-8 mb-8 shadow-2xl">
                            <div
                                class="absolute top-0 right-0 -mt-4 -mr-4 w-32 h-32 rounded-full bg-white opacity-10 blur-xl">
                            </div>
                            <div
                                class="absolute bottom-0 left-0 -mb-4 -ml-4 w-24 h-24 rounded-full bg-blue-300 opacity-10 blur-xl">
                            </div>
                            <div class="relative z-10 flex justify-between items-end">
                                <div class="flex items-center gap-4">
                                    <img id="dashboard-profile-photo" class="h-20 w-20 rounded-full border-4 border-white/30 object-cover shadow-lg"
                                        src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236366F1'%3E%3Cpath d='M12 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10zm0 2c-6.627 0-12 5.373-12 12h24c0-6.627-5.373-12-12-12z'/%3E%3C/svg%3E"
                                        alt="Profile">
                                    <div>
                                        <h1 class="text-3xl font-bold text-white mb-1">Welcome back, <span
                                                class="banner-username">User</span>!</h1>
                                        <p class="text-blue-100 mb-1">Here's what's happening today</p>
                                        <p class="text-blue-200 text-sm" id="dashboard-batch-info">Batch: Not selected</p>
                                    </div>
                                </div>
                                <div class="text-right hidden sm:block">
                                    <div class="text-sm text-blue-200" id="current-date-display">Wednesday, January 14,
                                        2026
                                    </div>
                                    <div class="text-2xl font-bold text-white space-mono" id="current-time-display">
                                        09:09 PM
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Stats Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <!-- Card 1 -->
                            <div
                                class="bg-[#1a1c2e] p-5 rounded-xl border-l-4 border-blue-500 shadow-lg relative overflow-hidden group hover:bg-[#202336] transition-colors">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-gray-400 text-sm font-medium mb-1">Today's Attendance</p>
                                        <h3 class="text-2xl font-bold text-white" id="today-attendance-count">0/0</h3>
                                    </div>
                                    <div class="p-2 bg-blue-500/10 rounded-lg text-blue-400">
                                        <i class="fas fa-fingerprint text-xl"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Card 2 -->
                            <div
                                class="bg-[#1a1c2e] p-5 rounded-xl border-l-4 border-green-500 shadow-lg relative overflow-hidden group hover:bg-[#202336] transition-colors">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-gray-400 text-sm font-medium mb-1">Upcoming Classes</p>
                                        <h3 class="text-2xl font-bold text-white">2</h3>
                                    </div>
                                    <div class="p-2 bg-green-500/10 rounded-lg text-green-400">
                                        <i class="fas fa-calendar-check text-xl"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Card 3 -->
                            <div
                                class="bg-[#1a1c2e] p-5 rounded-xl border-l-4 border-amber-500 shadow-lg relative overflow-hidden group hover:bg-[#202336] transition-colors">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-gray-400 text-sm font-medium mb-1">This Week</p>
                                        <h3 class="text-2xl font-bold text-white">0%</h3>
                                    </div>
                                    <div class="p-2 bg-amber-500/10 rounded-lg text-amber-400">
                                        <i class="fas fa-chart-line text-xl"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Card 4 -->
                            <div
                                class="bg-[#1a1c2e] p-5 rounded-xl border-l-4 border-purple-500 shadow-lg relative overflow-hidden group hover:bg-[#202336] transition-colors">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-gray-400 text-sm font-medium mb-1">Total Classes</p>
                                        <h3 class="text-2xl font-bold text-white">12</h3>
                                    </div>
                                    <div class="p-2 bg-purple-500/10 rounded-lg text-purple-400">
                                        <i class="fas fa-book text-xl"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Quick Actions -->
                            <div class="lg:col-span-2 space-y-6">
                                <h3 class="flex items-center text-lg font-bold text-yellow-400">
                                    <i class="fas fa-bolt mr-2"></i> Quick Actions
                                </h3>

                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <button
                                        class="bg-blue-600 hover:bg-blue-700 text-white p-6 rounded-xl shadow-lg transition transform hover:-translate-y-1 flex flex-col items-center justify-center gap-3 h-32"
                                        onclick="(function(){const tab=document.querySelector('[data-tab=attendance]');if(tab)tab.click()})()">
                                        <div
                                            class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center text-2xl">
                                            <i class="fas fa-fingerprint"></i>
                                        </div>
                                        <span class="font-bold">Mark Attendance</span>
                                    </button>

                                    <button
                                        class="bg-green-600 hover:bg-green-700 text-white p-6 rounded-xl shadow-lg transition transform hover:-translate-y-1 flex flex-col items-center justify-center gap-3 h-32"
                                        onclick="(function(){const tab=document.querySelector('[data-tab=timetable]');if(tab)tab.click()})()">
                                        <div
                                            class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center text-2xl">
                                            <i class="fas fa-calendar-alt"></i>
                                        </div>
                                        <span class="font-bold">View Timetable</span>
                                    </button>

                                    <button
                                        class="bg-purple-600 hover:bg-purple-700 text-white p-6 rounded-xl shadow-lg transition transform hover:-translate-y-1 flex flex-col items-center justify-center gap-3 h-32"
                                        onclick="(function(){const tab=document.querySelector('[data-tab=suggestions]');if(tab)tab.click()})()">
                                        <div
                                            class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center text-2xl">
                                            <i class="fas fa-lightbulb"></i>
                                        </div>
                                        <span class="font-bold">Suggestions</span>
                                    </button>

                                    <button
                                        class="bg-gray-700 hover:bg-gray-600 text-white p-6 rounded-xl shadow-lg transition transform hover:-translate-y-1 flex flex-col items-center justify-center gap-3 h-32"
                                        onclick="(function(){const tab=document.querySelector('[data-tab=profile]');if(tab)tab.click()})()">
                                        <div
                                            class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center text-2xl">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <span class="font-bold">My Profile</span>
                                    </button>
                                </div>

                                <!-- Recent Activity Section -->
                                <div class="mt-8">
                                    <h3 class="flex items-center text-lg font-bold text-gray-200 mb-4">
                                        <i class="fas fa-history mr-2"></i> Recent Activity
                                    </h3>
                                    <div id="recent-activity-list" class="space-y-4">
                                        <!-- Dynamic activity logs will appear here -->
                                        <p class="text-gray-500 text-center py-4">No recent activity.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Today's Schedule Column -->
                            <div class="bg-[#1a1c2e] p-6 rounded-xl border border-gray-800 shadow-lg h-full">
                                <h3 class="flex items-center text-lg font-bold text-blue-400 mb-6">
                                    <i class="fas fa-clock mr-2"></i> Today's Schedule
                                </h3>

                                <div class="space-y-4">
                                    <div class="bg-gray-800/50 p-4 rounded-xl border-l-4 border-green-500 relative">
                                        <div class="flex justify-between items-start mb-1">
                                            <span
                                                class="bg-blue-600/90 text-white text-xs font-bold px-2 py-1 rounded">9:00</span>
                                            <span
                                                class="text-[10px] text-green-400 bg-green-900/40 px-2 py-0.5 rounded-full border border-green-900">Completed</span>
                                        </div>
                                        <h4 class="font-bold text-white">Data Structures</h4>
                                        <p class="text-xs text-gray-400 mt-1">Room 302 • Prof. Sharma</p>
                                    </div>

                                    <div class="bg-gray-800/50 p-4 rounded-xl border-l-4 border-amber-500 relative">
                                        <div class="flex justify-between items-start mb-1">
                                            <span
                                                class="bg-blue-600/90 text-white text-xs font-bold px-2 py-1 rounded">10:00</span>
                                            <span
                                                class="text-[10px] text-amber-400 bg-amber-900/40 px-2 py-0.5 rounded-full border border-amber-900">In
                                                Progress</span>
                                        </div>
                                        <h4 class="font-bold text-white">Algorithms</h4>
                                        <p class="text-xs text-gray-400 mt-1">Room 305 • Prof. Gupta</p>
                                    </div>

                                    <div class="bg-gray-800/50 p-4 rounded-xl border-l-4 border-blue-500 relative">
                                        <div class="flex justify-between items-start mb-1">
                                            <span
                                                class="bg-green-600/90 text-white text-xs font-bold px-2 py-1 rounded">11:00</span>
                                            <span
                                                class="text-[10px] text-blue-400 bg-blue-900/40 px-2 py-0.5 rounded-full border border-blue-900">Upcoming</span>
                                        </div>
                                        <h4 class="font-bold text-white">Free Period</h4>
                                        <p class="text-xs text-gray-400 mt-1">Library • Self Study</p>
                                    </div>
                                </div>

                                <button onclick="(function(){const tab=document.querySelector('[data-tab=timetable]');if(tab)tab.click()})()"
                                    class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold text-sm transition shadow-lg">
                                    View Full Timetable →
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Attendance Tab -->
                    <div id="attendance" class="tab-content">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-bold mb-4">Mark Attendance</h2>

                            <!-- Camera View -->
                            <div id="attendance-camera-view"
                                class="camera-container rounded-3xl overflow-hidden mb-6 shadow-md mx-auto border-2 border-gray-700 relative"
                                style="max-width: 500px;">
                                <video id="video-attendance" class="block bg-black"></video>
                                <canvas id="canvas-attendance" class="block"></canvas>

                                <!-- Challenger Overlay (Moved here for attendance) -->
                                <div id="liveness-overlay-attendance"
                                    class="absolute inset-0 flex flex-col items-center justify-center bg-black/80 z-20 hidden backdrop-blur-sm">
                                    <div id="challenge-icon-container-attendance"
                                        class="mb-4 transform transition-all duration-300">
                                        <i id="challenge-icon-attendance"
                                            class="fas fa-smile text-6xl text-yellow-400"></i>
                                    </div>
                                    <h3 id="challenge-text-attendance"
                                        class="text-3xl font-bold text-white mb-2 text-center drop-shadow-lg">Task 1:
                                        Smile</h3>
                                    <p id="challenge-sub-attendance" class="text-gray-300 text-sm">Action required for
                                        verification</p>
                                </div>
                            </div>

                            <!-- Locked/Success View (Initially Hidden) -->
                            <div id="attendance-locked-view"
                                class="hidden rounded-3xl mb-6 shadow-md mx-auto bg-green-900/20 border border-green-500/30 flex flex-col items-center justify-center py-12"
                                style="max-width: 500px; height: 375px;">
                                <div
                                    class="w-24 h-24 rounded-full bg-green-500 flex items-center justify-center mb-6 shadow-lg shadow-green-500/50 animate-bounce">
                                    <i class="fas fa-check text-4xl text-white"></i>
                                </div>
                                <h3 class="text-2xl font-bold text-white mb-2">Attendance Marked</h3>
                                <p class="text-green-300">You have successfully checked in.</p>
                            </div>
                            <div id="attendance-portal-message"
                                class="hidden text-center p-6 bg-red-900/20 border border-red-500/30 rounded-2xl mb-6">
                                <i class="fas fa-lock text-3xl text-red-500 mb-2"></i>
                                <h4 class="text-lg font-bold text-white">Portal Closed</h4>
                                <p class="text-sm text-gray-400">Your teacher hasn't opened the attendance portal for
                                    the current class yet.</p>
                            </div>

                            <button id="mark-attendance-btn"
                                class="w-full px-8 py-3 bg-blue-600 text-white rounded-full font-semibold hover:bg-blue-700 transition transform hover:scale-105 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>Mark Attendance with Face Recognition</button>

                            <div id="attendance-timer-container"
                                class="hidden mt-6 bg-yellow-900/30 border border-yellow-600/50 p-4 rounded-xl text-center">
                                <p class="text-yellow-400 font-bold mb-2"><i class="fas fa-lock mr-2"></i>Attendance
                                    Locked</p>
                                <p class="text-gray-300 text-sm mb-2" id="attendance-lock-msg">Class in progress</p>
                                <div class="text-3xl font-mono text-white" id="attendance-countdown">00:00:00</div>
                            </div>
                            <div class="mt-8">
                                <h3 class="text-xl font-semibold mb-4">Today's Attendance</h3>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full bg-gray-700 rounded-lg">
                                        <thead>
                                            <tr>
                                                <th class="py-2 px-4 border-b border-gray-600">Class</th>
                                                <th class="py-2 px-4 border-b border-gray-600">Time</th>
                                                <th class="py-2 px-4 border-b border-gray-600">Method</th>
                                                <th class="py-2 px-4 border-b border-gray-600">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="py-2 px-4 border-b border-gray-600">Data Structures</td>
                                                <td class="py-2 px-4 border-b border-gray-600">9:00 AM</td>
                                                <td class="py-2 px-4 border-b border-gray-600">Face</td>
                                                <td class="py-2 px-4 border-b border-gray-600">
                                                    <span
                                                        class="px-2 py-1 rounded-full text-xs bg-green-800 text-green-200">Present</span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="py-2 px-4 border-b border-gray-600">Algorithms</td>
                                                <td class="py-2 px-4 border-b border-gray-600">10:00 AM</td>
                                                <td class="py-2 px-4 border-b border-gray-600">-</td>
                                                <td class="py-2 px-4 border-b border-gray-600">
                                                    <span
                                                        class="px-2 py-1 rounded-full text-xs bg-yellow-800 text-yellow-200">Pending</span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Timetable Tab -->
                    <div id="timetable" class="tab-content">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-md min-h-[600px]">
                            <div class="flex justify-between items-center mb-8 border-b border-gray-700 pb-6">
                                <div>
                                    <h2 class="text-3xl font-bold text-white mb-2">My Weekly Schedule</h2>
                                    <p class="text-gray-400">View your weekly classes and timings</p>
                                </div>
                                <div class="flex flex-col items-end gap-2">
                                    <div id="timetable-current-date" class="text-lg font-semibold text-blue-400"></div>
                                    <div id="timetable-current-time" class="text-sm text-gray-400"></div>
                                </div>
                            </div>

                            <!-- Timetable Display Area -->
                            <div id="timetable-display" class="space-y-6">
                                <!-- Empty State -->
                                <div id="timetable-empty"
                                    class="flex flex-col items-center justify-center py-20 border-2 border-dashed border-gray-700/50 rounded-3xl bg-gray-800/30">
                                    <div
                                        class="w-20 h-20 rounded-full bg-gray-700/50 flex items-center justify-center mb-6 ring-4 ring-gray-800">
                                        <i class="fas fa-calendar-alt text-3xl text-gray-500"></i>
                                    </div>
                                    <h3 class="text-2xl font-bold text-gray-200 mb-2">No Schedule Found</h3>
                                    <p class="text-gray-400 max-w-md text-center mb-8 leading-relaxed">
                                        Your timetable will appear here once your batch schedule is set by the administrator.
                                    </p>
                                </div>

                                <!-- Week-wise Timetable Grid (Hidden initially) -->
                                <div id="timetable-container" class="hidden animate-fade-in">
                                    <div class="overflow-x-auto">
                                        <table id="student-timetable-grid" class="w-full border-collapse bg-gray-900/50 rounded-lg">
                                            <thead>
                                                <tr class="bg-gray-800">
                                                    <th class="p-3 border border-gray-700 text-gray-300 font-semibold">Time</th>
                                                    <th class="p-3 border border-gray-700 text-gray-300 font-semibold">Monday</th>
                                                    <th class="p-3 border border-gray-700 text-gray-300 font-semibold">Tuesday</th>
                                                    <th class="p-3 border border-gray-700 text-gray-300 font-semibold">Wednesday</th>
                                                    <th class="p-3 border border-gray-700 text-gray-300 font-semibold">Thursday</th>
                                                    <th class="p-3 border border-gray-700 text-gray-300 font-semibold">Friday</th>
                                                    <th class="p-3 border border-gray-700 text-gray-300 font-semibold">Saturday</th>
                                                </tr>
                                            </thead>
                                            <tbody id="student-timetable-body">
                                                <!-- Dynamic schedule rows -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="mt-6 flex items-center gap-4 text-sm">
                                        <div class="flex items-center gap-2">
                                            <div class="w-4 h-4 bg-blue-600 rounded"></div>
                                            <span class="text-gray-400">Upcoming</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <div class="w-4 h-4 bg-gray-600 rounded"></div>
                                            <span class="text-gray-400">Completed</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <div class="w-4 h-4 bg-green-600 rounded"></div>
                                            <span class="text-gray-400">Current</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Rescheduler Tab -->
                    <div id="rescheduler" class="tab-content">
                        <div class="panel">
                            <div class="flex-between">
                                <div>
                                    <strong>Step 1 — Setup</strong>
                                    <div style="color:var(--muted); font-size:13px; margin-top:6px">Add classes and
                                        subjects. Each subject needs a teacher and class average for that subject.</div>
                                </div>
                                <div style="display:flex;gap:8px">
                                    <button class="btn" id="addClassBtn">+ Add Class</button>
                                    <button class="btn ghost" id="resetBtn">Reset All</button>
                                </div>
                            </div>

                            <div class="classes" id="classesContainer"></div>

                            <hr
                                style="border:none; height:1px; margin:14px 0; background:linear-gradient(90deg, transparent, rgba(124,77,255,0.06), transparent)">

                            <div style="margin-top:8px">
                                <div class="row">
                                    <label class="small">Number of lectures (per day)</label>
                                    <input id="periodCount" class="input" type="number" min="1" value="6" />
                                    <label class="small">(Name your lectures optional - left blank uses
                                        P1,P2...)</label>
                                </div>

                                <div class="row" style="margin-top:10px">
                                    <label class="small">Create Timetable for each class (use the subject names you
                                        added, comma separated per lectures )</label>
                                    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:8px"
                                        id="timetablesInputs"></div>
                                </div>
                            </div>

                            <hr
                                style="border:none; height:1px; margin:14px 0; background:linear-gradient(90deg, transparent, rgba(124,77,255,0.06), transparent)">

                            <div>
                                <strong>Step 2 — Absent Teacher(s)</strong>
                                <div style="color:var(--muted); font-size:13px; margin-top:6px">Select which teacher(s)
                                    are absent today. You can add multiple absent teachers.</div>

                                <div class="absent-list" id="absentList"></div>
                                <div style="margin-top:10px">
                                    <select id="absentTeacherSelect" class="input"></select>
                                    <button class="btn" id="addAbsentBtn" style="margin-left:8px">+ Add Absent</button>
                                </div>
                            </div>

                            <hr
                                style="border:none; height:1px; margin:14px 0; background:linear-gradient(90deg, transparent, rgba(124,77,255,0.06), transparent)">

                            <div class="flex-between" style="margin-top:8px">
                                <div style="color:var(--muted)">Preview timetable & teacher assignment below (editable)
                                </div>
                                <div>
                                    <button class="btn warn" id="previewBtn">Preview Timetable</button>
                                    <button class="btn" id="regenBtn">Regenerate Schedule →</button>
                                </div>
                            </div>

                            <div class="timetable" id="previewArea" style="display:none; margin-top:12px"></div>
                        </div>

                        <!-- Result View -->
                        <div id="resultView" class="panel" style="display:none; margin-top: 20px;">
                            <div class="result-title">
                                <div>
                                    <strong>Regenerated Day Timetable</strong>
                                    <div style="color:var(--muted); font-size:13px; margin-top:6px">Rules applied:
                                        absent teachers removed → available teachers reassigned per-period → one teacher
                                        per period → most needy class gets priority</div>
                                </div>
                                <div>
                                    <span class="badge" id="absentBadge">Absent: 0</span>
                                </div>
                            </div>

                            <div style="margin-top:12px" id="resultTablesContainer"></div>

                            <div style="margin-top:14px; display:flex; gap:10px">
                                <button class="btn ghost" id="backBtn">← Back & Edit</button>
                                <button class="btn" id="downloadBtn">Download CSV</button>
                            </div>
                        </div>
                    </div>

                    <!-- Suggestions Tab -->
                    <div id="suggestions" class="tab-content">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-bold mb-4">Free Time Suggestions</h2>
                            <p class="text-gray-400 mb-6">Based on your interests in <span class="font-semibold">Web
                                    Development, Machine Learning, and Data Structures</span></p>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="border border-gray-700 rounded-lg p-4 hover:shadow-md transition">
                                    <div class="flex items-start mb-3">
                                        <div class="bg-blue-900 p-2 rounded-lg mr-4">
                                            <i class="fas fa-code text-blue-400 text-xl"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-semibold">Practice JavaScript Algorithms</h3>
                                            <p class="text-sm text-gray-400">15-20 minutes</p>
                                        </div>
                                    </div>
                                    <p class="text-gray-300 mb-4">Solve 2-3 algorithm challenges to improve your
                                        problem-solving skills.</p>
                                    <div class="flex justify-between items-center">
                                        <span class="bg-gray-700 text-gray-300 text-xs px-2 py-1 rounded">Coding</span>
                                        <button
                                            class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1 rounded"
                                            onclick="startSuggestion('algorithms')">Start Now</button>
                                    </div>
                                </div>

                                <div class="border border-gray-700 rounded-lg p-4 hover:shadow-md transition">
                                    <div class="flex items-start mb-3">
                                        <div class="bg-purple-900 p-2 rounded-lg mr-4">
                                            <i class="fas fa-brain text-purple-400 text-xl"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-semibold">Read ML Research Paper</h3>
                                            <p class="text-sm text-gray-400">25-30 minutes</p>
                                        </div>
                                    </div>
                                    <p class="text-gray-300 mb-4">Read a summary of recent advances in transformer
                                        models.</p>
                                    <div class="flex justify-between items-center">
                                        <span class="bg-gray-700 text-gray-300 text-xs px-2 py-1 rounded">Machine
                                            Learning</span>
                                        <button
                                            class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1 rounded"
                                            onclick="startSuggestion('ml')">Start Now</button>
                                    </div>
                                </div>

                                <div class="border border-gray-700 rounded-lg p-4 hover:shadow-md transition">
                                    <div class="flex items-start mb-3">
                                        <div class="bg-green-900 p-2 rounded-lg mr-4">
                                            <i class="fas fa-book text-green-400 text-xl"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-semibold">Review Data Structures</h3>
                                            <p class="text-sm text-gray-400">20-25 minutes</p>
                                        </div>
                                    </div>
                                    <p class="text-gray-300 mb-4">Revise tree traversal algorithms and practice
                                        implementation.</p>
                                    <div class="flex justify-between items-center">
                                        <span class="bg-gray-700 text-gray-300 text-xs px-2 py-1 rounded">Study</span>
                                        <button
                                            class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1 rounded"
                                            onclick="startSuggestion('ds')">Start Now</button>
                                    </div>
                                </div>

                                <div class="border border-gray-700 rounded-lg p-4 hover:shadow-md transition">
                                    <div class="flex items-start mb-3">
                                        <div class="bg-yellow-900 p-2 rounded-lg mr-4">
                                            <i class="fas fa-tasks text-yellow-400 text-xl"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-semibold">Plan Your Project</h3>
                                            <p class="text-sm text-gray-400">10-15 minutes</p>
                                        </div>
                                    </div>
                                    <p class="text-gray-300 mb-4">Outline the next steps for your web development
                                        project.</p>
                                    <div class="flex justify-between items-center">
                                        <span
                                            class="bg-gray-700 text-gray-300 text-xs px-2 py-1 rounded">Planning</span>
                                        <button
                                            class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1 rounded"
                                            onclick="startSuggestion('project')">Start Now</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Tab -->
                    <div id="profile" class="tab-content">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-bold mb-6">Student Profile</h2>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                <div class="md:col-span-1 flex flex-col items-center">
                                    <img id="profile-photo-img" class="h-32 w-32 rounded-full mb-4 border-4 border-blue-500 object-cover"
                                        src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236366F1'%3E%3Cpath d='M12 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10zm0 2c-6.627 0-12 5.373-12 12h24c0-6.627-5.373-12-12-12z'/%3E%3C/svg%3E"
                                        alt="Profile">
                                    <input type="file" id="profile-photo-input" accept="image/*" class="hidden" onchange="handleProfilePhotoChange(event)">
                                    <button onclick="(function(){const el=document.getElementById('profile-photo-input');if(el)el.click()})()"
                                        class="text-blue-400 hover:text-blue-300 text-sm mt-2 transition">
                                        Change Photo
                                    </button>
                                </div>

                                <div class="md:col-span-2">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-400 mb-1">Full
                                                Name</label>
                                            <input type="text" id="profile-name" value="enter your name "
                                                class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-white">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-400 mb-1">College
                                                ID</label>
                                            <input type="text" id="profile-id" value="enter college id "
                                                class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-white">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-400 mb-1">Email</label>
                                            <input type="email" id="profile-email" value="enter your mail "
                                                class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-white">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-400 mb-1">Course</label>
                                            <input type="text" id="profile-course" value="enter your course "
                                                class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-white">
                                        </div>
                                        <div>
                                            <label
                                                class="block text-sm font-medium text-gray-400 mb-1">Batch</label>
                                            <select id="profile-batch"
                                                class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-white focus:border-blue-500 outline-none"
                                                onchange="updateStudentBatch()">
                                                <option value="">Select your batch</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-6">
                                <h3 class="text-lg font-semibold mb-3">Interests</h3>
                                <div id="skills-container" class="flex flex-wrap gap-2 mb-3">
                                    <!-- Skills will be dynamically rendered here -->
                                </div>
                                <div class="flex gap-2 items-center">
                                    <input type="text" id="new-skill-input"
                                        placeholder="Enter a skill/interest"
                                        class="px-3 py-1 border border-gray-600 rounded-lg bg-gray-700 text-white text-sm focus:border-blue-500 outline-none">
                                    <button onclick="addSkill()"
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1 rounded-lg text-sm">
                                        Add Skill
                                    </button>
                                </div>
                            </div>

                            <div class="mb-6">
                                <h3 class="text-lg font-semibold mb-3">Career Goals</h3>
                                <textarea id="profile-goals"
                                    class="w-full px-4 py-2 border border-gray-600 rounded-lg h-24 bg-gray-700 text-white">I want to become a full-stack developer with expertise in React and Node.js, and eventually move into AI engineering.</textarea>
                            </div>

                            <div class="flex justify-end">
                                <button id="saveProfileBtn"
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg">Save
                                    Changes</button>
                            </div>
                        </div>
                    </div>

                    <!-- Results Tab -->
                    <div id="results" class="tab-content">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-bold mb-6">My Results</h2>
                            <p class="text-gray-400 mb-6">View your examination results subject-wise</p>
                           
                            <div id="student-results-container">
                                <!-- Results will be dynamically loaded here -->
                                <div id="student-results-empty" class="text-center py-12">
                                    <div class="w-20 h-20 rounded-full bg-gray-700/50 flex items-center justify-center mb-6 mx-auto">
                                        <i class="fas fa-poll text-3xl text-gray-500"></i>
                                    </div>
                                    <h3 class="text-xl font-bold text-gray-200 mb-2">No Results Available</h3>
                                    <p class="text-gray-400">Your results will appear here once your teacher enters them.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Study Material Tab -->
                    <div id="study-material" class="tab-content">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-bold mb-6">Study Materials</h2>
                            <p class="text-gray-400 mb-6">Access study materials uploaded by your teachers</p>
                           
                            <!-- Filter Section -->
                            <div class="bg-gray-900/50 p-4 rounded-xl border border-gray-700 mb-6">
                                <div class="flex flex-wrap gap-4 items-center">
                                    <select id="student-material-class-filter"
                                        class="px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-white focus:border-blue-500 outline-none"
                                        onchange="loadStudentStudyMaterials()">
                                        <option value="all">All Classes</option>
                                        <option value="Computer Science - A">Computer Science - A</option>
                                        <option value="Computer Science - B">Computer Science - B</option>
                                        <option value="Mechanical Eng - A">Mechanical Eng - A</option>
                                        <option value="Data Structures">Data Structures</option>
                                        <option value="Algorithms">Algorithms</option>
                                    </select>
                                    <input type="text" id="student-material-search" placeholder="Search materials..."
                                        class="flex-1 min-w-64 px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-white focus:border-blue-500 outline-none"
                                        oninput="loadStudentStudyMaterials()">
                                </div>
                            </div>

                            <!-- Materials List -->
                            <div id="student-materials-container" class="space-y-3">
                                <!-- Materials will be dynamically loaded here -->
                                <div id="student-materials-empty" class="text-center py-12">
                                    <div class="w-20 h-20 rounded-full bg-gray-700/50 flex items-center justify-center mb-6 mx-auto">
                                        <i class="fas fa-book-open text-3xl text-gray-500"></i>
                                    </div>
                                    <h3 class="text-xl font-bold text-gray-200 mb-2">No Study Materials Available</h3>
                                    <p class="text-gray-400">Study materials uploaded by your teachers will appear here.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Routine Tab -->
                    <div id="routine" class="tab-content">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-bold mb-6">Daily Routine</h2>

                            <div class="mb-6 flex justify-between items-center">
                                <div class="text-lg font-semibold">Monday, 12 June 2023</div>
                                <button id="exportRoutineBtn" class="bg-blue-900 text-blue-200 px-4 py-2 rounded-lg">
                                    <i class="fas fa-download mr-2"></i>Export Routine
                                </button>
                            </div>

                            <div class="space-y-4">
                                <div class="flex items-center p-4 bg-blue-900 rounded-lg">
                                    <div class="w-16 text-blue-200 font-bold">7:00</div>
                                    <div class="flex-1">
                                        <h3 class="font-semibold">Morning Routine</h3>
                                        <p class="text-sm text-gray-400">Exercise, Breakfast</p>
                                    </div>
                                    <div class="bg-green-800 text-green-200 text-xs px-2 py-1 rounded-full">Completed
                                    </div>
                                </div>

                                <div class="flex items-center p-4 bg-blue-900 rounded-lg">
                                    <div class="w-16 text-blue-200 font-bold">9:00</div>
                                    <div class="flex-1">
                                        <h3 class="font-semibold">Data Structures Class</h3>
                                        <p class="text-sm text-gray-400">Room 302</p>
                                    </div>
                                    <div class="bg-green-800 text-green-200 text-xs px-2 py-1 rounded-full">Completed
                                    </div>
                                </div>

                                <div class="flex items-center p-4 bg-blue-900 rounded-lg">
                                    <div class="w-16 text-blue-200 font-bold">10:00</div>
                                    <div class="flex-1">
                                        <h3 class="font-semibold">Algorithms Class</h3>
                                        <p class="text-sm text-gray-400">Room 305</p>
                                    </div>
                                    <div class="bg-yellow-800 text-yellow-200 text-xs px-2 py-1 rounded-full">In
                                        Progress</div>
                                </div>

                                <div class="flex items-center p-4 bg-green-900 rounded-lg">
                                    <div class="w-16 text-green-200 font-bold">11:00</div>
                                    <div class="flex-1">
                                        <h3 class="font-semibold">Free Period - Suggested Activity</h3>
                                        <p class="text-sm text-gray-400">Practice JavaScript Algorithms (15 min)</p>
                                    </div>
                                    <div class="bg-blue-800 text-blue-200 text-xs px-2 py-1 rounded-full">Upcoming</div>
                                </div>

                                <div class="flex items-center p-4 bg-gray-700 rounded-lg">
                                    <div class="w-16 text-gray-300 font-bold">12:00</div>
                                    <div class="flex-1">
                                        <h3 class="font-semibold">Lunch Break</h3>
                                        <p class="text-sm text-gray-400">Cafeteria</p>
                                    </div>
                                </div>

                                <div class="flex items-center p-4 bg-blue-900 rounded-lg">
                                    <div class="w-16 text-blue-200 font-bold">14:00</div>
                                    <div class="flex-1">
                                        <h3 class="font-semibold">Database Systems Class</h3>
                                        <p class="text-sm text-gray-400">Room 401</p>
                                    </div>
                                    <div class="bg-gray-600 text-gray-300 text-xs px-2 py-1 rounded-full">Not Started
                                    </div>
                                </div>

                                <div class="flex items-center p-4 bg-green-900 rounded-lg">
                                    <div class="w-16 text-green-200 font-bold">16:00</div>
                                    <div class="flex-1">
                                        <h3 class="font-semibold">Free Time - Suggested Activity</h3>
                                        <p class="text-sm text-gray-400">Read ML Research Paper (25 min)</p>
                                    </div>
                                    <div class="bg-gray-600 text-gray-300 text-xs px-2 py-1 rounded-full">Not Started
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ADMIN DASHBOARD (Hidden initially) -->
    <div id="admin-dashboard" class="hidden container mx-auto px-4 py-6">
        <div class="flex flex-col md:flex-row gap-6">
            <!-- Sidebar (Admin) -->
            <div class="hidden md:block w-full md:w-1/4 lg:w-1/5">
                <div class="bg-gray-800 rounded-lg shadow-md p-4 mb-6">
                    <div class="flex flex-col items-center text-center mb-6">
                        <div
                            class="w-24 h-24 rounded-full bg-purple-500/10 flex items-center justify-center mb-4 border-4 border-purple-500">
                            <i class="fas fa-user-shield text-4xl text-purple-400"></i>
                        </div>
                        <h2 class="text-xl font-bold">Admin</h2>
                        <p class="text-gray-400">System Administrator</p>
                    </div>

                    <nav class="space-y-2">
                        <button
                            class="tab-btn-admin w-full text-left px-4 py-3 rounded-lg font-medium text-purple-400 bg-purple-900/50 border border-purple-500/20"
                            data-tab="admin-data">
                            <i class="fas fa-database mr-3"></i>Data Management
                        </button>
                        <button
                            class="tab-btn-admin w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700/50 hover:text-gray-200 transition-colors"
                            data-tab="admin-attendance">
                            <i class="fas fa-fingerprint mr-3"></i>Attendance
                        </button>
                        <button
                            class="tab-btn-admin w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700/50 hover:text-gray-200 transition-colors"
                            data-tab="admin-batch">
                            <i class="fas fa-users mr-3"></i>Batch Management
                        </button>
                        <button
                            class="tab-btn-admin w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700/50 hover:text-gray-200 transition-colors"
                            data-tab="admin-timetable">
                            <i class="fas fa-calendar-alt mr-3"></i>Schedule
                        </button>
                        <button
                            class="tab-btn-admin w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700/50 hover:text-gray-200 transition-colors"
                            data-tab="admin-results">
                            <i class="fas fa-poll mr-3"></i>Results
                        </button>
                        <button
                            class="tab-btn-admin w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700/50 hover:text-gray-200 transition-colors"
                            onclick="logoutAdmin()">
                            <i class="fas fa-sign-out-alt mr-3"></i>Logout
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Main Content (Admin) -->
            <div class="w-full md:w-3/4 lg:w-4/5">

                <!-- Data Management Tab -->
                <div id="admin-data" class="tab-content-admin active">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-md mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold">Data Management</h2>
                            <button onclick="exportDataManagementToPDF()"
                                class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition flex items-center">
                                <i class="fas fa-file-pdf mr-2"></i>Export as PDF
                            </button>
                        </div>

                        <!-- Actions Row -->
                        <div class="flex space-x-4 mb-6 border-b border-gray-700 pb-2">
                            <button onclick="showAdminSection('add')"
                                class="sub-tab-btn text-blue-400 font-semibold border-b-2 border-blue-400 pb-1"
                                data-sub="add">Add Data</button>
                            <button onclick="showAdminSection('remove')"
                                class="sub-tab-btn text-gray-400 hover:text-white font-semibold pb-1"
                                data-sub="remove">Edit Data</button>
                            <button onclick="showAdminSection('modify')"
                                class="sub-tab-btn text-gray-400 hover:text-white font-semibold pb-1"
                                data-sub="modify">Remove Data</button>
                        </div>

                        <!-- Add Section -->
                        <div id="admin-sub-add" class="admin-sub-content">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <!-- Manual Add -->
                                <div>
                                    <h3 class="text-lg font-semibold mb-3 text-purple-300">Manual Entry</h3>
                                    <div class="space-y-4">
                                        <input type="text" id="admin-add-name" placeholder="Full Name"
                                            class="w-full p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white focus:border-purple-500 outline-none">
                                        <input type="text" id="admin-add-id" placeholder="ID (e.g. CS202501)"
                                            class="w-full p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white focus:border-purple-500 outline-none">
                                        <input type="email" id="admin-add-email" placeholder="Email (optional, for student registration)"
                                            class="w-full p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white focus:border-purple-500 outline-none">
                                        <select id="admin-add-role"
                                            class="w-full p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white focus:border-purple-500 outline-none">
                                            <option value="student">Student</option>
                                            <option value="teacher">Teacher</option>
                                        </select>
                                        <button onclick="adminAddUserManual()"
                                            class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl shadow-lg shadow-purple-500/20 transition">
                                            Add User
                                        </button>
                                    </div>
                                </div>

                                <!-- Bulk Import -->
                                <div class="border-l border-gray-700 pl-8">
                                    <h3 class="text-lg font-semibold mb-3 text-green-300">Bulk Import</h3>
                                    <div class="border-2 border-dashed border-gray-600 rounded-xl p-8 text-center hover:bg-gray-700/30 transition cursor-pointer flex flex-col items-center justify-center h-64 group"
                                        onclick="(function(){const el=document.getElementById('admin-file-upload');if(el)el.click()})()">
                                        <div
                                            class="w-16 h-16 rounded-full bg-gray-700 flex items-center justify-center mb-4 group-hover:scale-110 transition">
                                            <i
                                                class="fas fa-file-import text-3xl text-gray-400 group-hover:text-white"></i>
                                        </div>
                                        <p class="text-gray-300 font-medium">Click to upload Excel/PDF</p>
                                        <p class="text-gray-500 text-sm mt-2">Supports .xlsx, .pdf</p>
                                        <input type="file" id="admin-file-upload" class="hidden"
                                            accept=".xlsx,.xls,.pdf,.csv" onchange="handleAdminFileUpload(this)">
                                    </div>
                                    <div id="admin-upload-status" class="mt-4 text-sm text-gray-400 text-center"></div>
                                </div>
                            </div>

                            <!-- PDF Import Section -->
                            <div class="mt-8 pt-8 border-t border-gray-700">
                                <h3 class="text-lg font-semibold mb-4 text-yellow-300">PDF Import</h3>
                                <div class="bg-gray-700/30 rounded-xl p-6 border border-gray-600 hover:border-yellow-500/50 transition">
                                    <div class="flex items-center mb-4">
                                        <div class="w-12 h-12 rounded-full bg-yellow-500/20 flex items-center justify-center mr-4">
                                            <i class="fas fa-file-pdf text-2xl text-yellow-400"></i>
                                        </div>
                                        <div>
                                            <h4 class="text-white font-semibold">Import from PDF</h4>
                                            <p class="text-gray-400 text-sm">Extract data from PDF files</p>
                                        </div>
                                    </div>
                                    <input type="file" id="admin-pdf-upload" class="hidden" accept=".pdf" onchange="handlePDFImport(this)">
                                    <button onclick="(function(){const el=document.getElementById('admin-pdf-upload');if(el)el.click()})()"
                                        class="w-full py-2 bg-yellow-600 hover:bg-yellow-700 text-white font-semibold rounded-lg transition">
                                        <i class="fas fa-upload mr-2"></i>Select PDF File
                                    </button>
                                    <div id="admin-pdf-status" class="mt-3 text-sm text-gray-400 text-center"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Edit Data Section -->
                        <div id="admin-sub-remove" class="admin-sub-content hidden">
                            <div class="flex flex-wrap gap-4 mb-6">
                                <select id="admin-edit-filter-role"
                                    class="p-3 bg-gray-700 rounded-xl text-white border border-gray-600"
                                    onchange="renderAdminEditTable()">
                                    <option value="all">All Roles</option>
                                    <option value="student">Student</option>
                                    <option value="teacher">Teacher</option>
                                </select>
                                <input type="text" id="admin-edit-search" placeholder="Search by name, ID, or email..."
                                    class="flex-1 p-3 bg-gray-700 rounded-xl text-white border border-gray-600 min-w-64"
                                    oninput="renderAdminEditTable()">
                            </div>

                            <div class="overflow-hidden rounded-xl border border-gray-700">
                                <table class="w-full text-left text-gray-300">
                                    <thead class="bg-gray-900 text-gray-400 uppercase text-xs font-bold">
                                        <tr>
                                            <th class="p-4">Name</th>
                                            <th class="p-4">ID</th>
                                            <th class="p-4">Email</th>
                                            <th class="p-4">Role</th>
                                            <th class="p-4">Course</th>
                                            <th class="p-4 text-right">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="admin-edit-table-body" class="divide-y divide-gray-800 bg-gray-800/50">
                                        <!-- Rows will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Remove Data Section -->
                        <div id="admin-sub-modify" class="admin-sub-content hidden">
                            <div class="flex flex-wrap gap-4 mb-6">
                                <select id="admin-filter-role"
                                    class="p-3 bg-gray-700 rounded-xl text-white border border-gray-600"
                                    onchange="renderAdminUserTable()">
                                    <option value="all">All Roles</option>
                                    <option value="student">Student</option>
                                    <option value="teacher">Teacher</option>
                                </select>
                                <input type="text" id="admin-filter-search" placeholder="Search by name, ID, or email..."
                                    class="flex-1 p-3 bg-gray-700 rounded-xl text-white border border-gray-600 min-w-64"
                                    oninput="renderAdminUserTable()">
                            </div>

                            <div class="overflow-hidden rounded-xl border border-gray-700">
                                <table class="w-full text-left text-gray-300">
                                    <thead class="bg-gray-900 text-gray-400 uppercase text-xs font-bold">
                                        <tr>
                                            <th class="p-4">Name</th>
                                            <th class="p-4">ID</th>
                                            <th class="p-4">Email</th>
                                            <th class="p-4">Role</th>
                                            <th class="p-4">Course</th>
                                            <th class="p-4 text-right">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="admin-user-table-body" class="divide-y divide-gray-800 bg-gray-800/50">
                                        <!-- Rows -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Edit User Modal -->
                <div id="admin-edit-modal" class="fixed inset-0 bg-black/70 z-50 hidden items-center justify-center" onclick="if(event.target===this) closeEditModal()">
                    <div class="bg-gray-800 rounded-2xl shadow-2xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold text-white">Edit User</h3>
                            <button onclick="closeEditModal()" class="text-gray-400 hover:text-white">
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>
                        <form id="admin-edit-form" onsubmit="saveUserEdit(event)" class="space-y-4">
                            <input type="hidden" id="edit-user-key">
                            <div>
                                <label class="block text-gray-300 mb-2">Full Name</label>
                                <input type="text" id="edit-user-name" required
                                    class="w-full p-3 bg-gray-700/50 border border-gray-600 rounded-xl text-white focus:border-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-gray-300 mb-2">ID</label>
                                <input type="text" id="edit-user-id" required
                                    class="w-full p-3 bg-gray-700/50 border border-gray-600 rounded-xl text-white focus:border-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-gray-300 mb-2">Email</label>
                                <input type="email" id="edit-user-email"
                                    class="w-full p-3 bg-gray-700/50 border border-gray-600 rounded-xl text-white focus:border-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-gray-300 mb-2">Role</label>
                                <select id="edit-user-role"
                                    class="w-full p-3 bg-gray-700/50 border border-gray-600 rounded-xl text-white focus:border-blue-500 outline-none">
                                    <option value="student">Student</option>
                                    <option value="teacher">Teacher</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-300 mb-2">Course</label>
                                <input type="text" id="edit-user-course"
                                    class="w-full p-3 bg-gray-700/50 border border-gray-600 rounded-xl text-white focus:border-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-gray-300 mb-2">Class</label>
                                <input type="text" id="edit-user-class"
                                    class="w-full p-3 bg-gray-700/50 border border-gray-600 rounded-xl text-white focus:border-blue-500 outline-none">
                            </div>
                            <div class="flex gap-4 pt-4">
                                <button type="submit"
                                    class="flex-1 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl transition">
                                    Save Changes
                                </button>
                                <button type="button" onclick="closeEditModal()"
                                    class="flex-1 py-3 bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-xl transition">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Attendance Management Tab -->
                <div id="admin-attendance" class="tab-content-admin hidden">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-gray-800 p-6 rounded-2xl shadow-lg border-l-4 border-blue-500">
                            <h4 class="text-gray-400 text-sm font-bold uppercase mb-2">Total Check-ins</h4>
                            <div class="text-4xl font-bold text-white" id="admin-total-checkins">0</div>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-2xl shadow-lg border-l-4 border-green-500">
                            <h4 class="text-gray-400 text-sm font-bold uppercase mb-2">Active Classes</h4>
                            <div class="text-4xl font-bold text-white">3</div>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-2xl shadow-lg border-l-4 border-purple-500">
                            <h4 class="text-gray-400 text-sm font-bold uppercase mb-2">Faculty Present</h4>
                            <div class="text-4xl font-bold text-white">12</div>
                        </div>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
                        <h3 class="text-xl font-bold mb-6 flex items-center">
                            <i class="fas fa-list-alt mr-3 text-blue-400"></i> Today's Attendance Log
                        </h3>
                        <div class="text-sm text-gray-400 mb-4 bg-gray-900/50 p-3 rounded-lg">
                            <i class="fas fa-info-circle mr-2"></i> Data aggregated from Student/Teacher portals.
                        </div>
                        <div class="overflow-hidden rounded-xl border border-gray-700">
                            <table class="w-full text-left text-gray-300">
                                <thead class="bg-gray-900 text-gray-400 uppercase text-xs font-bold">
                                    <tr>
                                        <th class="p-4">Time</th>
                                        <th class="p-4">Class</th>
                                        <th class="p-4">Present Count</th>
                                        <th class="p-4 text-right">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-attendance-log-body" class="divide-y divide-gray-800 bg-gray-800/50">
                                    <!-- Dynamic content -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Batch Management Tab -->
                <div id="admin-batch" class="tab-content-admin hidden">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-md mb-6">
                        <h2 class="text-2xl font-bold mb-4">Batch Management</h2>
                       
                        <!-- Batch Actions -->
                        <div class="flex space-x-4 mb-6 border-b border-gray-700 pb-2">
                            <button onclick="showBatchSection('create')"
                                class="sub-tab-btn text-blue-400 font-semibold border-b-2 border-blue-400 pb-1"
                                data-sub="create">Create Batch</button>
                            <button onclick="showBatchSection('add-student')"
                                class="sub-tab-btn text-gray-400 hover:text-white font-semibold pb-1"
                                data-sub="add-student">Add Student</button>
                            <button onclick="showBatchSection('add-teacher')"
                                class="sub-tab-btn text-gray-400 hover:text-white font-semibold pb-1"
                                data-sub="add-teacher">Add Teacher</button>
                            <button onclick="showBatchSection('view')"
                                class="sub-tab-btn text-gray-400 hover:text-white font-semibold pb-1"
                                data-sub="view">View Batches</button>
                        </div>

                        <!-- Create Batch Section -->
                        <div id="batch-sub-create" class="batch-sub-content">
                            <div class="max-w-md">
                                <h3 class="text-lg font-semibold mb-3 text-purple-300">Create New Batch</h3>
                                <div class="space-y-4">
                                    <input type="text" id="batch-name" placeholder="Batch Name (e.g., CS2024-A)"
                                        class="w-full p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white focus:border-purple-500 outline-none">
                                    <input type="text" id="batch-description" placeholder="Description (optional)"
                                        class="w-full p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white focus:border-purple-500 outline-none">
                                    <button onclick="createBatch()"
                                        class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl shadow-lg shadow-purple-500/20 transition">
                                        Create Batch
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Add Student Section -->
                        <div id="batch-sub-add-student" class="batch-sub-content hidden">
                            <div class="max-w-md">
                                <h3 class="text-lg font-semibold mb-3 text-green-300">Add Student to Batch</h3>
                                <div class="space-y-4">
                                    <select id="batch-select-student"
                                        class="w-full p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white focus:border-green-500 outline-none">
                                        <option value="">Select Batch</option>
                                    </select>
                                    <input type="text" id="student-full-name" placeholder="Full Name"
                                        class="w-full p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white focus:border-green-500 outline-none">
                                    <input type="email" id="student-email" placeholder="Student Email"
                                        class="w-full p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white focus:border-green-500 outline-none">
                                    <div id="student-email-status" class="text-sm text-gray-400"></div>
                                    <button onclick="addStudentToBatch()"
                                        class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl shadow-lg shadow-green-500/20 transition">
                                        Add Student
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Add Teacher Section -->
                        <div id="batch-sub-add-teacher" class="batch-sub-content hidden">
                            <div class="max-w-md">
                                <h3 class="text-lg font-semibold mb-3 text-yellow-300">Add Teacher to Batch</h3>
                                <div class="space-y-4">
                                    <select id="batch-select-teacher"
                                        class="w-full p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white focus:border-yellow-500 outline-none">
                                        <option value="">Select Batch</option>
                                    </select>
                                    <input type="email" id="teacher-email" placeholder="Teacher Email"
                                        class="w-full p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white focus:border-yellow-500 outline-none">
                                    <button onclick="addTeacherToBatch()"
                                        class="w-full py-3 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-xl shadow-lg shadow-yellow-500/20 transition">
                                        Add Teacher
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- View Batches Section -->
                        <div id="batch-sub-view" class="batch-sub-content hidden">
                            <div id="batches-list" class="space-y-4">
                                <!-- Dynamic batches will be rendered here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Schedule/Timetable Management Tab -->
                <div id="admin-timetable" class="tab-content-admin hidden">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-md mb-6">
                        <h2 class="text-2xl font-bold mb-4">Schedule Management</h2>
                       
                        <!-- Batch Selection -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Select Batch</label>
                            <select id="schedule-batch-select"
                                class="w-full md:w-1/3 p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white focus:border-blue-500 outline-none"
                                onchange="loadBatchSchedule()">
                                <option value="">Select Batch</option>
                            </select>
                        </div>

                        <!-- Timetable Grid -->
                        <div id="schedule-container" class="hidden">
                            <div class="mb-4 flex justify-between items-center">
                                <h3 class="text-lg font-semibold">Week-wise Timetable</h3>
                                <div class="flex gap-2">
                                    <button onclick="addNewTimeSlot()"
                                        class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-xl font-semibold shadow-lg shadow-green-500/20 transition flex items-center gap-2">
                                        <i class="fas fa-plus"></i>
                                        <span>Add Time Slot</span>
                                    </button>
                                    <button onclick="saveBatchSchedule()"
                                        class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-semibold shadow-lg shadow-blue-500/20 transition">
                                        Save Schedule
                                    </button>
                                </div>
                            </div>
                           
                            <div class="overflow-x-auto">
                                <table id="schedule-grid" class="w-full border-collapse bg-gray-900/50 rounded-lg">
                                    <thead>
                                        <tr class="bg-gray-800">
                                            <th class="p-3 border border-gray-700 text-gray-300 font-semibold">Time</th>
                                            <th class="p-3 border border-gray-700 text-gray-300 font-semibold">Monday</th>
                                            <th class="p-3 border border-gray-700 text-gray-300 font-semibold">Tuesday</th>
                                            <th class="p-3 border border-gray-700 text-gray-300 font-semibold">Wednesday</th>
                                            <th class="p-3 border border-gray-700 text-gray-300 font-semibold">Thursday</th>
                                            <th class="p-3 border border-gray-700 text-gray-300 font-semibold">Friday</th>
                                            <th class="p-3 border border-gray-700 text-gray-300 font-semibold">Saturday</th>
                                            <th class="p-3 border border-gray-700 text-gray-300 font-semibold text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="schedule-tbody">
                                        <!-- Dynamic schedule rows -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div id="schedule-empty" class="text-center py-20">
                            <div class="w-24 h-24 rounded-full bg-gray-700/50 flex items-center justify-center mx-auto mb-6">
                                <i class="fas fa-calendar-alt text-4xl text-gray-500"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-white mb-2">No Batch Selected</h2>
                            <p class="text-gray-400">Select a batch to create or edit its schedule</p>
                        </div>
                    </div>
                </div>

                <!-- Result Management Tab -->
                <div id="admin-results" class="tab-content-admin hidden">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-white">Results View</h2>
                                <p class="text-gray-400 mt-2">View all student results by batch. Results are read-only and can only be edited by teachers.</p>
                            </div>
                            <button onclick="exportResultsToPDF()"
                                class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition flex items-center">
                                <i class="fas fa-file-pdf mr-2"></i>Export as PDF
                            </button>
                        </div>
                       
                        <!-- Batch Selection -->
                        <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-700 mb-6">
                            <label class="block text-sm font-medium text-gray-400 mb-2">Select Batch to View Results</label>
                            <select id="admin-result-batch"
                                class="w-full md:w-1/3 px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-white focus:border-purple-500 outline-none"
                                onchange="loadAdminResults()">
                                <option value="">Select a batch</option>
                            </select>
                        </div>

                        <!-- Results Display -->
                        <div id="admin-results-container">
                            <!-- Results will be dynamically loaded here -->
                            <div id="admin-results-empty" class="text-center py-12">
                                <div class="w-20 h-20 rounded-full bg-gray-700/50 flex items-center justify-center mb-6 mx-auto">
                                    <i class="fas fa-poll text-3xl text-gray-500"></i>
                                </div>
                                <h3 class="text-xl font-bold text-gray-200 mb-2">No Batch Selected</h3>
                                <p class="text-gray-400">Select a batch to view student results.</p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- TEACHER DASHBOARD (Hidden initially) -->
    <div id="teacher-dashboard" class="hidden container mx-auto px-4 py-6">
        <div class="flex flex-col md:flex-row gap-6">
            <!-- Sidebar (Teacher) -->
            <div class="hidden md:block w-full md:w-1/4 lg:w-1/5">
                <div class="bg-gray-800 rounded-lg shadow-md p-4 mb-6">
                    <div class="flex flex-col items-center text-center mb-6">
                        <div
                            class="w-24 h-24 rounded-full bg-green-500/10 flex items-center justify-center mb-4 border-4 border-green-500">
                            <i class="fas fa-chalkboard-teacher text-4xl text-green-400"></i>
                        </div>
                        <h2 class="text-xl font-bold" id="teacher-sidebar-name">Teacher</h2>
                        <p class="text-gray-400">Faculty Member</p>
                    </div>

                    <nav class="space-y-2">
                        <button
                            class="tab-btn-teacher w-full text-left px-4 py-3 rounded-lg font-medium text-green-400 bg-green-900/50 border border-green-500/20"
                            data-tab="teacher-attendance">
                            <i class="fas fa-fingerprint mr-3"></i>Attendance
                        </button>
                        <button
                            class="tab-btn-teacher w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700/50 hover:text-gray-200 transition-colors"
                            data-tab="teacher-timetable">
                            <i class="fas fa-calendar-alt mr-3"></i>Timetable
                        </button>
                        <button
                            class="tab-btn-teacher w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700/50 hover:text-gray-200 transition-colors"
                            data-tab="teacher-study">
                            <i class="fas fa-book-open mr-3"></i>Study Material
                        </button>
                        <button
                            class="tab-btn-teacher w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700/50 hover:text-gray-200 transition-colors"
                            data-tab="teacher-results">
                            <i class="fas fa-poll mr-3"></i>Result Management
                        </button>
                        <button
                            class="tab-btn-teacher w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700/50 hover:text-gray-200 transition-colors"
                            onclick="logoutTeacher()">
                            <i class="fas fa-sign-out-alt mr-3"></i>Logout
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Main Content (Teacher) -->
            <div class="w-full md:w-3/4 lg:w-4/5">
                <!-- Attendance Management Section -->
                <div id="teacher-attendance" class="tab-content-teacher">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-md mb-6">
                        <h2 class="text-2xl font-bold mb-4">Attendance Management</h2>
                        <!-- Attendance Sub-tabs -->
                        <div class="flex space-x-6 mb-6 border-b border-gray-700">
                            <button onclick="showTeacherSection('attendance','your')"
                                class="teacher-sub-tab-btn text-green-400 font-semibold border-b-2 border-green-400 pb-2"
                                data-sub="your">Your Attendance</button>
                            <button onclick="showTeacherSection('attendance','student')"
                                class="teacher-sub-tab-btn text-gray-400 hover:text-white font-semibold pb-2"
                                data-sub="student">Student Attendance</button>
                        </div>

                        <!-- Your Attendance Section -->
                        <div id="teacher-sub-attendance-your" class="teacher-sub-content">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                                <button
                                    class="p-6 bg-green-900/30 border border-green-500/20 rounded-2xl hover:bg-green-900/50 transition flex flex-col items-center">
                                    <i class="fas fa-check-double text-3xl text-green-400 mb-3"></i>
                                    <span class="font-bold">Mark Attendance</span>
                                </button>
                                <button
                                    class="p-6 bg-blue-900/30 border border-blue-500/20 rounded-2xl hover:bg-blue-900/50 transition flex flex-col items-center">
                                    <i class="fas fa-history text-3xl text-blue-400 mb-3"></i>
                                    <span class="font-bold">Attendance History</span>
                                </button>
                                <button
                                    class="p-6 bg-purple-900/30 border border-purple-500/20 rounded-2xl hover:bg-purple-900/50 transition flex flex-col items-center">
                                    <i class="fas fa-chart-pie text-3xl text-purple-400 mb-3"></i>
                                    <span class="font-bold">Analysis</span>
                                </button>
                            </div>
                            <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-700">
                                <h3 class="font-bold mb-4">Your Recent Logs</h3>
                                <p class="text-gray-500 text-center py-4 text-sm italic">No recent self-attendance logs
                                    found.</p>
                            </div>
                        </div>

                        <!-- Student Attendance Section -->
                        <div id="teacher-sub-attendance-student" class="teacher-sub-content hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                                <button
                                    class="p-6 bg-teal-900/30 border border-teal-500/20 rounded-2xl hover:bg-teal-900/50 transition flex flex-col items-center">
                                    <i class="fas fa-user-check text-3xl text-teal-400 mb-3"></i>
                                    <span class="font-bold">Mark Student Attendance</span>
                                </button>
                                <button id="teacher-btn-analysis" onclick="toggleTeacherAnalysis(true)"
                                    class="p-6 bg-amber-900/20 border border-amber-500/20 rounded-2xl hover:bg-amber-900/40 transition flex flex-col items-center">
                                    <i class="fas fa-analytics text-3xl text-amber-400 mb-3"></i>
                                    <span class="font-bold">Attendance Analysis</span>
                                </button>
                            </div>
                            <!-- Batch Dropdown & Portal Controls -->
                            <div
                                class="mb-6 flex flex-wrap items-center gap-6 p-4 bg-gray-900/30 rounded-xl border border-gray-700">
                                <div class="flex items-center gap-3">
                                    <label class="text-sm text-gray-400">Select Batch:</label>
                                    <select id="teacher-portal-batch-select"
                                        class="bg-gray-700 border-gray-600 rounded-lg text-sm p-2 outline-none text-white focus:border-green-500">
                                        <option value="">Select a batch</option>
                                    </select>
                                </div>

                                <div class="flex items-center gap-3 border-l border-gray-700 pl-6">
                                    <span class="text-sm text-gray-400">Portal Status:</span>
                                    <span id="attendance-portal-status-badge"
                                        class="px-3 py-1 bg-red-900/40 text-red-400 text-xs font-bold rounded-full border border-red-900/50">CLOSED</span>
                                </div>

                                <div class="flex gap-2 ml-auto">
                                    <button id="btn-open-portal" onclick="toggleAttendancePortal(true)"
                                        class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-xs font-bold rounded-lg shadow-lg shadow-green-500/20 transition">
                                        <i class="fas fa-play mr-2"></i>OPEN PORTAL
                                    </button>
                                    <button id="btn-close-portal" onclick="toggleAttendancePortal(false)"
                                        class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-xs font-bold rounded-lg shadow-lg shadow-red-500/20 transition hidden">
                                        <i class="fas fa-stop mr-2"></i>CLOSE PORTAL
                                    </button>
                                </div>
                            </div>
                            <!-- Portal Timer/Info (Optional) -->
                            <div id="portal-active-info"
                                class="hidden mb-6 p-4 bg-green-900/10 border border-green-500/20 rounded-xl animate-pulse">
                                <p class="text-green-400 text-sm flex items-center">
                                    <i class="fas fa-broadcast-tower mr-3"></i>
                                    Attendance portal is currently <span class="font-bold underline ml-1">LIVE</span>
                                    for
                                    <span id="active-portal-name" class="ml-1 font-bold">Class</span>. Students can now
                                    verify.
                                </p>
                            </div>
                            <div id="teacher-student-overview-section"
                                class="bg-gray-900/50 p-6 rounded-xl border border-gray-700">
                                <h3 class="font-bold mb-4">Student Overview</h3>
                                <div class="overflow-hidden rounded-lg">
                                    <table class="w-full text-xs text-left text-gray-400">
                                        <thead class="bg-gray-800 text-gray-500 flex-grow">
                                            <tr>
                                                <th class="p-3">Roll No</th>
                                                <th class="p-3">Student Name</th>
                                                <th class="p-3">Status</th>
                                                <th class="p-3 text-right">Last Seen</th>
                                            </tr>
                                        </thead>
                                        <tbody id="teacher-student-overview-tbody" class="divide-y divide-gray-800">
                                            <tr>
                                                <td colspan="4" class="p-4 text-center italic">Select a class and open
                                                    portal to view attendance data</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Attendance Analysis Section (Hidden by default) -->
                            <div id="teacher-attendance-analysis-section"
                                class="hidden bg-gray-900/50 p-6 rounded-xl border border-gray-700 animate-fade-in">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="font-bold">Attendance Analysis</h3>
                                    <div class="flex items-center gap-3 flex-wrap">
                                        <label class="text-sm text-gray-400">Select Batch:</label>
                                        <select id="teacher-analysis-batch-select"
                                            class="bg-gray-700 border-gray-600 rounded-lg text-sm p-2 outline-none text-white focus:border-amber-500"
                                            onchange="renderAttendanceAnalysis()">
                                            <option value="">All Batches</option>
                                        </select>
                                        <label class="text-sm text-gray-400">View Date:</label>
                                        <input type="date" id="teacher-analysis-date"
                                            class="bg-gray-700 border-gray-600 rounded-lg text-sm p-2 outline-none text-white focus:border-amber-500"
                                            onchange="renderAttendanceAnalysis()">
                                        <button onclick="toggleTeacherAnalysis(false)"
                                            class="text-xs text-gray-500 hover:text-white ml-4">
                                            <i class="fas fa-times mr-1"></i>Close
                                        </button>
                                    </div>
                                </div>

                                <div class="overflow-hidden rounded-lg">
                                    <table class="w-full text-xs text-left text-gray-400">
                                        <thead class="bg-gray-800 text-gray-500">
                                            <tr>
                                                <th class="p-3">Roll No</th>
                                                <th class="p-3">Student Name</th>
                                                <th class="p-3">Class/Subject</th>
                                                <th class="p-3 text-right">Time</th>
                                            </tr>
                                        </thead>
                                        <tbody id="teacher-analysis-tbody" class="divide-y divide-gray-800">
                                            <tr>
                                                <td colspan="4" class="p-4 text-center italic">Select a date to view
                                                    records</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Timetable Tab -->
                <div id="teacher-timetable" class="tab-content-teacher hidden">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold mb-6">Batch Timetables</h2>
                       
                        <!-- Batch Selection -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Select Batch</label>
                            <select id="teacher-batch-select"
                                class="w-full md:w-1/3 p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white focus:border-green-500 outline-none"
                                onchange="loadTeacherBatchSchedule()">
                                <option value="">Select Batch</option>
                            </select>
                        </div>

                        <!-- Timetable Grid -->
                        <div id="teacher-schedule-container" class="hidden">
                            <div class="mb-4 flex justify-between items-center">
                                <h3 class="text-lg font-semibold">Week-wise Timetable</h3>
                                <div class="flex gap-2">
                                    <button onclick="addNewTeacherTimeSlot()"
                                        class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-xl font-semibold shadow-lg shadow-green-500/20 transition flex items-center gap-2">
                                        <i class="fas fa-plus"></i>
                                        <span>Add Time Slot</span>
                                    </button>
                                    <button onclick="saveTeacherBatchSchedule()"
                                        class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-xl font-semibold shadow-lg shadow-green-500/20 transition">
                                        Save Schedule
                                    </button>
                                </div>
                            </div>
                           
                            <div class="overflow-x-auto">
                                <table id="teacher-schedule-grid" class="w-full border-collapse bg-gray-900/50 rounded-lg">
                                    <thead>
                                        <tr class="bg-gray-800">
                                            <th class="p-3 border border-gray-700 text-gray-300 font-semibold">Time</th>
                                            <th class="p-3 border border-gray-700 text-gray-300 font-semibold">Monday</th>
                                            <th class="p-3 border border-gray-700 text-gray-300 font-semibold">Tuesday</th>
                                            <th class="p-3 border border-gray-700 text-gray-300 font-semibold">Wednesday</th>
                                            <th class="p-3 border border-gray-700 text-gray-300 font-semibold">Thursday</th>
                                            <th class="p-3 border border-gray-700 text-gray-300 font-semibold">Friday</th>
                                            <th class="p-3 border border-gray-700 text-gray-300 font-semibold">Saturday</th>
                                            <th class="p-3 border border-gray-700 text-gray-300 font-semibold text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="teacher-schedule-tbody">
                                        <!-- Dynamic schedule rows -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div id="teacher-schedule-empty" class="text-center py-20">
                            <div class="w-24 h-24 rounded-full bg-gray-700/50 flex items-center justify-center mx-auto mb-6">
                                <i class="fas fa-calendar-alt text-4xl text-gray-500"></i>
                            </div>
                            <h2 class="text-2xl font-bold text-white mb-2">No Batch Selected</h2>
                            <p class="text-gray-400">Select a batch to view or edit its schedule</p>
                        </div>
                    </div>
                </div>

                <!-- Study Material Tab -->
                <div id="teacher-study" class="tab-content-teacher hidden">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold mb-6">Study Material Management</h2>
                        <div class="flex space-x-6 mb-6 border-b border-gray-700">
                            <button onclick="showTeacherSection('study','provide')"
                                class="teacher-sub-tab-btn text-green-400 font-semibold border-b-2 border-green-400 pb-2"
                                data-sub="provide">Provide Study Material</button>
                            <button onclick="showTeacherSection('study','history')"
                                class="teacher-sub-tab-btn text-gray-400 hover:text-white font-semibold pb-2"
                                data-sub="history">History of Study Material</button>
                        </div>

                        <div id="teacher-sub-study-provide" class="teacher-sub-content">
                            <div class="max-w-xl mx-auto">
                                <div
                                    class="border-2 border-dashed border-gray-700 rounded-3xl p-10 text-center hover:bg-gray-700/20 transition cursor-pointer group"
                                    onclick="(function(){const el=document.getElementById('teacher-file-upload');if(el)el.click()})()">
                                    <i
                                        class="fas fa-file-upload text-5xl text-gray-600 group-hover:text-green-400 mb-4 transition"></i>
                                    <h3 class="text-xl font-bold mb-2">Upload New Material</h3>
                                    <p class="text-gray-500 text-sm mb-6">Upload PDFs, PPTs, or Notes for your students</p>
                                    <button
                                        class="px-6 py-2 bg-green-600 rounded-xl font-bold hover:bg-green-700 transition">Select
                                        Files</button>
                                </div>
                                <input type="file" id="teacher-file-upload" class="hidden" accept=".pdf,.ppt,.pptx,.doc,.docx,.txt,.jpg,.jpeg,.png" multiple onchange="handleTeacherFileUpload(this)">
                                <div id="teacher-upload-status" class="mt-4 text-sm text-center"></div>
                               
                                <!-- File Selection Info -->
                                <div id="teacher-selected-files" class="mt-6 space-y-3 hidden">
                                    <h4 class="text-lg font-semibold text-white mb-3">Selected Files:</h4>
                                    <div id="teacher-files-list" class="space-y-2"></div>
                                    <div class="flex gap-3 mt-4">
                                        <input type="text" id="teacher-material-title" placeholder="Material Title (e.g., Chapter 1 - Algorithms)"
                                            class="flex-1 p-3 bg-gray-700/50 border border-gray-600 rounded-xl text-white focus:border-green-500 outline-none">
                                        <select id="teacher-material-class"
                                            class="p-3 bg-gray-700/50 border border-gray-600 rounded-xl text-white focus:border-green-500 outline-none">
                                            <option value="all">All Classes</option>
                                            <option value="Computer Science - A">Computer Science - A</option>
                                            <option value="Computer Science - B">Computer Science - B</option>
                                            <option value="Mechanical Eng - A">Mechanical Eng - A</option>
                                            <option value="Data Structures">Data Structures</option>
                                            <option value="Algorithms">Algorithms</option>
                                        </select>
                                    </div>
                                    <button onclick="uploadTeacherMaterials()"
                                        class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl transition">
                                        <i class="fas fa-upload mr-2"></i>Upload Materials
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div id="teacher-sub-study-history" class="teacher-sub-content hidden">
                            <div id="teacher-study-history-list" class="space-y-3">
                                <!-- History will be dynamically loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Result Management Section -->
                <div id="teacher-results" class="tab-content-teacher hidden">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold mb-6">Result Management</h2>
                       
                        <!-- Selection Section -->
                        <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-700 mb-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-2">Select Batch</label>
                                    <select id="teacher-result-batch"
                                        class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-white focus:border-green-500 outline-none"
                                        onchange="loadStudentsForResultEntry()">
                                        <option value="">Select a batch</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-2">Subject</label>
                                    <input type="text" id="teacher-result-subject"
                                        placeholder="Enter subject name"
                                        class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-white focus:border-green-500 outline-none"
                                        oninput="loadStudentsForResultEntry()">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-2">Exam Type</label>
                                    <select id="teacher-result-exam-type"
                                        class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-white focus:border-green-500 outline-none"
                                        onchange="loadStudentsForResultEntry()">
                                        <option value="">Select exam type</option>
                                        <option value="Midterm">Midterm</option>
                                        <option value="Final">Final</option>
                                        <option value="Quiz">Quiz</option>
                                        <option value="Assignment">Assignment</option>
                                        <option value="Project">Project</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Students List and Marks Entry -->
                        <div id="teacher-result-students-container" class="hidden">
                            <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-700">
                                <h3 class="text-lg font-semibold mb-4">Enter Marks for Students</h3>
                                <div class="overflow-x-auto">
                                    <table class="w-full text-left">
                                        <thead>
                                            <tr class="bg-gray-800">
                                                <th class="p-3 border border-gray-700 text-gray-300 font-semibold">Roll No</th>
                                                <th class="p-3 border border-gray-700 text-gray-300 font-semibold">Student Name</th>
                                                <th class="p-3 border border-gray-700 text-gray-300 font-semibold">Email</th>
                                                <th class="p-3 border border-gray-700 text-gray-300 font-semibold">Marks</th>
                                            </tr>
                                        </thead>
                                        <tbody id="teacher-result-students-tbody" class="divide-y divide-gray-800">
                                            <!-- Students will be dynamically loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="mt-4 flex justify-end">
                                    <button onclick="saveStudentResults()"
                                        class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition">
                                        <i class="fas fa-save mr-2"></i>Save Results
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Empty State -->
                        <div id="teacher-result-empty" class="text-center py-12">
                            <div class="w-20 h-20 rounded-full bg-gray-700/50 flex items-center justify-center mb-6 mx-auto">
                                <i class="fas fa-award text-3xl text-gray-500"></i>
                            </div>
                            <h3 class="text-xl font-bold text-gray-200 mb-2">Select a Batch to Begin</h3>
                            <p class="text-gray-400">Choose a batch, subject, and exam type to enter student marks.</p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <div id="message-box" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-900 p-8 rounded-2xl shadow-xl max-w-sm w-full text-center space-y-4 border border-gray-700">
            <p id="message-text" class="text-lg text-white"></p>
            <button onclick="hideMessage()"
                class="px-6 py-2 bg-blue-600 text-white rounded-full font-semibold hover:bg-blue-700 transition duration-200">OK</button>
        </div>
    </div>

    <script>
        window.onerror = function (msg, url, line, col, error) {
            alert("Error: " + msg + "\nLine: " + line);
            return false;
        };
        console.log("SPARK Script Initializing...");

        // ===== Face Recognition System =====
        const videoReg = document.getElementById('video-reg');
        const videoLogin = document.getElementById('video-login');
        const canvasReg = document.getElementById('canvas-reg');
        const canvasLogin = document.getElementById('canvas-login');
        const registerBtn = document.getElementById('register-btn');
        const loginBtn = document.getElementById('login-btn');
        const usernameInput = document.getElementById('username-input');
        const videoAttendance = document.getElementById('video-attendance');
        const canvasAttendance = document.getElementById('canvas-attendance');
        const markAttendanceBtn = document.getElementById('mark-attendance-btn');

        const homeScreen = document.getElementById('home-screen');
        const loading = document.getElementById('loading');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const authScreens = document.getElementById('auth-screens');
        const dashboardContent = document.getElementById('dashboard-content');
        const studentAuth = document.getElementById('student-auth');
        const navbar = document.getElementById('navbar');
        const mobileTabs = document.getElementById('mobile-tabs');
        const mainApp = document.getElementById('main-app');
        const teacherDashboard = document.getElementById('teacher-dashboard');
        const adminDashboard = document.getElementById('admin-dashboard');

        // HOISTED PORTAL FUNCTIONS
        window.enterTeacherPortal = function () {
            console.log("Teacher portal requested");
            try {
                localStorage.setItem('spark_teacher_active', 'true');
                const auth = document.getElementById('auth-screens');
                if (auth) auth.classList.add('hidden');

                if (navbar) navbar.classList.add('hidden');
                if (mobileTabs) mobileTabs.classList.add('hidden');
                if (mainApp) mainApp.classList.add('hidden');
                if (adminDashboard) adminDashboard.classList.add('hidden');

                if (teacherDashboard) {
                    teacherDashboard.classList.remove('hidden');
                    teacherDashboard.style.display = 'block';
                }

                if (typeof syncTeacherPortalUI === 'function') syncTeacherPortalUI();
                if (typeof updateTeacherStudentOverview === 'function') updateTeacherStudentOverview();
                if (typeof populateTeacherPortalBatchSelect === 'function') populateTeacherPortalBatchSelect();
            } catch (e) {
                alert("Teacher Portal Error: " + e.message);
            }
        };

        window.enterAdminPortal = function () {
            console.log("Admin portal requested");
            try {
                localStorage.setItem('spark_admin_active', 'true');
                const auth = document.getElementById('auth-screens');
                if (auth) auth.classList.add('hidden');

                if (navbar) navbar.classList.add('hidden');
                if (mobileTabs) mobileTabs.classList.add('hidden');
                if (mainApp) mainApp.classList.add('hidden');
                if (teacherDashboard) teacherDashboard.classList.add('hidden');

                if (adminDashboard) {
                    adminDashboard.classList.remove('hidden');
                    adminDashboard.style.display = 'block';
                }

                if (typeof renderAdminAttendance === 'function') renderAdminAttendance();
            } catch (e) {
                alert("Admin Portal Error: " + e.message);
            }
        };

        // Hoisted Helper Functions
        window.showTeacherSection = function (main, sub) {
            const parent = document.getElementById('teacher-' + main);
            if (parent) {
                parent.querySelectorAll('.teacher-sub-tab-btn').forEach(b => {
                    b.classList.remove('text-green-400', 'border-b-2', 'border-green-400');
                    b.classList.add('text-gray-400');
                    if (b.dataset.sub === sub) {
                        b.classList.add('text-green-400', 'border-b-2', 'border-green-400');
                        b.classList.remove('text-gray-400');
                    }
                });
                parent.querySelectorAll('.teacher-sub-content').forEach(c => c.classList.add('hidden'));
                const subContent = document.getElementById('teacher-sub-' + main + '-' + sub);
                if (subContent) subContent.classList.remove('hidden');
               
                // Load history when switching to history tab
                if (main === 'study' && sub === 'history') {
                    loadTeacherStudyHistory();
                }
            }
        };

        // Study Materials Storage Functions
        function getStudyMaterialsStorage() {
            return safeParseJSON('spark_study_materials', []);
        }

        function saveStudyMaterialsStorage(materials) {
            localStorage.setItem('spark_study_materials', JSON.stringify(materials));
        }

        // Handle Teacher File Upload
        window.handleTeacherFileUpload = function (input) {
            const files = input.files;
            if (!files || files.length === 0) {
                console.log("No files selected");
                return;
            }

            console.log("Files selected:", files.length);
            const filesList = document.getElementById('teacher-files-list');
            const selectedFilesDiv = document.getElementById('teacher-selected-files');
            const status = document.getElementById('teacher-upload-status');
           
            if (!filesList || !selectedFilesDiv) {
                console.error("Required elements not found");
                return;
            }

            // Clear previous files
            filesList.innerHTML = '';
           
            // Show the selected files section
            selectedFilesDiv.classList.remove('hidden');
           
            // Clear status
            if (status) {
                status.textContent = '';
                status.className = "mt-4 text-sm text-center";
            }

            // Store files in a temporary array
            window.selectedTeacherFiles = Array.from(files);

            // Display each selected file
            window.selectedTeacherFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'flex items-center justify-between p-3 bg-gray-700/50 rounded-lg border border-gray-600';
                fileItem.innerHTML = `
                    <div class="flex items-center gap-3">
                        <i class="fas fa-file text-gray-400"></i>
                        <div>
                            <div class="text-white font-medium text-sm">${file.name}</div>
                            <div class="text-gray-400 text-xs">${(file.size / 1024).toFixed(2)} KB</div>
                        </div>
                    </div>
                    <button onclick="removeSelectedFile(${index})" class="text-red-400 hover:text-red-300">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                filesList.appendChild(fileItem);
            });

            // Show success message
            if (status) {
                status.textContent = `${files.length} file(s) selected. Fill in the details below and click Upload.`;
                status.className = "mt-4 text-sm text-green-400 text-center";
            }
        };

        window.removeSelectedFile = function (index) {
            if (!window.selectedTeacherFiles || window.selectedTeacherFiles.length <= index) {
                return;
            }
           
            window.selectedTeacherFiles.splice(index, 1);
            const filesList = document.getElementById('teacher-files-list');
            const selectedFilesDiv = document.getElementById('teacher-selected-files');
            const input = document.getElementById('teacher-file-upload');
            const status = document.getElementById('teacher-upload-status');
           
            if (!filesList || !selectedFilesDiv) return;
           
            // Clear and re-render the file list
            filesList.innerHTML = '';
           
            if (window.selectedTeacherFiles.length === 0) {
                // Hide the section if no files remain
                selectedFilesDiv.classList.add('hidden');
                if (input) input.value = '';
                if (status) {
                    status.textContent = '';
                    status.className = "mt-4 text-sm text-center";
                }
            } else {
                // Re-render remaining files
                window.selectedTeacherFiles.forEach((file, idx) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'flex items-center justify-between p-3 bg-gray-700/50 rounded-lg border border-gray-600';
                    fileItem.innerHTML = `
                        <div class="flex items-center gap-3">
                            <i class="fas fa-file text-gray-400"></i>
                            <div>
                                <div class="text-white font-medium text-sm">${file.name}</div>
                                <div class="text-gray-400 text-xs">${(file.size / 1024).toFixed(2)} KB</div>
                            </div>
                        </div>
                        <button onclick="removeSelectedFile(${idx})" class="text-red-400 hover:text-red-300">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    filesList.appendChild(fileItem);
                });
               
                // Update status
                if (status) {
                    status.textContent = `${window.selectedTeacherFiles.length} file(s) selected. Fill in the details below and click Upload.`;
                    status.className = "mt-4 text-sm text-green-400 text-center";
                }
            }
        };

        // Upload Teacher Materials
        window.uploadTeacherMaterials = async function () {
            if (!window.selectedTeacherFiles || window.selectedTeacherFiles.length === 0) {
                showMessage("Please select files to upload.");
                return;
            }

            const title = document.getElementById('teacher-material-title')?.value.trim();
            const targetClass = document.getElementById('teacher-material-class')?.value;

            if (!title) {
                showMessage("Please enter a material title.");
                return;
            }

            const status = document.getElementById('teacher-upload-status');
            if (status) {
                status.textContent = "Uploading files...";
                status.className = "mt-4 text-sm text-blue-400 text-center";
            }

            try {
                const materials = getStudyMaterialsStorage();
                const uploadDate = new Date().toISOString();

                // Convert files to base64 and store
                for (const file of window.selectedTeacherFiles) {
                    const fileData = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });

                    const material = {
                        id: Date.now() + Math.random(),
                        title: title,
                        fileName: file.name,
                        fileType: file.type,
                        fileSize: file.size,
                        fileData: fileData,
                        targetClass: targetClass,
                        uploadDate: uploadDate,
                        uploadedBy: loggedInUser?.username || 'Teacher'
                    };

                    materials.push(material);
                }

                saveStudyMaterialsStorage(materials);

                if (status) {
                    status.textContent = `Successfully uploaded ${window.selectedTeacherFiles.length} file(s)!`;
                    status.className = "mt-4 text-sm text-green-400 text-center";
                }

                showMessage(`Successfully uploaded ${window.selectedTeacherFiles.length} file(s)!`);

                // Reset form
                document.getElementById('teacher-file-upload').value = '';
                document.getElementById('teacher-material-title').value = '';
                document.getElementById('teacher-material-class').value = 'all';
                document.getElementById('teacher-selected-files').classList.add('hidden');
                window.selectedTeacherFiles = [];

                // Refresh history
                loadTeacherStudyHistory();
            } catch (error) {
                console.error('Upload error:', error);
                if (status) {
                    status.textContent = "Error uploading files: " + error.message;
                    status.className = "mt-4 text-sm text-red-400 text-center";
                }
                showMessage("Error uploading files. Please try again.");
            }
        };

        // Load Teacher Study History
        function loadTeacherStudyHistory() {
            const container = document.getElementById('teacher-study-history-list');
            if (!container) return;

            const materials = getStudyMaterialsStorage();
            const teacherMaterials = Array.isArray(materials) ? materials.filter(m => m && m.uploadedBy === (loggedInUser?.username || 'Teacher')) : [];

            if (teacherMaterials.length === 0) {
                container.innerHTML = `
                    <div class="p-4 bg-gray-900/50 rounded-xl border border-gray-800 flex justify-between items-center text-gray-600 italic text-center">
                        <span class="w-full text-xs">No materials uploaded yet. Upload your first material to get started.</span>
                    </div>
                `;
                return;
            }

            // Sort by upload date (newest first)
            teacherMaterials.sort((a, b) => new Date(b.uploadDate) - new Date(a.uploadDate));

            container.innerHTML = teacherMaterials.map(material => {
                const uploadDate = new Date(material.uploadDate);
                const daysAgo = Math.floor((Date.now() - uploadDate.getTime()) / (1000 * 60 * 60 * 24));
                const dateText = daysAgo === 0 ? 'Today' : daysAgo === 1 ? 'Yesterday' : `${daysAgo} days ago`;

                const fileName = material.fileName || '';
                const fileIcon = fileName.endsWith('.pdf') ? 'fa-file-pdf text-red-400' :
                                fileName.endsWith('.ppt') || fileName.endsWith('.pptx') ? 'fa-file-powerpoint text-orange-400' :
                                fileName.endsWith('.doc') || fileName.endsWith('.docx') ? 'fa-file-word text-blue-400' :
                                'fa-file text-gray-400';

                // Escape user input to prevent XSS
                const safeTitle = escapeHtml(material.title || '');
                const safeFileName = escapeHtml(material.fileName || '');
                const safeTargetClass = material.targetClass === 'all' ? 'All Classes' : escapeHtml(material.targetClass || '');

                return `
                    <div class="p-4 bg-gray-900/50 rounded-xl border border-gray-800 flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 bg-gray-800 flex items-center justify-center rounded">
                                <i class="fas ${fileIcon}"></i>
                            </div>
                            <div>
                                <div class="font-bold text-sm text-white">${safeTitle}</div>
                                <div class="text-xs text-gray-500">${safeFileName} • Uploaded ${dateText} • ${safeTargetClass}</div>
                            </div>
                        </div>
                        <button onclick="deleteTeacherMaterial('${material.id}')" class="text-red-400 hover:text-red-300" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        window.deleteTeacherMaterial = function (materialId) {
            if (!confirm('Are you sure you want to delete this material?')) return;

            const materials = getStudyMaterialsStorage();
            // Handle both string and number IDs (materialId comes as string from onclick, but stored as number)
            const filtered = Array.isArray(materials) ? materials.filter(m => m && m.id != materialId) : [];
            saveStudyMaterialsStorage(filtered);
            loadTeacherStudyHistory();
            showMessage("Material deleted successfully.");
        };

        // Load Student Study Materials
        window.loadStudentStudyMaterials = function () {
            const container = document.getElementById('student-materials-container');
            const empty = document.getElementById('student-materials-empty');
            if (!container) return;

            const classFilter = document.getElementById('student-material-class-filter')?.value || 'all';
            const searchTerm = document.getElementById('student-material-search')?.value.toLowerCase() || '';

            // Get student's class
            const userData = registeredUsers[loggedInUser?.username] || {};
            const studentClass = userData.course || userData.studentClass || '';

            const materials = getStudyMaterialsStorage();
            let filteredMaterials = Array.isArray(materials) ? materials.filter(material => {
                if (!material) return false;
                // Filter by class
                if (classFilter !== 'all' && material.targetClass !== 'all' && material.targetClass !== classFilter) {
                    return false;
                }
                // If material is for all classes, show it
                if (material.targetClass === 'all') {
                    return true;
                }
                // If student has a class, show materials for their class or all classes
                if (studentClass && material.targetClass !== studentClass && material.targetClass !== 'all') {
                    return false;
                }
                return true;
            }) : [];

            // Filter by search term
            if (searchTerm) {
                filteredMaterials = filteredMaterials.filter(material =>
                    (material.title || '').toLowerCase().includes(searchTerm) ||
                    (material.fileName || '').toLowerCase().includes(searchTerm)
                );
            }

            // Sort by upload date (newest first)
            filteredMaterials.sort((a, b) => new Date(b.uploadDate) - new Date(a.uploadDate));

            if (filteredMaterials.length === 0) {
                if (empty) empty.classList.remove('hidden');
                container.innerHTML = '';
                return;
            }

            if (empty) empty.classList.add('hidden');

            container.innerHTML = filteredMaterials.map(material => {
                const uploadDate = new Date(material.uploadDate);
                const dateText = uploadDate.toLocaleDateString();
                const uploadedBy = material.uploadedBy || 'Teacher';

                const fileIcon = material.fileName.endsWith('.pdf') ? 'fa-file-pdf text-red-400' :
                                material.fileName.endsWith('.ppt') || material.fileName.endsWith('.pptx') ? 'fa-file-powerpoint text-orange-400' :
                                material.fileName.endsWith('.doc') || material.fileName.endsWith('.docx') ? 'fa-file-word text-blue-400' :
                                material.fileName.match(/\.(jpg|jpeg|png|gif)$/i) ? 'fa-file-image text-green-400' :
                                'fa-file text-gray-400';

                // Escape user input to prevent XSS
                const safeTitle = escapeHtml(material.title || '');
                const safeFileName = escapeHtml(material.fileName || '');
                const safeTargetClass = material.targetClass === 'all' ? 'All Classes' : escapeHtml(material.targetClass || '');
                const safeUploadedBy = escapeHtml(uploadedBy);

                return `
                    <div class="p-4 bg-gray-900/50 rounded-xl border border-gray-800 flex justify-between items-center hover:bg-gray-900/70 transition">
                        <div class="flex items-center gap-4 flex-1">
                            <div class="w-12 h-12 bg-gray-800 flex items-center justify-center rounded">
                                <i class="fas ${fileIcon} text-xl"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-white mb-1">${safeTitle}</div>
                                <div class="text-xs text-gray-400">${safeFileName} • ${(material.fileSize / 1024).toFixed(2)} KB • Uploaded ${dateText}</div>
                                <div class="text-xs text-gray-500 mt-1">Class: ${safeTargetClass} • By: ${safeUploadedBy}</div>
                            </div>
                        </div>
                        <button onclick="downloadStudentMaterial(${material.id})"
                            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition flex items-center gap-2">
                            <i class="fas fa-download"></i>Download
                        </button>
                    </div>
                `;
            }).join('');
        };

        window.downloadStudentMaterial = function (materialId) {
            const materials = getStudyMaterialsStorage();
            // Handle both string and number IDs
            const material = Array.isArray(materials) ? materials.find(m => m && (m.id == materialId || m.id === materialId)) : null;

            if (!material) {
                showMessage("Material not found.");
                return;
            }

            if (!material.fileData) {
                showMessage("File data is missing. Please contact your teacher.");
                return;
            }

            try {
                // Create download link
                const link = document.createElement('a');
                link.href = material.fileData;
                link.download = material.fileName;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
               
                // Clean up after a short delay
                setTimeout(() => {
                    document.body.removeChild(link);
                }, 100);
               
                showMessage(`Downloading ${material.fileName}...`);
            } catch (error) {
                console.error('Download error:', error);
                showMessage("Error downloading file. Please try again.");
            }
        };

        window.showAdminSection = function (sub) {
            document.querySelectorAll('.sub-tab-btn').forEach(b => {
                b.classList.remove('text-blue-400', 'border-b-2', 'border-blue-400');
                b.classList.add('text-gray-400');
                if (b.dataset.sub === sub) {
                    b.classList.add('text-blue-400', 'border-b-2', 'border-blue-400');
                    b.classList.remove('text-gray-400');
                }
            });

            document.querySelectorAll('.admin-sub-content').forEach(c => c.classList.add('hidden'));
            const subContent = document.getElementById('admin-sub-' + sub);
            if (subContent) subContent.classList.remove('hidden');

            if (sub === 'remove') {
                renderAdminEditTable();
            } else if (sub === 'modify') {
                if (typeof renderAdminUserTable === 'function') renderAdminUserTable();
            }
        };

        window.enterStudentPortal = function () {
            console.log("Student portal requested");
            try {
                const roleSelection = document.getElementById('role-selection');
                if (roleSelection) roleSelection.classList.add('hidden');
                if (studentAuth) studentAuth.classList.remove('hidden');
                if (typeof goHome === 'function') goHome();
            } catch (e) {
                alert("Student Portal Error: " + e.message);
            }
        };

        window.backToRoles = function () {
            console.log("Back to role selection");
            try {
                const roleSelection = document.getElementById('role-selection');
                if (roleSelection) roleSelection.classList.remove('hidden');
                if (studentAuth) studentAuth.classList.add('hidden');
                if (typeof stopAllVideo === 'function') stopAllVideo();
            } catch (e) {
                console.error("Back to roles error:", e);
            }
        };


        let isVideoRegPlaying = false;
        let isVideoLoginPlaying = false;
        let isVideoAttendancePlaying = false;
        let sentOTP = null;
        let livenessChallenge = []; // Array of tasks e.g. ['smile', 'turn_right', 'move_close']
        let currentTaskIdx = 0;
        let lastTaskTimestamp = 0;
        let isLivenessActive = false;
        let livenessMode = null; // 'register', 'login'
        let pendingRegUsername = '';

        let regInterval, loginInterval, attendanceInterval;
        let registeredUsers = {};
        let loggedInUser = null;
       
        // Safely load registeredUsers from localStorage
        try {
            const stored = localStorage.getItem('registeredUsers');
            if (stored) {
                registeredUsers = JSON.parse(stored);
            }
        } catch (err) {
            console.error('Error loading registeredUsers from localStorage:', err);
            registeredUsers = {};
            try {
                localStorage.setItem('registeredUsers', '{}');
            } catch (e) {
                console.error('Error resetting registeredUsers in localStorage:', e);
            }
        }

        // Classroom location
        const CLASSROOM_LOCATION = { lat: 22.681104, lon: 75.879651 };
        const RADIUS_METERS = 50;

        // Helper function to safely parse JSON from localStorage
        function safeParseJSON(key, defaultValue) {
            try {
                const stored = localStorage.getItem(key);
                if (!stored) return defaultValue;
                return JSON.parse(stored);
            } catch (err) {
                console.error(`Error parsing ${key} from localStorage:`, err);
                return defaultValue;
            }
        }

        // Helper function to safely find batch
        function safeFindBatch(batches, batchId) {
            if (!Array.isArray(batches) || !batchId) return null;
            return batches.find(b => b && b.id === batchId) || null;
        }

        // Utility functions
        const showMessage = (msg) => {
            if (messageText) messageText.textContent = msg;
            if (messageBox) messageBox.classList.remove('hidden');
        };
        const hideMessage = () => {
            if (messageBox) messageBox.classList.add('hidden');
        };
        window.hideMessage = hideMessage; // Make it globally accessible
        const toggleMainApp = (show) => {
            if (show) {
                authScreens.classList.add('hidden');
                mainApp.classList.remove('hidden');
                navbar.classList.remove('hidden');
                mobileTabs.classList.remove('hidden');
                dashboardContent.classList.remove('hidden');
            } else {
                authScreens.classList.remove('hidden');
                mainApp.classList.add('hidden');
                navbar.classList.add('hidden');
                mobileTabs.classList.add('hidden');
                dashboardContent.classList.add('hidden');
            }
        };

        const goHome = () => {
            stopAllVideo();
            homeScreen.classList.remove('hidden');
        };

        const stopAllVideo = () => {
            [videoReg, videoLogin, videoAttendance].forEach(v => {
                if (v && v.srcObject) {
                    v.srcObject.getTracks().forEach(t => t.stop());
                    v.pause();
                }
            });
            if (regInterval) clearInterval(regInterval);
            if (loginInterval) clearInterval(loginInterval);
            if (attendanceInterval) clearInterval(attendanceInterval);
            isVideoRegPlaying = false;
            isVideoLoginPlaying = false;
            isVideoAttendancePlaying = false;
        };


        // Google Auth Functions
        window.handleCredentialResponse = (response) => {
            try {
                if (!response || !response.credential) {
                    showMessage("Invalid authentication response.");
                    return;
                }
               
                const credentialParts = response.credential.split('.');
                if (credentialParts.length < 2) {
                    showMessage("Invalid credential format.");
                    return;
                }
               
                const base64Url = credentialParts[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                let jsonPayload;
                try {
                    jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));
                } catch (err) {
                    console.error('Error decoding JWT:', err);
                    showMessage("Error decoding authentication token.");
                    return;
                }

                let payload;
                try {
                    payload = JSON.parse(jsonPayload);
                } catch (err) {
                    console.error('Error parsing JWT payload:', err);
                    showMessage("Error parsing authentication data.");
                    return;
                }
               
                if (!payload || !payload.email) {
                    showMessage("Invalid authentication data.");
                    return;
                }
               
                const email = payload.email;
                let name = payload.name || email.split('@')[0];

                // Domain Restriction
                if (!email || typeof email !== 'string' || !email.endsWith('@ietdavv.edu.in')) {
                    showMessage("Access Denied: Please use your official @ietdavv.edu.in account.");
                    return;
                }

                // Check email-to-name mapping (set by admin)
                let emailToNameMap = {};
                try {
                    emailToNameMap = safeParseJSON('spark_email_name_map', {});
                } catch (err) {
                    console.error('Error parsing emailToNameMap:', err);
                    emailToNameMap = {};
                }
                if (emailToNameMap[email]) {
                    name = emailToNameMap[email];
                }

                // Check if user already exists
                let existingUser = null;
            for (let username in registeredUsers) {
                if (registeredUsers[username] && registeredUsers[username].email === email) {
                    existingUser = { username, ...registeredUsers[username] };
                        // Update name if admin has set it
                        if (emailToNameMap[email] && emailToNameMap[email] !== existingUser.name) {
                            existingUser.name = emailToNameMap[email];
                            registeredUsers[username].name = emailToNameMap[email];
                            try {
                                localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
                            } catch (err) {
                                console.error('Error saving registeredUsers to localStorage:', err);
                                showMessage("Error saving data. Please try again.");
                            }
                        }
                        break;
                    }
                }

                if (existingUser) {
                    loggedInUser = existingUser;
                    saveSession(loggedInUser);
                    toggleMainApp(true);
                    populateProfileData();
                    updateDashboardProfile();
                   
                    // Check if user needs face registration (no descriptor)
                    if (!existingUser.descriptor || existingUser.descriptor.length === 0) {
                        showMessage("Welcome back, " + existingUser.name + "! Please register your face.");
                        // Automatically start face registration
                        setTimeout(() => {
                            startFaceRegistrationFlow();
                        }, 1000);
                    } else {
                        showMessage("Welcome back, " + existingUser.name + "!");
                    }
                } else {
                    // NEW USER - DIRECT LOGIN (Deferred enrollment)
                    const safeName = name || 'user';
                    const username = safeName.replace(/\s+/g, '_').toLowerCase() + "_" + Math.floor(Math.random() * 1000);
                    const newUser = {
                        username: username,
                        email: email,
                        name: name,
                        role: 'student',
                        id: "STU" + Math.floor(Math.random() * 100000),
                        course: 'B.Tech CS',
                        descriptor: null, // Face not registered yet
                        faceKey: null // Unique face key will be generated during registration
                    };

                    registeredUsers[username] = newUser;
                    localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));

                    loggedInUser = newUser;
                    saveSession(loggedInUser);
                    toggleMainApp(true);
                    populateProfileData();
                    updateDashboardProfile();
                    showMessage("Welcome, " + name + "! Please register your face.");
                   
                    // Automatically start face registration for new users
                    setTimeout(() => {
                        startFaceRegistrationFlow();
                    }, 1000);
                }

            } catch (error) {
                console.error("Decoding JWT failed", error);
                showMessage("Authentication failed. Please try again.");
            }
        };

        // Manual Entry Variables
        let manualVideoStream = null;
        let manualFaceDescriptor = null;
        let manualVideoFrames = [];
        let manualVideoInterval = null;
        let isManualVideoPlaying = false;

        // Manual Entry Functions
        window.showManualEntryForm = () => {
            const container = document.getElementById('manual-entry-container');
            const button = document.getElementById('manual-entry-btn');
            if (container) {
                container.classList.remove('hidden');
            }
            if (button) {
                button.classList.add('hidden');
            }
        };

        window.hideManualEntryForm = () => {
            const container = document.getElementById('manual-entry-container');
            const button = document.getElementById('manual-entry-btn');
            if (container) {
                container.classList.add('hidden');
            }
            if (button) {
                button.classList.remove('hidden');
            }
            // Stop camera if running
            stopManualFaceRegistration();
            // Clear form
            const fullnameInput = document.getElementById('manual-fullname');
            const emailInput = document.getElementById('manual-email');
            const collegeIdInput = document.getElementById('manual-college-id');
           
            if (fullnameInput) fullnameInput.value = '';
            if (emailInput) emailInput.value = '';
            if (collegeIdInput) collegeIdInput.value = '';
            manualFaceDescriptor = null;
            manualVideoFrames = [];
        };

        // Start manual face registration camera
        window.startManualFaceRegistration = async () => {
            const video = document.getElementById('manual-video-reg');
            const canvas = document.getElementById('manual-canvas-reg');
            const startBtn = document.getElementById('manual-start-camera-btn');
            const captureBtn = document.getElementById('manual-capture-face-btn');
            const statusDiv = document.getElementById('manual-face-status');

            if (!video || !canvas) {
                showMessage("Camera elements not found.");
                return;
            }

            try {
                // Load models if needed
                if (!modelsLoaded) {
                    await loadModels(true);
                }

                // Get camera stream
                manualVideoStream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = manualVideoStream;
               
                video.onloadedmetadata = () => {
                    video.play();
                    isManualVideoPlaying = true;
                   
                    // Set canvas size
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                   
                    // Start face detection
                    const context = canvas.getContext('2d');
                    manualVideoInterval = setInterval(async () => {
                        if (!isManualVideoPlaying) {
                            clearInterval(manualVideoInterval);
                            return;
                        }
                       
                        context.clearRect(0, 0, canvas.width, canvas.height);
                       
                        try {
                            // Check if faceapi is available
                            if (typeof faceapi === 'undefined' || !faceapi.detectSingleFace) {
                                console.warn('Face API not available');
                                return;
                            }
                           
                            const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.5 }))
                                .withFaceLandmarks().withFaceDescriptor();
                           
                            if (detections) {
                                const resizedDetections = faceapi.resizeResults(detections, { width: canvas.width, height: canvas.height });
                                faceapi.draw.drawDetections(canvas, resizedDetections);
                                faceapi.draw.drawFaceLandmarks(canvas, resizedDetections);
                               
                                // Store face descriptor
                                if (resizedDetections.descriptor && Array.isArray(resizedDetections.descriptor)) {
                                    manualFaceDescriptor = Array.from(resizedDetections.descriptor);
                                } else if (resizedDetections.descriptor) {
                                    manualFaceDescriptor = Array.from(resizedDetections.descriptor);
                                }
                               
                                // Capture video frame
                                if (manualVideoFrames.length < 10) { // Store up to 10 frames
                                    const frameData = canvas.toDataURL('image/jpeg', 0.8);
                                    manualVideoFrames.push(frameData);
                                }
                               
                                if (statusDiv) {
                                    statusDiv.textContent = '✓ Face detected - Ready to capture';
                                    statusDiv.className = 'absolute bottom-0 left-0 right-0 bg-green-600/70 text-white text-center py-2 text-sm';
                                }
                               
                                if (captureBtn) {
                                    captureBtn.classList.remove('hidden');
                                }
                            } else {
                                if (statusDiv) {
                                    statusDiv.textContent = 'Position your face in front of the camera';
                                    statusDiv.className = 'absolute bottom-0 left-0 right-0 bg-black/70 text-white text-center py-2 text-sm';
                                }
                                if (captureBtn) {
                                    captureBtn.classList.add('hidden');
                                }
                            }
                        } catch (err) {
                            console.error('Face detection error:', err);
                        }
                    }, 200);
                };

                if (startBtn) startBtn.classList.add('hidden');
                if (statusDiv) {
                    statusDiv.textContent = 'Starting camera...';
                }
            } catch (err) {
                console.error('Camera error:', err);
                showMessage("Could not access camera. Please allow camera permissions.");
            }
        };

        // Capture face manually
        window.captureManualFace = () => {
            if (!manualFaceDescriptor || manualFaceDescriptor.length === 0) {
                showMessage("Please wait for face detection.");
                return;
            }
           
            const submitBtn = document.getElementById('manual-submit-btn');
            const statusDiv = document.getElementById('manual-face-status');
           
            if (statusDiv) {
                statusDiv.textContent = '✓ Face captured successfully!';
                statusDiv.className = 'absolute bottom-0 left-0 right-0 bg-green-600/70 text-white text-center py-2 text-sm';
            }
           
            if (submitBtn) {
                submitBtn.disabled = false;
            }
           
            showMessage("Face captured! Please fill all details and click Register.");
        };

        // Stop manual face registration
        function stopManualFaceRegistration() {
            isManualVideoPlaying = false;
            if (manualVideoInterval) {
                clearInterval(manualVideoInterval);
                manualVideoInterval = null;
            }
            if (manualVideoStream) {
                manualVideoStream.getTracks().forEach(track => track.stop());
                manualVideoStream = null;
            }
            const video = document.getElementById('manual-video-reg');
            const canvas = document.getElementById('manual-canvas-reg');
            if (video) {
                video.srcObject = null;
            }
            if (canvas) {
                const context = canvas.getContext('2d');
                context.clearRect(0, 0, canvas.width, canvas.height);
            }
           
            const startBtn = document.getElementById('manual-start-camera-btn');
            const captureBtn = document.getElementById('manual-capture-face-btn');
            const statusDiv = document.getElementById('manual-face-status');
           
            if (startBtn) startBtn.classList.remove('hidden');
            if (captureBtn) captureBtn.classList.add('hidden');
            if (statusDiv) {
                statusDiv.textContent = 'Position your face in front of the camera';
                statusDiv.className = 'absolute bottom-0 left-0 right-0 bg-black/70 text-white text-center py-2 text-sm';
            }
        }

        window.handleManualEntry = () => {
            // Get form values
            const fullname = document.getElementById('manual-fullname')?.value.trim();
            const email = document.getElementById('manual-email')?.value.trim();
            const collegeId = document.getElementById('manual-college-id')?.value.trim();

            // Validate all fields
            if (!fullname || !email || !collegeId) {
                showMessage("Please fill all fields.");
                return;
            }

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showMessage("Please enter a valid email address.");
                return;
            }

            // Domain Restriction
            if (!email || typeof email !== 'string' || !email.endsWith('@ietdavv.edu.in')) {
                showMessage("Access Denied: Please use your official @ietdavv.edu.in account.");
                return;
            }

            // Check if face is captured
            if (!manualFaceDescriptor || manualFaceDescriptor.length === 0) {
                showMessage("Please capture your face first using the camera.");
                return;
            }

            // Check if user already exists
            let existingUser = null;
            let existingUsername = null;
            for (let username in registeredUsers) {
                if (registeredUsers[username] && (registeredUsers[username].email === email || registeredUsers[username].id === collegeId)) {
                    existingUser = registeredUsers[username];
                    existingUsername = username;
                    break;
                }
            }

            if (existingUser) {
                // Update existing user with new face data
                const usernamePrefix = existingUsername && existingUsername.length >= 3 ? existingUsername.substring(0, 3).toUpperCase() : 'USR';
                const uniqueFaceKey = "FACE_" + Date.now() + "_" + Math.floor(Math.random() * 100000) + "_" + usernamePrefix;
               
                registeredUsers[existingUsername] = {
                    ...existingUser,
                    name: fullname,
                    email: email,
                    id: collegeId,
                    descriptor: manualFaceDescriptor,
                    faceKey: uniqueFaceKey,
                    faceVideoFrames: manualVideoFrames, // Store video frames
                    faceRegisteredAt: new Date().toISOString()
                };
               
                loggedInUser = {
                    username: existingUsername,
                    ...registeredUsers[existingUsername]
                };
                saveSession(loggedInUser);
                localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
               
                stopManualFaceRegistration();
                hideManualEntryForm();
               
                toggleMainApp(true);
                populateProfileData();
                updateDashboardProfile();
                showMessage("Welcome back, " + fullname + "! Face updated successfully.");
            } else {
                // NEW USER - Create new user with face registration
                const safeFullname = fullname || 'user';
                const username = safeFullname.replace(/\s+/g, '_').toLowerCase() + "_" + Math.floor(Math.random() * 1000);
                const usernamePrefix = username && username.length >= 3 ? username.substring(0, 3).toUpperCase() : 'USR';
                const uniqueFaceKey = "FACE_" + Date.now() + "_" + Math.floor(Math.random() * 100000) + "_" + usernamePrefix;
               
                const newUser = {
                    username: username,
                    name: fullname,
                    email: email,
                    id: collegeId,
                    role: 'student',
                    descriptor: manualFaceDescriptor,
                    faceKey: uniqueFaceKey,
                    faceVideoFrames: manualVideoFrames, // Store video frames
                    faceRegisteredAt: new Date().toISOString()
                };

                registeredUsers[username] = newUser;
                localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));

                loggedInUser = newUser;
                saveSession(loggedInUser);
               
                stopManualFaceRegistration();
                hideManualEntryForm();
               
                toggleMainApp(true);
                populateProfileData();
                updateDashboardProfile();
                showMessage("Welcome, " + fullname + "! Registration successful with face ID.");
            }
        };

        // Liveness Logic
        const TASKS = {
            'smile': { text: "Smile", icon: "fa-smile", check: (d) => d.expressions.happy > 0.7 },
            'neutral': { text: "Straight Face (Neutral)", icon: "fa-meh", check: (d) => d.expressions.neutral > 0.8 },

            'turn_right': {
                text: "Turn Face Left", icon: "fa-arrow-left", check: (d) => {
                    const nose = d.landmarks.positions[30];
                    const boxCenter = d.detection.box.x + d.detection.box.width / 2;
                    return (nose._x - boxCenter) > (d.detection.box.width * 0.15);
                }
            },
            'turn_left': {
                text: "Turn Face Right", icon: "fa-arrow-right", check: (d) => {
                    const nose = d.landmarks.positions[30];
                    const boxCenter = d.detection.box.x + d.detection.box.width / 2;
                    return (boxCenter - nose._x) > (d.detection.box.width * 0.15);
                }
            },

            'tilt_left': {
                text: "Tilt Head Left", icon: "fa-undo", check: (d) => {
                    // Left Eye (36) vs Right Eye (45) - Y coordinates
                    // Tilt Left -> Left Eye (image right) goes DOWN, Right Eye (image left) goes UP ?
                    // No, Tilt Head Left (Ear to shoulder) -> Left Eye (36) is lower Y than Right Eye (45)?
                    // Wait: 36 is Outer Left Eye corner (User's Left). 45 is Outer Right Eye (User's Right).
                    // User Left Tilt: 36 becomes Higher Y (screen coordinates: Y increases downwards). 36.y > 45.y ??
                    // No. Y=0 is TOP.
                    // User tilts head LEFT (Left Ear down). Left Eye (36) Y INCREASES (Goes down). Right Eye (45) Y DECREASES (Goes UP).
                    // So (36.y - 45.y) should be POSITIVE and Large.
                    return (d.landmarks.positions[36]._y - d.landmarks.positions[45]._y) > 15;
                }
            },
            'tilt_right': {
                text: "Tilt Head Right", icon: "fa-redo", check: (d) => {
                    const leftEye = d.landmarks.positions[36];
                    const rightEye = d.landmarks.positions[45];
                    // Right Eye (45) goes DOWN (Y increases). Left Eye (36) goes UP (Y decreases).
                    // So (45.y - 36.y) > 15
                    return (d.landmarks.positions[45]._y - d.landmarks.positions[36]._y) > 15;
                }
            },

            'move_close': {
                text: "Move Closer", icon: "fa-search-plus", check: (d) => {
                    return (d.detection.box.width > 200);
                }
            }
        };

        const generateChallenges = () => {
            const keys = Object.keys(TASKS);
            // Shuffle and pick 3
            livenessChallenge = keys.sort(() => 0.5 - Math.random()).slice(0, 3);
            currentTaskIdx = 0;
            lastTaskTimestamp = Date.now();
            isLivenessActive = true;
            updateLivenessUI();
        };

        const updateLivenessUI = () => {
            const overlay = document.getElementById('liveness-overlay-attendance');
            const icon = document.getElementById('challenge-icon-attendance');
            const text = document.getElementById('challenge-text-attendance');
            const sub = document.getElementById('challenge-sub-attendance');

            if (!overlay) return;

            if (!isLivenessActive) {
                overlay.classList.add('hidden');
                return;
            }

            overlay.classList.remove('hidden');
            const taskKey = livenessChallenge[currentTaskIdx];
            const task = TASKS[taskKey];

            icon.className = `fas ${task.icon} text-6xl text-yellow-400`;
            text.textContent = `Task ${currentTaskIdx + 1}: ${task.text}`;
            text.className = "text-3xl font-bold text-white mb-2 text-center drop-shadow-lg";
            sub.textContent = `Step ${currentTaskIdx + 1} of 3`;
        };

        const processLiveness = (detections) => {
            if (!isLivenessActive) return;

            // Time Check
            if (Date.now() - lastTaskTimestamp > 30000) {
                // Timeout
                showMessage("Session Timed Out! Generating new tasks...");
                generateChallenges();
                return;
            }

            const taskKey = livenessChallenge[currentTaskIdx];
            const passed = TASKS[taskKey].check(detections);

            if (passed) {
                // Task Complete
                currentTaskIdx++;
                lastTaskTimestamp = Date.now(); // Update timestamp for gap check logic

                // Flash Success
                const suffix = livenessMode === 'login' ? '-login' : '';
                const text = document.getElementById('challenge-text' + suffix);
                if (text) {
                    text.textContent = "Great!";
                    text.classList.remove('text-white');
                    text.classList.add('text-green-400');
                }

                if (currentTaskIdx < livenessChallenge.length) {
                    lastTaskTimestamp = Date.now();
                    updateLivenessUI();
                } else {
                    isLivenessActive = false;
                    updateLivenessUI();

                    if (livenessMode === 'attendance') {
                        // All tasks completed during attendance
                        finalizeAttendance();
                    }
                }
            }
        };

        const completeAction = () => {
            // Finish Registration or Login
            if (livenessMode === 'register') {
                // Register User
                const username = pendingRegUsername;
                // Get descriptor from LAST frame? Or we need to capture it.
                // We need descriptor. Let's assume the face in view is valid (since liveness passed).
                // We need to recapture one for storage.
                // Or we can just grab it in the next loop?
                // Let's flag a "capture_needed".

                // Simpler: Trigger the registration logic loop ONE last time.
                // Actually, we can assume registeredUsers is global.
                // We need the descriptor.
                // Let's grab it from the current frame? No, processLiveness is inside loop.
                // We will set a flag `finalizeAction = true` and catch it in the loop.
            }
            finalizeAction = true;
        };

        let finalizeAction = false;

        // Haversine distance
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // metres
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // in metres
        }

        // Track if models are loaded
        let modelsLoaded = false;
        let modelsLoading = false;

        // Load face-api models (lazy load - only when needed)
        const loadModels = async (showLoading = false) => {
            // If already loaded, return immediately
            if (modelsLoaded) {
                return Promise.resolve();
            }
           
            // If already loading, wait for it
            if (modelsLoading) {
                return new Promise((resolve) => {
                    const checkLoaded = setInterval(() => {
                        if (modelsLoaded) {
                            clearInterval(checkLoaded);
                            resolve();
                        }
                    }, 100);
                });
            }

            modelsLoading = true;
           
            // Check if faceapi is available
            if (typeof faceapi === 'undefined' || !faceapi.nets) {
                // Wait a bit for script to load
                await new Promise(resolve => setTimeout(resolve, 100));
                if (typeof faceapi === 'undefined' || !faceapi.nets) {
                    modelsLoading = false;
                    throw new Error('Face API library not loaded yet');
                }
            }

            if (showLoading) {
                loading.classList.remove('hidden');
                const roleSelection = document.getElementById('role-selection');
                if (roleSelection) roleSelection.classList.add('hidden');
            }

            try {
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
                    faceapi.nets.faceLandmark68Net.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
                    faceapi.nets.faceRecognitionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
                    faceapi.nets.faceExpressionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models')
                ]);
                modelsLoaded = true;
                modelsLoading = false;
               
                if (showLoading) {
                    loading.classList.add('hidden');
                    const roleSelection = document.getElementById('role-selection');
                    if (roleSelection) roleSelection.classList.remove('hidden');
                }
            } catch (err) {
                console.error(err);
                modelsLoading = false;
                if (showLoading) {
                    showMessage("Failed to load face models.");
                    loading.classList.add('hidden');
                    const roleSelection = document.getElementById('role-selection');
                    if (roleSelection) roleSelection.classList.remove('hidden');
                }
                throw err;
            }
        };

        // Update canvas size
        function updateCanvasSize(video, canvas) {
            if (!video || !canvas) return;
            try {
                canvas.width = video.offsetWidth || video.videoWidth || 640;
                canvas.height = video.offsetHeight || video.videoHeight || 480;
                if (typeof faceapi !== 'undefined' && faceapi.matchDimensions) {
                    faceapi.matchDimensions(canvas, { width: canvas.width, height: canvas.height });
                }
            } catch (err) {
                console.error('Error updating canvas size:', err);
            }
        }

        // Start camera & detect face
        const startVideo = async (video, canvas, mode) => {
            // Validate inputs
            if (!video || !canvas) {
                console.error('Video or canvas element is missing');
                showMessage("Camera elements not available.");
                return;
            }

            stopAllVideo();
           
            // Load models if not already loaded (only for face recognition modes)
            if ((mode === 'register' || mode === 'login' || mode === 'attendance') && !modelsLoaded) {
                try {
                    showMessage("Loading face recognition models...");
                    await loadModels(true);
                } catch (err) {
                    console.error('Failed to load models:', err);
                    showMessage("Failed to load face recognition. Please refresh the page.");
                    return;
                }
            }
           
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                if (!stream) {
                    showMessage("Could not access camera.");
                    return;
                }
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    // Set canvas size after a short delay for rendering
                    setTimeout(() => updateCanvasSize(video, canvas), 200);
                    // Optional: Listen for resize (modern browsers)
                    if (typeof ResizeObserver !== 'undefined' && video.parentElement) {
                        try {
                            const resizeObserver = new ResizeObserver(() => updateCanvasSize(video, canvas));
                            resizeObserver.observe(video.parentElement);
                        } catch (err) {
                            console.warn('ResizeObserver not supported:', err);
                        }
                    }
                    if (mode === 'register') {
                        isVideoRegPlaying = true;
                        detectFace(video, canvas, mode);
                    } else if (mode === 'login') {
                        isVideoLoginPlaying = true;
                        detectFace(video, canvas, mode);
                    } else if (mode === 'attendance') {
                        isVideoAttendancePlaying = true;
                        detectFace(video, canvas, mode);
                    }
                };
            } catch (err) {
                console.error(err);
                showMessage("Could not access camera.");
            }
        };

        // Detect face
        const detectFace = (video, canvas, mode) => {
            // Validate inputs
            if (!video || !canvas) {
                console.error('Video or canvas element is missing');
                return;
            }

            // Ensure models are loaded before starting detection
            if (!modelsLoaded && (mode === 'register' || mode === 'login' || mode === 'attendance')) {
                console.warn('Models not loaded yet, waiting...');
                // Try to load models and retry
                loadModels().then(() => {
                    detectFace(video, canvas, mode);
                }).catch(err => {
                    console.error('Failed to load models for face detection:', err);
                    showMessage("Face recognition models not ready. Please refresh the page.");
                });
                return;
            }
           
            const context = canvas.getContext('2d');
            if (!context) {
                console.error('Could not get canvas context');
                return;
            }
            const interval = setInterval(async () => {
                let isPlaying;
                if (mode === 'register') isPlaying = isVideoRegPlaying;
                else if (mode === 'login') isPlaying = isVideoLoginPlaying;
                else if (mode === 'attendance') isPlaying = isVideoAttendancePlaying;
                if (!isPlaying) {
                    clearInterval(interval);
                    return;
                }
                if (video.paused || video.ended) {
                    clearInterval(interval);
                    return;
                }
                context.clearRect(0, 0, canvas.width, canvas.height);
               
                // Check if faceapi is available
                if (typeof faceapi === 'undefined' || !faceapi.detectSingleFace) {
                    console.warn('Face API not available');
                    return;
                }
               
                let detections;
                try {
                    detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.5 })).withFaceLandmarks().withFaceExpressions().withFaceDescriptor();
                } catch (err) {
                    console.error('Face detection error:', err);
                    return; // Continue to next iteration
                }
               
                if (detections) {
                    const resizedDetections = faceapi.resizeResults(detections, { width: canvas.width, height: canvas.height });
                    faceapi.draw.drawDetections(canvas, resizedDetections);
                    faceapi.draw.drawFaceExpressions(canvas, resizedDetections);

                    if (isLivenessActive) {
                        processLiveness(resizedDetections);
                    } else if (finalizeAction) {
                        if (livenessMode === 'register') {
                            finalizeAction = false;

                            // DUPLICATE FACE CHECK
                            const currentDescriptor = resizedDetections.descriptor;
                            let duplicateUser = null;

                            for (const username in registeredUsers) {
                                const user = registeredUsers[username];
                                if (user && user.descriptor && user.descriptor.length > 0) {
                                    let dist;
                                    try {
                                        if (!user.descriptor || !Array.isArray(user.descriptor)) {
                                            continue;
                                        }
                                        dist = faceapi.euclideanDistance(currentDescriptor, new Float32Array(user.descriptor));
                                    } catch (err) {
                                        console.error('Error calculating distance:', err);
                                        continue;
                                    }
                                    if (dist < 0.5) { // Slightly stricter threshold for registration
                                        duplicateUser = username;
                                        break;
                                    }
                                }
                            }

                            if (duplicateUser) {
                                showMessage(`Face already registered to user: ${duplicateUser}`);
                                stopAllVideo();
                                goHome();
                                return;
                            }

                            const regData = window.pendingRegData || {};
                            // Update existing admin-added user entry instead of creating new one
                            const existingUser = registeredUsers[pendingRegUsername] || {};
                           
                            // Generate unique face key
                            const usernamePrefix = pendingRegUsername ? pendingRegUsername.substring(0, 3).toUpperCase() : 'USR';
                            const uniqueFaceKey = "FACE_" + Date.now() + "_" + Math.floor(Math.random() * 100000) + "_" + usernamePrefix;
                           
                            registeredUsers[pendingRegUsername] = {
                                ...existingUser, // Preserve existing admin data
                                descriptor: resizedDetections.descriptor ? Array.from(resizedDetections.descriptor) : [],
                                faceKey: uniqueFaceKey, // Store unique face key
                                id: regData.collegeId || existingUser?.id || (pendingRegUsername + "ID"),
                                role: 'student',
                                name: regData.fullname || existingUser?.name || pendingRegUsername,
                                email: regData.email || existingUser?.email || '',
                                batchId: regData.batchId || existingUser?.batchId || '',
                                faceRegisteredAt: new Date().toISOString() // Timestamp of registration
                            };
                           
                            // If batch is selected, add email to batch
                            if (regData.batchId && regData.email) {
                                let batches = [];
                                try {
                                    batches = safeParseJSON('spark_batches', []);
                                } catch (err) {
                                    console.error('Error parsing batches:', err);
                                    batches = [];
                                }
                                const batch = safeFindBatch(batches, regData.batchId);
                                if (batch) {
                                    if (!Array.isArray(batch.students)) {
                                        batch.students = [];
                                    }
                                    if (!batch.students.includes(regData.email.toLowerCase())) {
                                        batch.students.push(regData.email.toLowerCase());
                                       
                                        try {
                                            let emailToBatchMap = safeParseJSON('spark_email_batch_map', {});
                                            emailToBatchMap[regData.email.toLowerCase()] = regData.batchId;
                                            localStorage.setItem('spark_email_batch_map', JSON.stringify(emailToBatchMap));
                                           
                                            // Save batches
                                            if (typeof saveBatches === 'function') {
                                                saveBatches();
                                            } else {
                                                localStorage.setItem('spark_batches', JSON.stringify(batches));
                                            }
                                        } catch (err) {
                                            console.error('Error saving batch mapping:', err);
                                        }
                                    }
                                }
                            }
                            try {
                                localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
                            } catch (err) {
                                console.error('Error saving registeredUsers to localStorage:', err);
                                showMessage("Error saving data. Please try again.");
                            }
                           
                            // Update logged in user with descriptor and face key
                            loggedInUser.descriptor = Array.from(resizedDetections.descriptor);
                            loggedInUser.faceKey = uniqueFaceKey;
                            saveSession(loggedInUser);
                           
                            // Hide scan overlay
                            const scanOverlay = document.getElementById('scan-overlay');
                            if (scanOverlay) scanOverlay.classList.add('hidden');
                           
                            stopAllVideo();
                           
                            // Clear pending data
                            delete window.pendingRegData;
                           
                            // Show dashboard directly after registration
                            toggleMainApp(true);
                            populateProfileData();
                            updateDashboardProfile();
                            showMessage("✅ Face registered successfully! Registration complete.");
                        } else if (livenessMode === 'login') {
                            // Perform Login Match
                            const labeled = Object.entries(registeredUsers)
                                .filter(([u, data]) => data && data.descriptor && Array.isArray(data.descriptor) && data.descriptor.length > 0)
                                .map(([u, data]) => {
                                    try {
                                        try {
                                            if (!data.descriptor || !Array.isArray(data.descriptor) || data.descriptor.length === 0) {
                                                return null;
                                            }
                                            return new faceapi.LabeledFaceDescriptors(u, [new Float32Array(data.descriptor)]);
                                        } catch (err) {
                                            console.error('Error creating LabeledFaceDescriptors:', err);
                                            return null;
                                        }
                                    } catch (err) {
                                        console.error('Error creating LabeledFaceDescriptors for', u, err);
                                        return null;
                                    }
                                })
                                .filter(item => item !== null);

                            if (labeled.length === 0) {
                                finalizeAction = false;
                                showMessage("No users in database!");
                                return;
                            }

                            const matcher = new faceapi.FaceMatcher(labeled, 0.6);
                            const bestMatch = matcher.findBestMatch(resizedDetections.descriptor);

                            if (bestMatch.label !== 'unknown' && bestMatch.distance < 0.6) {
                                finalizeAction = false;
                               
                                const matchedUserData = registeredUsers[bestMatch.label];
                                if (!matchedUserData) {
                                    console.error('Matched user data not found:', bestMatch.label);
                                    showMessage("User data not found. Please contact admin.");
                                    return;
                                }
                               
                                loggedInUser = {
                                    username: bestMatch.label,
                                    ...matchedUserData
                                };
                               
                                // Show dashboard directly after login
                                toggleMainApp(true);
                                saveSession(loggedInUser);
                                localStorage.setItem('spark_role', 'student');
                                populateProfileData();
                                updateDashboardProfile();
                               
                                // Update navigation elements
                                const navUsername = document.getElementById('nav-username');
                                const sidebarUsername = document.getElementById('sidebar-username');
                                const sidebarId = document.getElementById('sidebar-id');
                               
                                if (navUsername) navUsername.textContent = loggedInUser.username || bestMatch.label;
                                if (sidebarUsername) sidebarUsername.textContent = loggedInUser.name || loggedInUser.username || bestMatch.label;
                                if (sidebarId) sidebarId.textContent = (loggedInUser.id || matchedUserData.id || (bestMatch.label + 'ID'));
                               
                                showMessage("Verified & Logged In!");
                            } else {
                                finalizeAction = false;
                                showMessage("Face NOT recognized! Try again.");
                            }
                        } else if (livenessMode === 'enroll') {
                            finalizeAction = false;

                            // DUPLICATE FACE CHECK
                            const currentDescriptor = resizedDetections.descriptor;
                            let duplicateUser = null;
                            for (const username in registeredUsers) {
                                const user = registeredUsers[username];
                                if (user && user.descriptor && user.descriptor.length > 0 && username !== loggedInUser?.username) {
                                    let dist;
                                    try {
                                        if (!user.descriptor || !Array.isArray(user.descriptor)) {
                                            continue;
                                        }
                                        dist = faceapi.euclideanDistance(currentDescriptor, new Float32Array(user.descriptor));
                                    } catch (err) {
                                        console.error('Error calculating distance:', err);
                                        continue;
                                    }
                                    if (dist < 0.5) {
                                        duplicateUser = username;
                                        break;
                                    }
                                }
                            }

                            if (duplicateUser) {
                                showMessage(`Face already linked to: ${duplicateUser}`);
                                return;
                            }

                            // ENROLL
                            if (registeredUsers[loggedInUser.username]) {
                                registeredUsers[loggedInUser.username].descriptor = Array.from(resizedDetections.descriptor);
                                try {
                                localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
                            } catch (err) {
                                console.error('Error saving registeredUsers to localStorage:', err);
                                showMessage("Error saving data. Please try again.");
                            }
                                loggedInUser.descriptor = registeredUsers[loggedInUser.username].descriptor;
                            }

                            showMessage("Face ID Linked! Now starting liveness verification...");

                            setTimeout(() => {
                                livenessMode = 'attendance';
                                generateChallenges();
                            }, 1500);
                        }
                    }

                    // Automatic attendance marking when face is detected
                    if (mode === 'attendance' && !isLivenessActive && !finalizeAction) {
                        // Check if portal is open
                        const activePortalBatchId = localStorage.getItem('spark_active_attendance_portal');
                        if (activePortalBatchId) {
                            // Match face against all registered users
                            const labeled = Object.entries(registeredUsers)
                                .filter(([u, data]) => data && data.descriptor && Array.isArray(data.descriptor) && data.descriptor.length > 0)
                                .map(([u, data]) => {
                                    try {
                                        try {
                                            if (!data.descriptor || !Array.isArray(data.descriptor) || data.descriptor.length === 0) {
                                                return null;
                                            }
                                            return new faceapi.LabeledFaceDescriptors(u, [new Float32Array(data.descriptor)]);
                                        } catch (err) {
                                            console.error('Error creating LabeledFaceDescriptors:', err);
                                            return null;
                                        }
                                    } catch (err) {
                                        console.error('Error creating LabeledFaceDescriptors for', u, err);
                                        return null;
                                    }
                                })
                                .filter(item => item !== null);

                            if (labeled.length > 0) {
                                const matcher = new faceapi.FaceMatcher(labeled, 0.6);
                                const bestMatch = matcher.findBestMatch(resizedDetections.descriptor);

                                // If face matches a registered user
                                if (bestMatch.label !== 'unknown' && bestMatch.distance < 0.6) {
                                    const matchedUser = registeredUsers[bestMatch.label];
                                    if (!matchedUser) {
                                        console.warn('Matched user not found:', bestMatch.label);
                                        return;
                                    }
                                   
                                    const studentEmail = matchedUser.email?.toLowerCase() || '';
                                   
                                    // Check if matched user is in the active batch
                                    let batches = [];
                                    try {
                                        batches = safeParseJSON('spark_batches', []);
                                    } catch (err) {
                                        console.error('Error parsing batches:', err);
                                        batches = [];
                                    }
                                    const activeBatch = Array.isArray(batches) ? batches.find(b => b && b.id === activePortalBatchId) : null;
                                   
                                    if (activeBatch && activeBatch.students && activeBatch.students.includes(studentEmail)) {
                                        // Check if already marked attendance today
                                        let log = [];
                                        try {
                                            log = safeParseJSON('spark_attendance_log', []);
                                        } catch (err) {
                                            console.error('Error parsing attendance log:', err);
                                            log = [];
                                        }
                                        const today = new Date().toDateString();
                                        const alreadyMarked = log.some(entry => {
                                            const entryDate = new Date(entry.timestamp).toDateString();
                                            return entryDate === today && entry.student === bestMatch.label && entry.batchId === activePortalBatchId;
                                        });
                                       
                                        if (!alreadyMarked) {
                                            // Automatically mark attendance
                                            finalizeAction = true;
                                            loggedInUser = {
                                                username: bestMatch.label,
                                                descriptor: matchedUser.descriptor,
                                                faceKey: matchedUser.faceKey
                                            };
                                            saveSession(loggedInUser);
                                           
                                            // Mark attendance automatically - ONLY for this specific student
                                            const activePortalBatchName = localStorage.getItem('spark_active_attendance_portal_name') || '';
                                            const matchedUserEmail = matchedUser.email?.toLowerCase() || '';
                                           
                                            // Verify student is in the active batch
                                            if (activeBatch && matchedUserEmail && !activeBatch.students.includes(matchedUserEmail)) {
                                                showMessage("You are not enrolled in this batch.");
                                                return;
                                            }
                                           
                                            const logEntry = {
                                                timestamp: Date.now(),
                                                className: activePortalBatchName,
                                                batchId: activePortalBatchId,
                                                status: 'Present',
                                                location: 'Verified',
                                                student: bestMatch.label, // Only this specific student
                                                email: matchedUserEmail, // Store email for verification
                                                faceKey: matchedUser.faceKey || 'N/A'
                                            };
                                           
                                            log.push(logEntry);
                                            try {
                                                localStorage.setItem('spark_attendance_log', JSON.stringify(log));
                                            } catch (err) {
                                                console.error('Error saving attendance log:', err);
                                            }
                                           
                                            // Use per-student locking instead of global lock
                                            const studentLockKey = `attendance_locked_until_${bestMatch.label}`;
                                            const lockUntil = Date.now() + (60 * 60 * 1000);
                                            localStorage.setItem(studentLockKey, lockUntil);
                                           
                                            // Update UI
                                            updateDashboardStats();
                                            renderRecentActivity();
                                            checkAttendanceLock();
                                           
                                            // Trigger teacher dashboard update if teacher portal is open
                                            if (typeof updateTeacherStudentOverview === 'function') {
                                                updateTeacherStudentOverview();
                                            }
                                           
                                            showMessage("✅ Attendance marked automatically for " + (matchedUser.name || bestMatch.label) + "!");
                                            stopAllVideo();
                                           
                                            // Hide camera and show success view
                                            const cameraView = document.getElementById('attendance-camera-view');
                                            const lockedView = document.getElementById('attendance-locked-view');
                                            if (cameraView) cameraView.classList.add('hidden');
                                            if (lockedView) lockedView.classList.remove('hidden');
                                           
                                            return; // Stop further processing
                                        }
                                    }
                                }
                            }
                        }
                    }

                    // Button enabling logic (only if liveness NOT active)
                    if (!isLivenessActive) {
                        if (mode === 'register' && registerBtn) registerBtn.disabled = false;
                        else if (mode === 'login' && Object.keys(registeredUsers).length > 0 && loginBtn) loginBtn.disabled = false;
                        else if (mode === 'attendance' && loggedInUser && markAttendanceBtn) markAttendanceBtn.disabled = false;
                    }
                } else {
                    if (mode === 'register' && registerBtn) registerBtn.disabled = true;
                    else if (mode === 'attendance' && markAttendanceBtn) markAttendanceBtn.disabled = true;
                }
            }, 200);
            if (mode === 'register') regInterval = interval;
            else if (mode === 'login') loginInterval = interval;
            else if (mode === 'attendance') attendanceInterval = interval;
        };

        // Handle registration form validation
        const validateRegistrationForm = () => {
            const fullname = document.getElementById('reg-fullname')?.value.trim();
            const collegeId = document.getElementById('reg-college-id')?.value.trim();

            return fullname && collegeId;
        };

        // Function to start face registration flow automatically
        function startFaceRegistrationFlow() {
            if (!loggedInUser) {
                showMessage("Please login first.");
                return;
            }

            // Switch to attendance tab
            const attendanceTab = document.querySelector('[data-tab="attendance"]');
            if (attendanceTab) {
                attendanceTab.click();
            }

            // Set up registration mode using attendance video
            pendingRegUsername = loggedInUser.username;
            window.pendingRegData = {
                fullname: loggedInUser.name || loggedInUser.username,
                collegeId: loggedInUser.id || '',
                email: loggedInUser.email || '',
                studentClass: loggedInUser.studentClass || '',
                batchId: loggedInUser.batchId || ''
            };

            // Start face registration using attendance video
            // Use 'attendance' mode but set livenessMode to 'register' for registration logic
            livenessMode = 'register';
            finalizeAction = true;

            // Show scan overlay if it exists
            const scanOverlay = document.getElementById('scan-overlay');
            if (scanOverlay) scanOverlay.classList.remove('hidden');

            // Start video for registration (using attendance video but in registration mode)
            if (videoAttendance && canvasAttendance) {
                // Start video with 'attendance' mode but registration will be handled by livenessMode
                startVideo(videoAttendance, canvasAttendance, 'attendance');
                showMessage("Please position your face in front of the camera to register.");
            } else {
                showMessage("Camera not available. Please try again.");
            }
        }

        // Register button -> Validate profile details and capture face
        if (registerBtn) {
            registerBtn.addEventListener('click', async () => {
                // Validate all profile fields (these may not exist if using Google OAuth flow)
                const fullname = document.getElementById('reg-fullname')?.value.trim();
                const collegeId = document.getElementById('reg-college-id')?.value.trim();
                const email = document.getElementById('reg-email')?.value.trim();
                const batchId = document.getElementById('reg-batch')?.value;

                // If registration form fields don't exist, try to get from profile
                if (!fullname || !collegeId) {
                    // Try to get from profile if registration form doesn't exist
                    const profileName = document.getElementById('profile-name')?.value.trim();
                    const profileId = document.getElementById('profile-id')?.value.trim();
                    const profileEmail = document.getElementById('profile-email')?.value.trim();
                    const profileBatch = document.getElementById('profile-batch')?.value;
                   
                    if (profileName && profileId) {
                        // Check if student is added by admin (by ID) and find their key
                        let adminAddedKey = null;
                        for (const key in registeredUsers) {
                            const user = registeredUsers[key];
                            if (user && user.id === profileId && user.role === 'student') {
                                adminAddedKey = key;
                                break;
                            }
                        }
                       
                        if (!adminAddedKey || !registeredUsers[adminAddedKey]) {
                            showMessage("Not allowed. Contact admin.");
                            return;
                        }
                       
                        // Check if already fully registered (has descriptor)
                        if (registeredUsers[adminAddedKey].descriptor && registeredUsers[adminAddedKey].descriptor.length > 0) {
                            showMessage("This College ID is already registered.");
                            return;
                        }
                       
                        // Use profile data for registration
                        window.pendingRegData = {
                            fullname: profileName,
                            collegeId: profileId,
                            email: profileEmail || loggedInUser?.email || '',
                            batchId: profileBatch || ''
                        };
                        pendingRegUsername = adminAddedKey; // Use the admin-added key
                    } else {
                        showMessage("Please fill all profile details in the Profile tab first.");
                        return;
                    }
                } else {
                    // Use registration form data
                    // Check if student is added by admin (by ID) and find their key
                    let adminAddedKey = null;
                    for (const key in registeredUsers) {
                        const user = registeredUsers[key];
                        if (user && user.id === collegeId && user.role === 'student') {
                            adminAddedKey = key;
                            break;
                        }
                    }
                   
                    if (!adminAddedKey || !registeredUsers[adminAddedKey]) {
                        showMessage("Not allowed. Contact admin.");
                        return;
                    }
                   
                    // Check if already fully registered (has descriptor)
                    if (registeredUsers[adminAddedKey].descriptor && registeredUsers[adminAddedKey].descriptor.length > 0) {
                        showMessage("This College ID is already registered.");
                        return;
                    }

                    // Store pending registration data
                    pendingRegUsername = adminAddedKey; // Use the admin-added key
                    window.pendingRegData = {
                        fullname: fullname,
                        collegeId: collegeId,
                        email: email,
                        batchId: batchId || ''
                    };
                }

                // Capture Face without liveness (Liveness moved to attendance)
                livenessMode = 'register';
                finalizeAction = true;

                const scanOverlay = document.getElementById('scan-overlay');
                if (scanOverlay) scanOverlay.classList.remove('hidden');

                if (registerBtn) {
                    registerBtn.textContent = "Scanning...";
                    registerBtn.disabled = true;
                }
            });
        }



        // Attendance mark button
        // ===== Attendance Logic with Locking & Logging =====
        let attendanceCheckInterval;

        // Helper: Get Timetable (Fallback to some defaults if empty for demo)
        const getTodayTimetable = () => {
            const stored = localStorage.getItem('spark_timetable_data');
            if (stored) {
                try {
                    return JSON.parse(stored);
                } catch (err) {
                    console.error('Error parsing timetable data:', err);
                    return [];
                }
            }

            return [];
        };

        // Helper: Get Current Active Class
        const getCurrentClass = () => {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMin = now.getMinutes();
            const timetable = getTodayTimetable();

            // Simple logic: Class starts at 'startVal' hour and lasts 1 hour
            // Adjust parsing if time format is complex. Assuming 24h integer for simplicity of demo or simple string match.
            // Code in 'processTimetableData' usually saves "9:00" etc.
            // We need robust parsing.

            for (let cls of timetable) {
                let startH = 0;
                try {
                    if (cls.time && typeof cls.time === 'string') {
                        const timeParts = cls.time.split(':');
                        if (timeParts.length > 0) {
                            startH = parseInt(timeParts[0]) || 0;
                        }
                    }
                } catch (err) {
                    console.error('Error parsing time:', err);
                    startH = 0;
                }
                if (cls.time && typeof cls.time === 'string') {
                    const timeLower = cls.time.toLowerCase();
                    if (timeLower.includes('pm') && startH < 12) startH += 12;
                    if (timeLower.includes('am') && startH === 12) startH = 0;
                }

                // If saved from Excel, it might be just string "09:00".
                // Let's assume standard integer hour matching for robustness in this environment.

                const endH = startH + 1; // 1 hour duration

                if (currentHour >= startH && currentHour < endH) {
                    // Check if minutes matter? standard 00 start.
                    // Calculate exact end time date object
                    const endTime = new Date();
                    endTime.setHours(endH, 0, 0, 0);
                    return { ...cls, endTime: endTime.getTime() };
                }
            }
            return null;
        };

        const updateDashboardStats = () => {
            if (!loggedInUser || !loggedInUser.username) return;
           
            const log = safeParseJSON('spark_attendance_log', []);

            // Filter log for TODAY and for CURRENT USER
            const todayStr = new Date().toDateString();
            const todayLog = log.filter(l =>
                new Date(l.timestamp).toDateString() === todayStr &&
                l.student === loggedInUser.username
            );

            const timetable = getTodayTimetable();
            const totalClasses = timetable.length;

            // Denominator: Total Classes from timetable
            // Numerator: Unique classes attended today
            const attendedClasses = new Set(todayLog.map(l => l.className)).size;

            const statCards = document.getElementById('today-attendance-count');
            if (statCards) statCards.textContent = `${attendedClasses}/${totalClasses}`;
        };

        const renderRecentActivity = () => {
            const list = document.getElementById('recent-activity-list');
            if (!list) return;
           
            if (!loggedInUser || !loggedInUser.username) {
                list.innerHTML = '<p class="text-gray-500 text-center py-4">No recent activity.</p>';
                return;
            }

            const log = safeParseJSON('spark_attendance_log', []);
            // Filter by student and sort recent first
            const recent = log.filter(l => l.student === loggedInUser.username)
                .sort((a, b) => b.timestamp - a.timestamp)
                .slice(0, 5); // Show last 5

            if (recent.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-4">No recent activity.</p>';
                return;
            }

            list.innerHTML = recent.map(item => `
                <div class="bg-[#1a1c2e] rounded-xl p-4 border border-gray-800 animate-fade-in">
                    <div class="flex items-center gap-4 py-2">
                        <div class="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center text-green-400">
                            <i class="fas fa-check"></i>
                        </div>
                        <div>
                            <p class="text-white font-medium">Attendance marked</p>
                            <p class="text-sm text-gray-500">${item.className} • ${new Date(item.timestamp).toLocaleTimeString()}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        };

        const checkAttendanceLock = () => {
            // Use per-student locking instead of global lock
            const currentUsername = loggedInUser?.username;
            const studentLockKey = currentUsername ? `attendance_locked_until_${currentUsername}` : null;
            const lockedUntil = studentLockKey ? localStorage.getItem(studentLockKey) : null;
            const timerContainer = document.getElementById('attendance-timer-container');
            const timerVal = document.getElementById('attendance-countdown');
            const lockMsg = document.getElementById('attendance-lock-msg');
            const btn = document.getElementById('mark-attendance-btn');

            const cameraView = document.getElementById('attendance-camera-view');
            const lockedView = document.getElementById('attendance-locked-view');

            if (!lockedUntil) {
                // Portal Logic Check - Allow attendance if portal is open for student's batch
                const activePortalBatchId = localStorage.getItem('spark_active_attendance_portal');
                const portalMsg = document.getElementById('attendance-portal-message');
               
                // Get student's email
                const userData = loggedInUser ? (registeredUsers[loggedInUser.username] || {}) : {};
                const studentEmail = userData.email?.toLowerCase() || '';

                let isPortalOpen = false;
                // Portal is open if student's email is in the active batch's students array
                if (activePortalBatchId && studentEmail) {
                    const batches = safeParseJSON('spark_batches', []);
                    const activeBatch = Array.isArray(batches) ? batches.find(b => b && b.id === activePortalBatchId) : null;
                    if (activeBatch && activeBatch.students && activeBatch.students.includes(studentEmail)) {
                        isPortalOpen = true;
                    }
                }

                if (timerContainer) timerContainer.classList.add('hidden');

                if (!isPortalOpen) {
                    if (btn) btn.disabled = true;
                    if (portalMsg) portalMsg.classList.remove('hidden');
                    if (cameraView) cameraView.classList.add('hidden');
                    // Stop video if it was playing
                    if (videoAttendance.srcObject) stopAllVideo();
                } else {
                    if (btn) btn.disabled = false;
                    if (portalMsg) portalMsg.classList.add('hidden');
                    if (cameraView) cameraView.classList.remove('hidden');
                }

                // Locked View always hidden if not timed-locked
                if (lockedView) lockedView.classList.add('hidden');
                return; // Added return here to prevent further execution if not locked
            }

            const now = Date.now();
            const target = parseInt(lockedUntil) || 0;
           
            // Only check lock for the current logged-in student
            if (!currentUsername) {
                return;
            }

            if (now < target) {
                // Locked
                if (timerContainer) timerContainer.classList.remove('hidden');
                if (btn) btn.disabled = true;

                // Hide Camera, Show Locked View
                if (cameraView) cameraView.classList.add('hidden');
                if (lockedView) lockedView.classList.remove('hidden');

                // Stop video if playing to save resources
                const video = document.getElementById('video-attendance');
                if (video && video.srcObject) {
                    video.srcObject.getTracks().forEach(t => t.stop());
                    video.srcObject = null;
                }

                // Update timer
                const diff = target - now;
                const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((diff % (1000 * 60)) / 1000);
                if (timerVal) timerVal.textContent = `${m}m ${s}s`;

                // Get class name
                const log = safeParseJSON('spark_attendance_log', []);
                const last = log[log.length - 1];
                if (last && lockMsg) lockMsg.textContent = `Class in progress: ${last.className}`;

            } else {
                // Unlocked
                localStorage.removeItem('attendance_locked_until');
                if (timerContainer) timerContainer.classList.add('hidden');
                if (btn) btn.disabled = true;

                // Show Camera, Hide Locked View
                if (cameraView) cameraView.classList.remove('hidden');
                if (lockedView) lockedView.classList.add('hidden');

                showMessage("Class completed. Attendance unlocked.");
            }
        };

        // Start checking lock every 2 seconds (reduced frequency for better performance)
        setInterval(checkAttendanceLock, 2000);

        // Attendance mark button
        if (markAttendanceBtn) {
            markAttendanceBtn.addEventListener('click', async () => {
                if (!loggedInUser) { showMessage("Not logged in."); return; }

                const activePortalBatchId = localStorage.getItem('spark_active_attendance_portal');
                const userData = registeredUsers[loggedInUser.username] || {};
                const studentEmail = userData.email?.toLowerCase() || '';

                if (!activePortalBatchId) {
                    showMessage("The attendance portal is closed.");
                    return;
                }

                // Check if student is in the active batch
                const batches = safeParseJSON('spark_batches', []);
                const activeBatch = batches.find(b => b.id === activePortalBatchId);
                if (!activeBatch || !activeBatch.students || !activeBatch.students.includes(studentEmail)) {
                    const batchName = activeBatch ? activeBatch.name : 'selected batch';
                    showMessage(`You are not enrolled in ${batchName}.`);
                    return;
                }

                // CHECK IF ENROLLMENT NEEDED
                if (!loggedInUser.descriptor) {
                    showMessage("First-time verification: Linking Face ID...");
                    livenessMode = 'enroll';
                    finalizeAction = true;
                    return;
                }

                // START LIVENESS SEQUENCE
                livenessMode = 'attendance';
                generateChallenges();
                showMessage("Verify identity with liveness check...");
            });
        }


        // Helper to finalize attendance after face match + liveness
        async function finalizeAttendance() {
            try {
                // Ensure models are loaded
                if (!modelsLoaded) {
                    await loadModels(true);
                }
               
                // Check if face-api is loaded
                if (typeof faceapi === 'undefined' || !faceapi.nets || !faceapi.nets.tinyFaceDetector) {
                    showMessage("Face recognition not ready. Please wait...");
                    return;
                }
               
                if (!loggedInUser || !loggedInUser.descriptor) {
                    showMessage("Face not detected");
                    return;
                }
               
                if (!videoAttendance) {
                    showMessage("Face not detected");
                    return;
                }
               
                // Check if video is ready
                if (videoAttendance.paused || videoAttendance.ended || !videoAttendance.srcObject) {
                    showMessage("Face not detected");
                    return;
                }
               
                // Wait a bit for video to be ready
                await new Promise(resolve => setTimeout(resolve, 300));
               
                // Try multiple times with lower threshold for better detection
                let detections = null;
                let attempts = 0;
                const maxAttempts = 10;
               
                while (!detections && attempts < maxAttempts) {
                    try {
                        // Use lower threshold (0.3) for better face detection
                        detections = await faceapi.detectSingleFace(videoAttendance, new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.3 })).withFaceDescriptor();
                        if (!detections) {
                            await new Promise(resolve => setTimeout(resolve, 200));
                            attempts++;
                        }
                    } catch (detectError) {
                        console.error('Detection attempt error:', detectError);
                        await new Promise(resolve => setTimeout(resolve, 200));
                        attempts++;
                    }
                }
               
                if (!detections) {
                    showMessage("Face not detected");
                    return;
                }

                // Convert descriptor to Float32Array if needed for comparison
                const userDescriptor = Array.isArray(loggedInUser.descriptor)
                    ? new Float32Array(loggedInUser.descriptor)
                    : loggedInUser.descriptor;
               
                const distance = faceapi.euclideanDistance(detections.descriptor, userDescriptor);
                // Use more lenient threshold (0.7) for better success rate
                if (distance >= 0.7) {
                    showMessage("Face not detected");
                    return;
                }

                // Location
                if (!navigator.geolocation) {
                    completeAttendanceLog(); // Fallback if no geo
                    return;
                }

                navigator.geolocation.getCurrentPosition(pos => {
                    completeAttendanceLog();
                }, err => {
                    completeAttendanceLog(); // Lenient for demo
                });
            } catch (error) {
                console.error('Face detection error:', error);
                showMessage("Face not detected");
            }
        }

        function completeAttendanceLog() {
            if (!loggedInUser || !loggedInUser.username) {
                showMessage("Face not detected");
                return;
            }
           
            // Double-check: Only mark attendance for the logged-in user
            const currentUsername = loggedInUser.username;
            const userData = registeredUsers[currentUsername] || {};
            const studentEmail = userData.email?.toLowerCase() || '';
           
            const activePortalBatchId = localStorage.getItem('spark_active_attendance_portal');
            const activePortalBatchName = localStorage.getItem('spark_active_attendance_portal_name') || '';
           
            // Verify student is in the active batch
            if (activePortalBatchId && studentEmail) {
                const batches = safeParseJSON('spark_batches', []);
                const activeBatch = batches.find(b => b.id === activePortalBatchId);
                if (!activeBatch || !activeBatch.students || !activeBatch.students.includes(studentEmail)) {
                    showMessage("You are not enrolled in this batch.");
                    return;
                }
            }
           
            // Check if already marked attendance today for this specific student
            const log = safeParseJSON('spark_attendance_log', []);
            const today = new Date().toDateString();
            const alreadyMarked = log.some(entry => {
                const entryDate = new Date(entry.timestamp).toDateString();
                return entryDate === today &&
                       entry.student === currentUsername &&
                       entry.batchId === activePortalBatchId;
            });
           
            if (alreadyMarked) {
                showMessage("You have already marked attendance today.");
                return;
            }
           
            // Mark attendance ONLY for this specific student
            const logEntry = {
                timestamp: Date.now(),
                className: activePortalBatchName,
                batchId: activePortalBatchId,
                status: 'Present',
                location: 'Verified',
                student: currentUsername, // Only the logged-in student
                email: studentEmail // Store email for verification
            };

            log.push(logEntry);
            localStorage.setItem('spark_attendance_log', JSON.stringify(log));

            // Use per-student locking instead of global lock
            const studentLockKey = `attendance_locked_until_${currentUsername}`;
            const lockUntil = Date.now() + (60 * 60 * 1000);
            localStorage.setItem(studentLockKey, lockUntil);

            updateDashboardStats();
            renderRecentActivity();
            checkAttendanceLock();
           
            // Trigger teacher dashboard update if teacher portal is open
            if (typeof updateTeacherStudentOverview === 'function') {
                updateTeacherStudentOverview();
            }
           
            // Show success popup
            showMessage("Present");
        }

        // Logout function
        window.logout = function () {
            loggedInUser = null;
            clearSession();
            toggleMainApp(false);

            // Go back to role selection on logout
            const roleSelection = document.getElementById('role-selection');
            if (roleSelection) roleSelection.classList.remove('hidden');
            if (studentAuth) studentAuth.classList.add('hidden');

            if (homeScreen) homeScreen.classList.add('hidden');
            // Safely hide screens that might be missing
            const regScreen = document.getElementById('register-screen');
            const logScreen = document.getElementById('login-screen');
            if (regScreen) regScreen.classList.add('hidden');
            if (logScreen) logScreen.classList.add('hidden');

            stopAllVideo();
        };


        // ===== Dashboard Tab Functionality =====



        // ===== Timetable Day Change (Simple Simulation) =====
        function changeDay(day) {
            document.querySelectorAll('#timetable button').forEach(btn => btn.classList.remove('bg-blue-700', 'text-white'));
            event.target.classList.add('bg-blue-700', 'text-white');
            const dates = {
                'Mon': 'Monday, 18 September 2025',
                'Tue': 'Tuesday, 19 September 2025',
                'Wed': 'Wednesday, 20 September 2025',
                'Thu': 'Thursday, 21 September 2025',
                'Fri': 'Friday, 22 September 2025'
            };
            document.getElementById('currentDate').textContent = dates[day] || 'Monday, 12 June 2023';
            // Simulate content change (static for demo)
            const content = document.getElementById('timetableContent');
            content.innerHTML = `
                <div class="flex items-center p-4 border-l-4 border-blue-500 bg-blue-900 rounded-lg">
                    <div class="w-16 text-blue-200 font-bold">9:00</div>
                    <div class="flex-1">
                        <h3 class="font-semibold">${day} Subject 1</h3>
                        <p class="text-sm text-gray-400">Room 302 • Prof. Sharma</p>
                    </div>
                    <div class="bg-green-800 text-green-200 text-xs px-2 py-1 rounded-full">Completed</div>
                </div>
                <div class="flex items-center p-4 border-l-4 border-blue-500 bg-blue-900 rounded-lg">
                    <div class="w-16 text-blue-200 font-bold">10:00</div>
                    <div class="flex-1">
                        <h3 class="font-semibold">${day} Subject 2</h3>
                        <p class="text-sm text-gray-400">Room 305 • Prof. Gupta</p>
                    </div>
                    <div class="bg-yellow-800 text-yellow-200 text-xs px-2 py-1 rounded-full">In Progress</div>
                </div>
            `;
        }

        // ===== Suggestions Start Buttons =====
        function startSuggestion(type) {
            const links = {
                'algorithms': 'https://leetcode.com/problemset/javascript/',
                'ml': 'https://arxiv.org/list/cs.LG/recent',
                'ds': 'https://www.geeksforgeeks.org/data-structures/',
                'project': 'https://trello.com'
            };
            window.open(links[type] || 'https://example.com', '_blank');
        }

        // ===== Profile Save =====
        const saveProfBtn = document.getElementById('saveProfileBtn');
        if (saveProfBtn) {
            saveProfBtn.addEventListener('click', () => {
                const profile = {
                    name: document.getElementById('profile-name')?.value || '',
                    id: document.getElementById('profile-id')?.value || '',
                    email: document.getElementById('profile-email')?.value || '',
                    course: document.getElementById('profile-course')?.value || '',
                    goals: document.getElementById('profile-goals')?.value || ''
                };
                localStorage.setItem('userProfile', JSON.stringify(profile));
                // Update sidebar if logged in
                const sidebarUsername = document.getElementById('sidebar-username');
                const sidebarId = document.getElementById('sidebar-id');
                if (sidebarUsername) sidebarUsername.textContent = profile.name;
                if (sidebarId) sidebarId.textContent = profile.id;
                showMessage('Profile saved successfully!');
            });
        }

        // Load profile on init (after login, but for demo)
        const savedProfile = safeParseJSON('userProfile', null);
        if (savedProfile) {
            const pName = document.getElementById('profile-name');
            const pId = document.getElementById('profile-id');
            const pEmail = document.getElementById('profile-email');
            const pCourse = document.getElementById('profile-course');
            const pGoals = document.getElementById('profile-goals');

            if (pName) pName.value = savedProfile.name || 'Rahul Sharma';
            if (pId) pId.value = savedProfile.id || 'CS2021BATCH';
            if (pEmail) pEmail.value = savedProfile.email || 'rahul@college.edu';
            if (pCourse) pCourse.value = savedProfile.course || 'Computer Science';
            if (pGoals) pGoals.value = savedProfile.goals || '';
        }


        // ===== Routine Export =====
        const exportBtn = document.getElementById('exportRoutineBtn');
        if (exportBtn) {
            exportBtn.addEventListener('click', () => {
                const routineText = `Daily Routine - Monday, 18 September 2025
7:00 - Morning Routine (Completed)
9:00 - Data Structures Class (Completed)
10:00 - Algorithms Class (In Progress)
11:00 - Free Period - Suggested Activity (Upcoming)
12:00 - Lunch Break
14:00 - Database Systems Class (Not Started)
16:00 - Free Time - Suggested Activity (Not Started)`;
                const blob = new Blob([routineText], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'daily_routine.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showMessage('Routine exported!');
            });
        }


        // ===== Neon Rescheduler System =====
        /* ===== in-memory ===== */
        let classes = []; // each: {id, name, subjects: [{name, teacher, avg}], timetable: [] }
        let absentTeachers = new Set();
        let periodCount = 6;

        /* ===== DOM refs ===== */
        const classesContainer = document.getElementById('classesContainer');
        const addClassBtn = document.getElementById('addClassBtn');
        const resetBtn = document.getElementById('resetBtn');
        const periodCountInput = document.getElementById('periodCount');
        const timetablesInputs = document.getElementById('timetablesInputs');
        const absentTeacherSelect = document.getElementById('absentTeacherSelect');
        const addAbsentBtn = document.getElementById('addAbsentBtn');
        const absentList = document.getElementById('absentList');
        const previewBtn = document.getElementById('previewBtn');
        const regenBtn = document.getElementById('regenBtn');
        const previewArea = document.getElementById('previewArea');

        const resultView = document.getElementById('resultView');
        const resultTablesContainer = document.getElementById('resultTablesContainer');
        const absentBadge = document.getElementById('absentBadge');
        const backBtn = document.getElementById('backBtn');
        const downloadBtn = document.getElementById('downloadBtn');

        /* Safe Listener Initialization */
        if (addClassBtn) addClassBtn.addEventListener('click', () => addClass());
        if (resetBtn) resetBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to reset everything?')) {
                classes = [];
                absentTeachers = new Set();
                localStorage.removeItem('neon_classes');
                localStorage.removeItem('neon_absent');
                renderClasses();
                refreshAbsentSelect();
                renderTimetableInputs();
            }
        });
        if (addAbsentBtn) addAbsentBtn.addEventListener('click', () => {
            const t = absentTeacherSelect.value;
            if (t && !absentTeachers.has(t)) {
                absentTeachers.add(t);
                refreshAbsentList();
                refreshAbsentSelect();
            }
        });
        if (previewBtn) previewBtn.addEventListener('click', renderPreview);
        if (regenBtn) regenBtn.addEventListener('click', () => {
            const m = regenerateScheduleModel();
            renderResults(m);
            if (resultView) resultView.style.display = 'block';
        });


        /* ===== helpers ===== */
        function uid(prefix = 'id') { return prefix + Math.random().toString(36).slice(2, 9) }
        function clamp(v, min, max) { return Math.max(min, Math.min(max, v)) }
        function escapeHtml(s) { if (s === null || s === undefined) return ''; return ('' + s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[c]) }

        /* ===== Classes CRUD ===== */
        function addClass(initial) {
            const id = uid('c');
            const cls = {
                id,
                name: initial?.name || `Class ${classes.length + 1}`,
                subjects: initial?.subjects || [
                    { name: 'Math', teacher: 'Alice', avg: 50 },
                    { name: 'Science', teacher: 'Bob', avg: 60 }
                ],
                timetable: initial?.timetable || []
            };
            classes.push(cls);
            renderClasses();
            refreshAbsentSelect();
            renderTimetableInputs();
        }

        function removeClass(id) {
            classes = classes.filter(c => c.id !== id);
            renderClasses();
            refreshAbsentSelect();
            renderTimetableInputs();
        }

        function renderClasses() {
            classesContainer.innerHTML = '';
            classes.forEach((c, classIndex) => {
                const card = document.createElement('div');
                card.className = 'class-card';
                card.innerHTML = `
                    <div class="class-title">
                        <div><input class="input" data-bind="name" value="${escapeHtml(c.name)}" /></div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn ghost small" data-remove="${c.id}">Remove</button>
                        </div>
                    </div>
                    <div style="margin-top:10px; font-size:13px; color:var(--muted)">Subjects (teacher + avg %). Add/remove subjects below.</div>
                    <div class="subjects" data-subjects-area="${c.id}"></div>
                    <div style="margin-top:8px">
                        <button class="btn ghost" data-add-sub="${c.id}">+ Add Subject</button>
                    </div>
                `;
                classesContainer.appendChild(card);

                // bind name change
                const nameInput = card.querySelector('[data-bind="name"]');
                nameInput.addEventListener('input', (e) => {
                    c.name = e.target.value;
                    renderTimetableInputs();
                    refreshAbsentSelect();
                });

                // remove button
                card.querySelector('[data-remove]').addEventListener('click', () => removeClass(c.id));

                // render subjects area
                const subjectsArea = card.querySelector(`[data-subjects-area="${c.id}"]`);
                function renderSubjects() {
                    subjectsArea.innerHTML = '';
                    c.subjects.forEach((s, idx) => {
                        const chip = document.createElement('div');
                        chip.className = 'subject-chip';
                        chip.innerHTML = `
                            <div style="display:flex; gap:6px; align-items:center; justify-content:space-between;">
                                <div style="text-align:left; min-width:150px;">
                                    <div style="font-weight:700">${escapeHtml(s.name)}</div>
                                    <small>Teacher: <input class="input" data-teacher data-idx="${idx}" value="${escapeHtml(s.teacher)}" style="width:140px"/></small>
                                    <small style="margin-left:8px">Avg: <input class="input" data-avg data-idx="${idx}" value="${escapeHtml(String(s.avg))}" style="width:80px" /></small>
                                </div>
                                <div>
                                    <button class="btn ghost" data-del-sub="${idx}">✕</button>
                                </div>
                            </div>
                        `;
                        subjectsArea.appendChild(chip);

                        // delete subject (uses latest index by re-rendering)
                        chip.querySelector('[data-del-sub]').addEventListener('click', () => {
                            c.subjects.splice(idx, 1);
                            renderClasses();
                            renderTimetableInputs();
                            refreshAbsentSelect();
                        });

                        // update teacher & avg (use dataset idx so handler remains correct on re-render)
                        const teacherInput = chip.querySelector('[data-teacher]');
                        const avgInput = chip.querySelector('[data-avg]');
                        teacherInput.addEventListener('input', (e) => {
                            const i = Number(e.target.dataset.idx);
                            if (!Number.isNaN(i) && c.subjects[i]) {
                                c.subjects[i].teacher = e.target.value;
                                refreshAbsentSelect();
                            }
                        });
                        avgInput.addEventListener('input', (e) => {
                            const i = Number(e.target.dataset.idx);
                            if (!Number.isNaN(i) && c.subjects[i]) {
                                const v = parseFloat(e.target.value);
                                c.subjects[i].avg = Number.isFinite(v) ? clamp(v, 0, 100) : 0;
                            }
                        });
                    });
                }
                renderSubjects();

                // add subject
                card.querySelector('[data-add-sub]').addEventListener('click', () => {
                    c.subjects.push({ name: `Subject ${c.subjects.length + 1}`, teacher: `T${Math.random().toString(36).slice(2, 5)}`, avg: 50 });
                    renderClasses();
                    renderTimetableInputs();
                    refreshAbsentSelect();
                });
            });
        }

        /* ===== Timetable inputs ===== */
        function renderTimetableInputs() {
            periodCount = Math.max(1, parseInt(periodCountInput.value) || 6);
            timetablesInputs.innerHTML = '';
            classes.forEach(c => {
                // ensure timetable length
                if (!Array.isArray(c.timetable) || c.timetable.length !== periodCount) {
                    c.timetable = Array.from({ length: periodCount }, (_, i) => c.subjects[i]?.name || (c.subjects[0] ? c.subjects[0].name : 'Free'));
                }
                const wrapper = document.createElement('div');
                wrapper.style.minWidth = '320px';
                wrapper.innerHTML = `<div style="font-weight:700; margin-bottom:6px">${escapeHtml(c.name)}</div>
                    <textarea class="input" rows="3" data-timearea="${c.id}">${escapeHtml(c.timetable.join(', '))}</textarea>
                    <div style="font-size:12px; color:var(--muted); margin-top:6px">Use subject names exactly (comma separated). Missing subjects will be left 'Free'.</div>`;
                timetablesInputs.appendChild(wrapper);

                const ta = wrapper.querySelector('[data-timearea]');
                ta.addEventListener('change', () => {
                    const arr = ta.value.split(',').map(s => s.trim()).filter(s => s.length > 0);
                    // fill/trim to periodCount
                    while (arr.length < periodCount) arr.push('Free');
                    c.timetable = arr.slice(0, periodCount);
                    ta.value = c.timetable.join(', ');
                });
            });
        }

        /* ===== Absent UI ===== */
        function refreshAbsentSelect() {
            const teachers = new Set();
            classes.forEach(c => c.subjects.forEach(s => {
                const t = (s.teacher || '').trim();
                if (t) teachers.add(t);
            }));
            const names = Array.from(teachers).sort();
            absentTeacherSelect.innerHTML = '';
            names.forEach(n => {
                const opt = document.createElement('option'); opt.value = n; opt.textContent = n;
                absentTeacherSelect.appendChild(opt);
            });
        }

        function renderAbsentList() {
            absentList.innerHTML = '';
            absentTeachers.forEach(t => {
                const pill = document.createElement('div');
                pill.className = 'subject-chip';
                pill.style.display = 'inline-flex';
                pill.style.gap = '8px';
                pill.innerHTML = `<div style="min-width:120px">${escapeHtml(t)}</div><div><button class="btn ghost" data-remove="${escapeHtml(t)}">Remove</button></div>`;
                absentList.appendChild(pill);
                pill.querySelector('[data-remove]').addEventListener('click', () => {
                    absentTeachers.delete(t);
                    renderAbsentList();
                    absentBadge.textContent = `Absent: ${absentTeachers.size}`;
                });
            });
            absentBadge.textContent = `Absent: ${absentTeachers.size}`;
        }

        /* ===== Preview ===== */
        function renderPreview() {
            previewArea.style.display = 'block';
            previewArea.innerHTML = '';
            if (classes.length === 0) {
                previewArea.innerHTML = '<div style="color:var(--muted)">No classes yet.</div>';
                return;
            }
            const tbl = document.createElement('table');
            tbl.className = 'grid';
            const thead = document.createElement('thead'), tbody = document.createElement('tbody');
            const headRow = document.createElement('tr');
            headRow.innerHTML = `<th>Period</th>` + classes.map(c => `<th>${escapeHtml(c.name)}</th>`).join('');
            thead.appendChild(headRow);

            for (let p = 0; p < periodCount; p++) {
                const tr = document.createElement('tr');
                const periodName = `P${p + 1}`;
                const cols = [`<td>${periodName}</td>`];
                classes.forEach(c => {
                    const subj = c.timetable[p] || 'Free';
                    const subjObj = c.subjects.find(s => s.name === subj);
                    const teacher = subjObj ? subjObj.teacher : '';
                    const teacherClass = absentTeachers.has(teacher) ? 'text-red-400' : ''; // Highlight absent teachers
                    cols.push(`<td>
                        <div>${escapeHtml(subj)}</div>
                        <div class="slot-teacher ${teacherClass}">${escapeHtml(teacher || '')}</div>
                    </td>`);
                });
                tr.innerHTML = cols.join('');
                tbody.appendChild(tr);
            }
            tbl.appendChild(thead); tbl.appendChild(tbody);
            previewArea.appendChild(tbl);
        }

        /* ===== Rescheduling core algorithm ===== */
        function regenerateScheduleModel() {
            // Build teacher map: teacherName -> {teacher, subjects:Set, pairs:[]}
            const teacherMap = new Map();
            classes.forEach(c => {
                c.subjects.forEach(s => {
                    const t = (s.teacher || '').trim();
                    if (!t) return;
                    if (!teacherMap.has(t)) teacherMap.set(t, { teacher: t, subjects: new Set(), pairs: [] });
                    const entry = teacherMap.get(t);
                    entry.subjects.add(s.name);
                    entry.pairs.push({ classId: c.id, className: c.name, subjectName: s.name });
                });
            });

            // absent set (use local copy for consistency)
            const absentSet = new Set(absentTeachers);

            // prepare new schedules (subjects only)
            const newSchedules = {};
            classes.forEach(c => newSchedules[c.id] = c.timetable.slice());

            // teacher occupied per period
            const teacherOccupiedAt = {}; // teacher -> {period:true}

            for (let p = 0; p < periodCount; p++) {
                // build current assignments
                const assignments = classes.map(c => {
                    const subj = c.timetable[p] || 'Free';
                    const subjObj = c.subjects.find(s => s.name === subj);
                    const teacher = subjObj ? subjObj.teacher : '';
                    const present = teacher ? !absentSet.has(teacher) : true;
                    return { classId: c.id, className: c.name, subj, teacher, present, classObj: c };
                });

                // mark occupied teachers (present original assignments)
                assignments.forEach(a => {
                    if (a.teacher && a.present) {
                        teacherOccupiedAt[a.teacher] = teacherOccupiedAt[a.teacher] || {};
                        teacherOccupiedAt[a.teacher][p] = true;
                    }
                });

                // applicants: slots where assigned teacher is absent
                const applicants = assignments.filter(a => !a.present);

                // also gather free slots (optional fill)
                const freeSlots = assignments.filter(a => a.subj === 'Free');

                // build pool of available teachers (present & not occupied this period)
                const availableTeachers = [];
                teacherMap.forEach(info => {
                    const t = info.teacher;
                    if (absentSet.has(t)) return;
                    if (teacherOccupiedAt[t] && teacherOccupiedAt[t][p]) return;
                    availableTeachers.push({ teacher: t, subjects: Array.from(info.subjects) });
                });

                // helper: best teacher for class (returns {teacher, subject, avg} or null)
                function bestTeacherForClass(classObj) {
                    const candidates = [];
                    availableTeachers.forEach(info => {
                        info.subjects.forEach(subj => {
                            const subObj = classObj.subjects.find(ss => ss.name === subj);
                            const avg = subObj ? (Number.isFinite(subObj.avg) ? subObj.avg : 100) : 80;
                            candidates.push({ teacher: info.teacher, subject: subj, avg });
                        });
                    });
                    if (candidates.length === 0) return null;
                    candidates.sort((a, b) => a.avg - b.avg);
                    return candidates[0];
                }

                // compute needs for applicants
                const applicantNeeds = applicants.map(a => {
                    return { applicant: a, best: bestTeacherForClass(a.classObj) };
                });

                // sort applicants by their best.avg ascending (most needy first). nulls go last
                applicantNeeds.sort((A, B) => {
                    const aVal = A.best ? A.best.avg : 1000;
                    const bVal = B.best ? B.best.avg : 1000;
                    return aVal - bVal;
                });

                // assign teachers to applicants
                for (const an of applicantNeeds) {
                    const a = an.applicant;
                    const best = an.best;
                    if (!best) {
                        newSchedules[a.classId][p] = 'Free';
                        continue;
                    }
                    newSchedules[a.classId][p] = best.subject;
                    teacherOccupiedAt[best.teacher] = teacherOccupiedAt[best.teacher] || {};
                    teacherOccupiedAt[best.teacher][p] = true;
                    // remove teacher from available list
                    for (let i = availableTeachers.length - 1; i >= 0; i--) {
                        if (availableTeachers[i].teacher === best.teacher) availableTeachers.splice(i, 1);
                    }
                }

                // try to fill free slots with remaining teachers
                if (availableTeachers.length > 0 && freeSlots.length > 0) {
                    const freeNeeds = freeSlots.map(f => {
                        const classObj = f.classObj;
                        const candidates = [];
                        availableTeachers.forEach(info => {
                            info.subjects.forEach(subj => {
                                const subObj = classObj.subjects.find(ss => ss.name === subj);
                                const avg = subObj ? (Number.isFinite(subObj.avg) ? subObj.avg : 100) : 80;
                                candidates.push({ teacher: info.teacher, subject: subj, avg });
                            });
                        });
                        if (candidates.length === 0) return { free: f, best: null };
                        candidates.sort((a, b) => a.avg - b.avg);
                        return { free: f, best: candidates[0] };
                    });

                    freeNeeds.sort((a, b) => {
                        const av = a.best ? a.best.avg : 1000;
                        const bv = b.best ? b.best.avg : 1000;
                        return av - bv;
                    });

                    for (const fn of freeNeeds) {
                        if (!fn.best) continue;
                        const teacher = fn.best.teacher;
                        const subject = fn.best.subject;
                        newSchedules[fn.free.classId][p] = subject;
                        teacherOccupiedAt[teacher] = teacherOccupiedAt[teacher] || {};
                        teacherOccupiedAt[teacher][p] = true;
                        for (let i = availableTeachers.length - 1; i >= 0; i--) if (availableTeachers[i].teacher === teacher) availableTeachers.splice(i, 1);
                    }
                }

                // any remaining applicants that did not get assignment become Free
                assignments.forEach(a => {
                    if (!a.present && newSchedules[a.classId][p] === a.subj) {
                        newSchedules[a.classId][p] = 'Free';
                    }
                });

            } // end periods

            // convert newSchedules to result structure including chosen teacher name (prefer class's own teacher if available)
            const result = classes.map(c => {
                const arr = newSchedules[c.id].slice();
                const finalArr = arr.map(subj => {
                    if (subj === 'Free') return { subject: 'Free', teacher: '' };
                    // try find the teacher in same class subjects
                    const sObj = c.subjects.find(s => s.name === subj);
                    if (sObj && !absentTeachers.has(sObj.teacher)) return { subject: subj, teacher: sObj.teacher };
                    // otherwise pick any teacher (non-absent) from teacherMap that teaches subj
                    let teacher = '';
                    for (let [t, info] of teacherMap) {
                        if (absentTeachers.has(t)) continue;
                        if (info.subjects.has(subj)) {
                            teacher = t; break;
                        }
                    }
                    return { subject: subj, teacher };
                });
                return { classId: c.id, className: c.name, schedule: finalArr };
            });

            return { result, absentList: Array.from(absentTeachers) };
        }

        /* ===== UI wiring ===== */
        if (addClassBtn) addClassBtn.addEventListener('click', () => addClass());
        if (resetBtn) resetBtn.addEventListener('click', () => {
            if (!confirm('Reset all classes and inputs?')) return;
            classes = [];
            absentTeachers.clear();
            addClass({ name: 'Class 1' });
            addClass({ name: 'Class 2' });
            renderClasses();
            renderTimetableInputs();
            refreshAbsentSelect();
            renderAbsentList();
            if (previewArea) previewArea.style.display = 'none';
        });

        if (periodCountInput) periodCountInput.addEventListener('change', () => renderTimetableInputs());

        if (addAbsentBtn) addAbsentBtn.addEventListener('click', () => {
            if (!absentTeacherSelect) return;
            const t = absentTeacherSelect.value;
            if (!t) return;
            absentTeachers.add(t);
            renderAbsentList();
        });

        if (previewBtn) previewBtn.addEventListener('click', () => renderPreview());

        if (regenBtn) regenBtn.addEventListener('click', () => {
            if (classes.length === 0) { alert('Add at least one class.'); return; }
            const model = regenerateScheduleModel();
            showResult(model);
        });

        // seed data
        addClass({
            name: 'Computer Science A', subjects: [
                { name: 'Math', teacher: 'Alice', avg: 45 },
                { name: 'Algorithms', teacher: 'Eve', avg: 40 },
                { name: 'Databases', teacher: 'Bob', avg: 65 },
            ], timetable: ['Math', 'Algorithms', 'Databases', 'Math', 'Algorithms', 'Free']
        });
        addClass({
            name: 'Computer Science B', subjects: [
                { name: 'Math', teacher: 'Carol', avg: 70 },
                { name: 'Algorithms', teacher: 'Dave', avg: 55 },
                { name: 'Databases', teacher: 'Bob', avg: 60 },
            ], timetable: ['Algorithms', 'Math', 'Databases', 'Math', 'Free', 'Databases']
        });

        refreshAbsentSelect();
        renderAbsentList();
        renderTimetableInputs();

        /* Result rendering */
        function showResult(model) {
            resultView.style.display = 'block';
            absentBadge.textContent = `Absent: ${model.absentList.length}`;
            resultTablesContainer.innerHTML = '';

            const legend = document.createElement('div');
            legend.style.marginBottom = '10px';
            legend.innerHTML = `<div style="color:var(--muted); font-size:13px">Legend: <strong style="color:#fff">Subject</strong> • <span style="color:var(--muted)">Teacher</span></div>`;
            resultTablesContainer.appendChild(legend);

            const { result } = model;
            const periodLabels = Array.from({ length: periodCount }, (_, i) => `P${i + 1}`);

            const bigTable = document.createElement('table'); bigTable.className = 'grid';
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = `<th>Period</th>` + result.map(r => `<th>${escapeHtml(r.className)}</th>`).join('');
            thead.appendChild(headerRow);
            bigTable.appendChild(thead);

            const tbody = document.createElement('tbody');
            for (let p = 0; p < periodCount; p++) {
                const tr = document.createElement('tr');
                const periodName = periodLabels[p];
                let cols = `<td>${periodName}</td>`;
                result.forEach(r => {
                    const cell = r.schedule[p];
                    const subject = escapeHtml(cell.subject);
                    const teacher = escapeHtml(cell.teacher);
                    cols += `<td>
                        <div style="font-weight:700; color: white">${subject === 'Free' ? '<span style="color:var(--muted)">Free</span>' : subject}</div>
                        <div style="font-size:12px; color:var(--muted); margin-top:6px">${teacher || ''}</div>
                    </td>`;
                });
                tr.innerHTML = cols;
                tbody.appendChild(tr);
            }
            bigTable.appendChild(tbody);
            resultTablesContainer.appendChild(bigTable);
        }

        if (backBtn) {
            backBtn.addEventListener('click', () => {
                if (resultView) resultView.style.display = 'none';
            });
        }

        if (downloadBtn) {
            downloadBtn.addEventListener('click', () => {
                const model = regenerateScheduleModel();
                const res = model.result;
                const headers = ['Period', ...res.map(r => r.className)];
                const periodLabels = Array.from({ length: periodCount }, (_, i) => `P${i + 1}`);
                let rows = [headers.join(',')];
                for (let p = 0; p < periodCount; p++) {
                    const row = [periodLabels[p]];
                    for (const r of res) {
                        const s = r.schedule[p];
                        const cell = s.subject + (s.teacher ? ` (${s.teacher})` : '');
                        row.push('"' + cell.replace(/"/g, '""') + '"');
                    }
                    rows.push(row.join(','));
                }
                const csv = rows.join('\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'regenerated_timetable.csv'; document.body.appendChild(a); a.click(); a.remove();
                URL.revokeObjectURL(url);
            });
        }


        // Initialize the application
        // ===== TIMETABLE UPLOAD & EDIT FEATURE =====
        const timetableBody = document.getElementById('timetable-body');
        const timetableContainer = document.getElementById('timetable-container');
        const timetableEmpty = document.getElementById('timetable-empty');

        function getTimetableKey() {
            const u = loggedInUser ? loggedInUser.username : 'default';
            return `timetable_${u}`;
        }

        window.handleTimetableUpload = async function (input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();

            if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    processTimetableData(jsonData);
                };
                reader.readAsArrayBuffer(file);
            } else if (file.name.endsWith('.pdf')) {
                reader.onload = async (e) => {
                    const typedarray = new Uint8Array(e.target.result);
                    try {
                        const loadingTask = pdfjsLib.getDocument(typedarray);
                        const pdf = await loadingTask.promise;
                        let allRows = [];

                        // Extract text from all pages
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            // Naive text extraction: join items with space
                            // A better table extration would require checking Y coordinates
                            // For this specific format (Teacher, Subject, Time) we assume they appear in order
                            const strings = textContent.items.map(item => item.str);

                            // Try to chunk by 3 if logical
                            // This is highly dependent on PDF structure.
                            // We'll treat every 3 non-empty strings as a row as a fallback
                            const nonEmpty = strings.filter(s => s.trim().length > 0);
                            for (let j = 0; j < nonEmpty.length; j += 3) {
                                if (j + 2 < nonEmpty.length) {
                                    allRows.push([nonEmpty[j], nonEmpty[j + 1], nonEmpty[j + 2]]);
                                }
                            }
                        }

                        if (allRows.length === 0) {
                            alert("Could not extract structured data from PDF. Please enter manually.");
                            timetableEmpty.classList.add('hidden');
                            timetableContainer.classList.remove('hidden');
                            addTimetableRow();
                        } else {
                            processTimetableData(allRows);
                        }
                    } catch (err) {
                        console.error(err);
                        alert("Error parsing PDF. Try Excel for better results.");
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        };

        function processTimetableData(rows) {
            if (!rows || rows.length === 0) return;

            // Separate headers from data
            // We assume the first row contains headers as requested
            let headers = [];
            let dataRows = [];

            if (rows.length > 0) {
                headers = rows[0].map(h => String(h).toLowerCase().trim());
                dataRows = rows.slice(1); // Skip the first row
            }

            // Default mapping based on "Teacher, Subject, Time" assumption
            let tIdx = 0;   // Teacher
            let sIdx = 1;   // Subject
            let timeIdx = 2; // Time

            // Attempt to dynamically find columns if headers exist
            if (headers.length > 0) {
                const findIdx = (keywords) => headers.findIndex(h => keywords.some(k => h.includes(k)));

                const foundT = findIdx(['teacher', 'prof', 'faculty', 'name', 'instructor']);
                const foundS = findIdx(['subject', 'course', 'class', 'module']);
                const foundTime = findIdx(['time', 'timing', 'slot', 'lecture', 'period']);

                // Update indices only if found.
                // We trust the finding logic, but fallback to 0,1,2 if headers are completely ambiguous
                if (foundT !== -1) tIdx = foundT;
                if (foundS !== -1) sIdx = foundS;
                if (foundTime !== -1) timeIdx = foundTime;
            }

            const cleanRows = [];

            dataRows.forEach(row => {
                if (!Array.isArray(row) || row.length === 0) return;

                // Extract data using the mapped indices
                // Handle cases where row might be shorter than expected
                let teacher = row[tIdx] !== undefined ? row[tIdx] : '';
                let subject = row[sIdx] !== undefined ? row[sIdx] : '';
                let time = row[timeIdx] !== undefined ? row[timeIdx] : '';

                // Clean up string values
                teacher = String(teacher).trim();
                subject = String(subject).trim();
                time = String(time).trim();

                // Skip completely empty rows
                if (!teacher && !subject && !time) return;

                cleanRows.push({ time, subject, teacher });
            });

            if (cleanRows.length === 0) {
                showMessage("No valid data rows found after skipping headers.");
                return;
            }

            renderTimetable(cleanRows);
            timetableEmpty.classList.add('hidden');
            timetableContainer.classList.remove('hidden');
            showMessage(`Imported ${cleanRows.length} classes (Headers skipped).`);
        }

        function renderTimetable(data) {
            if (!timetableBody) return;
            timetableBody.innerHTML = '';
            data.forEach(row => {
                addTimetableRow(row.time, row.subject, row.teacher);
            });
            if (data.length === 0) addTimetableRow();
        }

        window.addTimetableRow = function (time = '', subject = '', teacher = '') {
            if (!timetableBody) {
                showMessage("Timetable not loaded. Please refresh the page.");
                return;
            }
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-800/50 transition-colors group';
            tr.innerHTML = `
                <td class="p-3"><input type="text" value="${escapeHtml(time)}" placeholder="9:00 AM" class="w-full bg-transparent border border-gray-700 rounded px-2 py-1 text-white focus:border-blue-500 outline-none"></td>
                <td class="p-3"><input type="text" value="${escapeHtml(subject)}" placeholder="Subject" class="w-full bg-transparent border border-gray-700 rounded px-2 py-1 text-white focus:border-blue-500 outline-none"></td>
                <td class="p-3"><input type="text" value="${escapeHtml(teacher)}" placeholder="Prof. Name" class="w-full bg-transparent border border-gray-700 rounded px-2 py-1 text-white focus:border-blue-500 outline-none"></td>
                <td class="p-3 text-right">
                    <button onclick="this.closest('tr').remove()" class="text-red-400 hover:text-red-300 opacity-0 group-hover:opacity-100 transition-opacity p-2">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
             `;
            timetableBody.appendChild(tr);
        };

        window.saveTimetableComp = function (data = null) {
            if (!timetableBody) {
                showMessage("Timetable not loaded. Please refresh the page.");
                return;
            }
           
            let saveData = data;
            if (!saveData) {
                saveData = [];
                timetableBody.querySelectorAll('tr').forEach(tr => {
                    const inputs = tr.querySelectorAll('input');
                    if (inputs.length >= 3) {
                        saveData.push({
                            time: inputs[0].value,
                            subject: inputs[1].value,
                            teacher: inputs[2].value
                        });
                    }
                });
            }
            if (loggedInUser) {
                localStorage.setItem(getTimetableKey(), JSON.stringify(saveData));
                showMessage("Timetable saved for " + loggedInUser.username + "!");
            } else {
                showMessage("Please log in to save permanently.");
            }

            if (saveData.length > 0) {
                if (timetableEmpty) timetableEmpty.classList.add('hidden');
                if (timetableContainer) timetableContainer.classList.remove('hidden');
            }
        };

        // Convert batch timetable format to display format
        function convertBatchTimetableToDisplay(batchTimetable) {
            const scheduleData = [];
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const timeSlots = [];
            for (let hour = 8; hour <= 18; hour++) {
                timeSlots.push(`${hour.toString().padStart(2, '0')}:00`);
            }
           
            // Group by time slot
            timeSlots.forEach(time => {
                days.forEach(day => {
                    const key = `${day}_${time}`;
                    const value = batchTimetable[key] || '';
                    if (value) {
                        // Parse value (format: "Subject/Teacher" or just "Subject")
                        const parts = value.split('/');
                        const subject = parts[0] || value;
                        const teacher = parts[1] || '';
                        scheduleData.push({ time, subject, teacher });
                    }
                });
            });
           
            return scheduleData;
        }

        // Render week-wise student timetable
        function renderStudentWeekTimetable(timetable) {
            const tbody = document.getElementById('student-timetable-body');
            if (!tbody) return;

            // Always get fresh timetable data from localStorage
            if (loggedInUser && registeredUsers[loggedInUser.username]) {
                const userData = registeredUsers[loggedInUser.username];
                const batchId = userData.batchId;
                if (batchId) {
                    const batches = safeParseJSON('spark_batches', []);
                    const batch = Array.isArray(batches) ? batches.find(b => b && b.id === batchId) : null;
                    if (batch && batch.timetable) {
                        timetable = batch.timetable; // Use fresh data
                    }
                }
            }

            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
           
            // Get time slots from timetable data (same logic as admin/teacher)
            const timeSlotsSet = new Set();
           
            Object.keys(timetable || {}).forEach(key => {
                const parts = key.split('_');
                if (parts.length >= 2 && days.includes(parts[0])) {
                    if (parts.length === 3 && parts[2] === 'room') {
                        const time = parts[1];
                        if (time) timeSlotsSet.add(time);
                    } else if (parts.length === 2) {
                        const time = parts[1];
                        if (time) timeSlotsSet.add(time);
                    }
                }
            });

            // Convert to sorted array (sort by time value)
            let timeSlots = Array.from(timeSlotsSet).sort((a, b) => {
                const timeToMinutes = (timeStr) => {
                    const [hours, minutes] = timeStr.split(':').map(Number);
                    return (hours || 0) * 60 + (minutes || 0);
                };
                return timeToMinutes(a) - timeToMinutes(b);
            });
           
            // If no time slots exist, show default time slots (8 AM to 6 PM) for initial setup
            if (timeSlots.length === 0) {
                for (let hour = 8; hour <= 18; hour++) {
                    timeSlots.push(`${hour.toString().padStart(2, '0')}:00`);
                }
            }
           
            // Get current date and time
            const now = new Date();
            const currentDay = now.getDay(); // 0 = Sunday, 1 = Monday, etc.
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const currentTime = currentHour * 60 + currentMinute; // Time in minutes
           
            // Map JavaScript day (0-6) to our day index (Monday = 0)
            const dayIndexMap = { 1: 0, 2: 1, 3: 2, 4: 3, 5: 4, 6: 5, 0: -1 }; // Sunday = -1 (not in our week)
            const currentDayIndex = dayIndexMap[currentDay];

            tbody.innerHTML = timeSlots.map(time => {
                const [hourStr, minuteStr] = time.split(':');
                const hour = parseInt(hourStr) || 0;
                const minute = parseInt(minuteStr) || 0;
                const slotTime = hour * 60 + minute; // Time in minutes
               
                return `
                    <tr>
                        <td class="p-3 border border-gray-700 text-gray-300 font-semibold bg-gray-800 align-top">${time}</td>
                        ${days.map((day, dayIdx) => {
                            const key = `${day}_${time}`;
                            const roomKey = `${day}_${time}_room`;
                            const value = timetable[key] || '';
                            const roomValue = timetable[roomKey] || '';
                           
                            // Determine class status
                            let statusClass = 'bg-gray-700/30'; // Default (completed/past)
                            let statusText = '';
                           
                            if (value) {
                                // Check if this is today
                                if (currentDayIndex === dayIdx) {
                                    // Check if class is current (within this hour)
                                    if (hour === currentHour) {
                                        statusClass = 'bg-green-600/40 border-2 border-green-500';
                                        statusText = '<span class="text-xs text-green-300 font-semibold">Current</span>';
                                    }
                                    // Check if class is upcoming today
                                    else if (hour > currentHour || (hour === currentHour && currentMinute < 30)) {
                                        statusClass = 'bg-blue-600/40 border-2 border-blue-500';
                                        statusText = '<span class="text-xs text-blue-300 font-semibold">Upcoming</span>';
                                    }
                                }
                                // Check if this is a future day
                                else if (currentDayIndex !== -1 && dayIdx > currentDayIndex) {
                                    statusClass = 'bg-blue-600/40 border-2 border-blue-500';
                                    statusText = '<span class="text-xs text-blue-300 font-semibold">Upcoming</span>';
                                }
                                // If it's Sunday and we're showing Monday-Saturday, all are upcoming
                                else if (currentDayIndex === -1) {
                                    statusClass = 'bg-blue-600/40 border-2 border-blue-500';
                                    statusText = '<span class="text-xs text-blue-300 font-semibold">Upcoming</span>';
                                }
                            }
                           
                            return `
                                <td class="p-2 border border-gray-700 align-top ${statusClass}">
                                    ${value ? `
                                        <div class="space-y-1">
                                            <div class="font-medium text-white text-sm">${escapeHtml(value)}</div>
                                            ${roomValue ? `<div class="text-xs text-gray-400">Room: ${escapeHtml(roomValue)}</div>` : ''}
                                            ${statusText}
                                        </div>
                                    ` : '<div class="text-gray-600 text-sm">-</div>'}
                                </td>
                            `;
                        }).join('')}
                    </tr>
                `;
            }).join('');
        }

        // Update real-time clock
        function updateTimetableClock() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
           
            const dateEl = document.getElementById('timetable-current-date');
            const timeEl = document.getElementById('timetable-current-time');
           
            if (dateEl) dateEl.textContent = dateStr;
            if (timeEl) timeEl.textContent = timeStr;
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Start clock update interval (every 5 seconds is sufficient for display)
        setInterval(updateTimetableClock, 5000);
        updateTimetableClock();
       
        // Auto-refresh timetable status every minute
        setInterval(() => {
            if (loggedInUser && registeredUsers[loggedInUser.username]) {
                const userData = registeredUsers[loggedInUser.username];
                const batchId = userData.batchId;
                if (batchId) {
                    const batches = safeParseJSON('spark_batches', []);
                    const batch = Array.isArray(batches) ? batches.find(b => b && b.id === batchId) : null;
                    if (batch && batch.timetable && document.getElementById('student-timetable-body')) {
                        renderStudentWeekTimetable(batch.timetable);
                    }
                }
            }
        }, 60000); // Refresh every minute

        function loadCompTimetable() {
            // Load batch-based timetable for student - always get fresh data from localStorage
            if (loggedInUser && registeredUsers[loggedInUser.username]) {
                // Refresh user data from localStorage to get latest batchId
                const allUsers = safeParseJSON('registeredUsers', {});
                const userData = allUsers[loggedInUser.username] || registeredUsers[loggedInUser.username];
                const batchId = userData.batchId;
               
                if (batchId) {
                    // Always get fresh batches data from localStorage
                    const batches = safeParseJSON('spark_batches', []);
                    const batch = Array.isArray(batches) ? batches.find(b => b && b.id === batchId) : null;
                   
                    if (batch && batch.timetable && Object.keys(batch.timetable).length > 0) {
                        renderStudentWeekTimetable(batch.timetable);
                        timetableEmpty.classList.add('hidden');
                        timetableContainer.classList.remove('hidden');
                        updateTimetableClock();
                        return;
                    }
                }
            }
           
            // Show empty state if no timetable
            timetableEmpty.classList.remove('hidden');
            timetableContainer.classList.add('hidden');
        }

        // ===== Dashboard Tab Functionality =====
        let currentTab = 'dashboard-home';

        // Clock functionality
        function updateClock() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

            const dateEl = document.getElementById('current-date-display');
            const timeEl = document.getElementById('current-time-display');

            if (dateEl) dateEl.textContent = dateStr;
            if (timeEl) timeEl.textContent = timeStr;
        }
        // Update clock every 5 seconds (sufficient for display purposes)
        setInterval(updateClock, 5000);
        updateClock();

        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.getAttribute('data-tab');
                if (tabId !== currentTab) {
                    if (currentTab === 'attendance') {
                        if (videoAttendance.srcObject) {
                            videoAttendance.srcObject.getTracks().forEach(t => t.stop());
                            videoAttendance.pause();
                        }
                        if (attendanceInterval) clearInterval(attendanceInterval);
                        isVideoAttendancePlaying = false;
                        markAttendanceBtn.disabled = true;
                    }
                    currentTab = tabId;
                    localStorage.setItem('spark_current_tab', currentTab); // Save tab state
                   
                    // Load timetable when timetable tab is opened
                    if (tabId === 'timetable') {
                        loadCompTimetable();
                    }
                }

                // Deactivate all tabs
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    if (btn.classList.contains('text-blue-400')) {
                        btn.classList.remove('text-blue-400', 'bg-blue-900/50', 'border', 'border-blue-500/20');
                    }
                    btn.classList.add('text-gray-400');
                    // Reset mobile/desktop specific styles
                    btn.classList.remove('bg-blue-900', 'border-b-2', 'border-blue-400');
                });

                // Activate clicked tab
                if (button.classList.contains('text-gray-400')) {
                    button.classList.remove('text-gray-400');
                }
                button.classList.add('text-blue-400');

                // For mobile tabs with border
                if (button.classList.contains('border-b-2') || button.parentElement.classList.contains('overflow-x-auto')) {
                    // Basic check for mobile nav
                    button.classList.add('border-b-2', 'border-blue-400');
                } else {
                    // Desktop sidebar style
                    button.classList.add('bg-blue-900/50', 'border', 'border-blue-500/20');
                }

                // Hide all tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });

                // Show selected tab content
                const targetContent = document.getElementById(tabId);
                if (targetContent) targetContent.classList.add('active');

                // Start attendance video when attendance tab is opened
                if (tabId === 'attendance' && loggedInUser && videoAttendance && canvasAttendance) {
                    // Check if portal is open before starting video
                    const activePortalBatchId = localStorage.getItem('spark_active_attendance_portal');
                    if (activePortalBatchId) {
                        startVideo(videoAttendance, canvasAttendance, 'attendance');
                    }
                }

                // Load timetable when timetable tab is opened
                if (tabId === 'timetable') {
                    loadCompTimetable();
                }

                // Load study materials when study-material tab is opened
                if (tabId === 'study-material') {
                    if (typeof loadStudentStudyMaterials === 'function') {
                        loadStudentStudyMaterials();
                    }
                }

                if (tabId === 'attendance' && loggedInUser) {
                    // Check attendance lock status and portal availability
                    if (typeof checkAttendanceLock === 'function') {
                        checkAttendanceLock();
                    }
                    // Start video for attendance
                    startVideo(videoAttendance, canvasAttendance, 'attendance');
                }
            });
        });

        // ===== Session Persistence & Tab State =====
        const saveSession = (user) => {
            localStorage.setItem('spark_session_user', JSON.stringify(user));
        };

        const clearSession = () => {
            localStorage.removeItem('spark_session_user');
            localStorage.removeItem('spark_current_tab');
            localStorage.removeItem('spark_role');
            localStorage.removeItem('spark_admin_active');
        };

        const restoreSession = () => {
            // Restore Role First
            const isAdminActive = localStorage.getItem('spark_admin_active') === 'true';
            if (isAdminActive) {
                enterAdminPortal();
                const savedAdminTab = localStorage.getItem('spark_admin_tab') || 'admin-data';
                const tabBtn = document.querySelector(`.tab-btn-admin[data-tab="${savedAdminTab}"]`);
                if (tabBtn) tabBtn.click();
                return;
            }

            const isTeacherActive = localStorage.getItem('spark_teacher_active') === 'true';
            if (isTeacherActive) {
                enterTeacherPortal();
                const savedTeacherTab = localStorage.getItem('spark_teacher_tab') || 'teacher-attendance';
                const tabBtn = document.querySelector(`.tab-btn-teacher[data-tab="${savedTeacherTab}"]`);
                if (tabBtn) tabBtn.click();
                return;
            }

            const savedUser = localStorage.getItem('spark_session_user');
            if (savedUser) {
                try {
                    loggedInUser = JSON.parse(savedUser);
                    // Update UI safely
                    const navUser = document.getElementById('nav-username');
                    if (navUser) navUser.textContent = loggedInUser.username;

                    const bannerUser = document.querySelector('.banner-username');
                    if (bannerUser) bannerUser.textContent = loggedInUser.name || loggedInUser.username;

                    const navClass = document.getElementById('nav-class');
                    if (navClass) navClass.textContent = loggedInUser.studentClass || 'Student';

                    // Show Main App
                    toggleMainApp(true);

                    // Restore Tab
                    const savedTab = localStorage.getItem('spark_current_tab') || 'dashboard-home';
                    const tabBtn = document.querySelector(`.tab-btn[data-tab="${savedTab}"]`);
                    if (tabBtn) tabBtn.click();

                    // Initialize Data
                    updateDashboardStats();
                    renderRecentActivity();
                    checkAttendanceLock();
                    loadCompTimetable();
                    populateProfileData();
                    updateDashboardProfile();

                } catch (e) {
                    console.error("Session restore failed", e);
                    clearSession();
                }
            } else {
                toggleMainApp(false);
                const roleSelection = document.getElementById('role-selection');
                if (roleSelection) roleSelection.classList.remove('hidden');
                if (studentAuth) studentAuth.classList.add('hidden');
                const authScreens = document.getElementById('auth-screens');
                if (authScreens) authScreens.classList.remove('hidden');
            }
        };

        // Generic Form Persistence
        const saveFormState = () => {
            const inputs = document.querySelectorAll('input, select, textarea');
            const data = {};
            inputs.forEach(input => {
                if (input.id) data[input.id] = input.value;
            });
            localStorage.setItem('spark_form_data', JSON.stringify(data));
        };

        const restoreFormState = () => {
            const saved = localStorage.getItem('spark_form_data');
            if (saved) {
                const data = JSON.parse(saved);
                Object.keys(data).forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = data[id];
                });
            }
        };

        document.addEventListener('input', saveFormState);
        document.addEventListener('change', saveFormState);

        // Populate Profile Data from Registration
        const populateProfileData = () => {
            if (!loggedInUser) return;
            const userData = registeredUsers[loggedInUser.username] || {};

            const fields = {
                'profile-name': userData.name || '',
                'profile-id': userData.id || '',
                'profile-email': userData.email || '',
                'profile-course': userData.course || '',
                'profile-batch': userData.batchId || '',
                'profile-goals': userData.goals || ''
            };

            for (const [id, val] of Object.entries(fields)) {
                const el = document.getElementById(id);
                if (el) el.value = val;
            }
           
            // Populate batch dropdown
            populateStudentBatchDropdown();
           
            // Load profile photo
            loadProfilePhoto();
           
            // Load skills
            loadSkills();
        };
       
        // ===== SKILLS MANAGEMENT =====
       
        // Load skills from user data
        function loadSkills() {
            if (!loggedInUser) return;
            const userData = registeredUsers[loggedInUser.username] || {};
            let skills = userData.skills;
           
            // Initialize default skills if none exist
            if (!skills || skills.length === 0) {
                skills = [];
                userData.skills = skills;
                registeredUsers[loggedInUser.username] = userData;
                localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
            }
           
            const container = document.getElementById('skills-container');
            if (!container) return;
           
            container.innerHTML = skills.map((skill, index) => `
                <span class="bg-blue-900 text-blue-200 px-3 py-1 rounded-full text-sm flex items-center gap-2">
                    ${skill}
                    <button onclick="removeSkill(${index})" class="text-blue-300 hover:text-red-300 text-xs">
                        <i class="fas fa-times"></i>
                    </button>
                </span>
            `).join('');
        }
       
        // Add new skill
        window.addSkill = function () {
            const input = document.getElementById('new-skill-input');
            if (!input || !loggedInUser) return;
           
            const skill = input.value.trim();
            if (!skill) {
                showMessage("Please enter a skill");
                return;
            }
           
            const userData = registeredUsers[loggedInUser.username] || {};
            if (!userData.skills) userData.skills = [];
           
            if (userData.skills.includes(skill)) {
                showMessage("Skill already added");
                return;
            }
           
            userData.skills.push(skill);
            registeredUsers[loggedInUser.username] = userData;
            localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
           
            input.value = '';
            loadSkills();
            showMessage("Skill added successfully");
        };
       
        // Remove skill
        window.removeSkill = function (index) {
            if (!loggedInUser) return;
           
            const userData = registeredUsers[loggedInUser.username] || {};
            if (!userData.skills) return;
           
            userData.skills.splice(index, 1);
            registeredUsers[loggedInUser.username] = userData;
            localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
           
            loadSkills();
            showMessage("Skill removed");
        };
       
        // ===== PROFILE PHOTO MANAGEMENT =====
       
        // Handle profile photo change
        window.handleProfilePhotoChange = function (event) {
            const file = event.target.files[0];
            if (!file) return;
           
            if (!file.type.startsWith('image/')) {
                showMessage("Please select an image file");
                return;
            }
           
            const reader = new FileReader();
            reader.onload = function(e) {
                const photoData = e.target.result;
               
                // Update profile photo display
                const profileImg = document.getElementById('profile-photo-img');
                if (profileImg) profileImg.src = photoData;
               
                // Update dashboard photo
                const dashboardImg = document.getElementById('dashboard-profile-photo');
                if (dashboardImg) dashboardImg.src = photoData;
               
                // Save to user data
                if (loggedInUser && registeredUsers[loggedInUser.username]) {
                    registeredUsers[loggedInUser.username].profilePhoto = photoData;
                    localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
                    showMessage("Profile photo updated successfully");
                }
            };
            reader.readAsDataURL(file);
        };
       
        // Load profile photo
        function loadProfilePhoto() {
            if (!loggedInUser) return;
            const userData = registeredUsers[loggedInUser.username] || {};
            const photoData = userData.profilePhoto;
           
            if (photoData) {
                const profileImg = document.getElementById('profile-photo-img');
                if (profileImg) profileImg.src = photoData;
               
                const dashboardImg = document.getElementById('dashboard-profile-photo');
                if (dashboardImg) dashboardImg.src = photoData;
            }
        };
       
        // ===== DASHBOARD PROFILE UPDATE =====
       
        // Update dashboard with profile info
        function updateDashboardProfile() {
            if (!loggedInUser) return;
            const userData = registeredUsers[loggedInUser.username] || {};
           
            // Check email-to-name mapping (admin may have updated it)
            const emailToNameMap = safeParseJSON('spark_email_name_map', {});
            let displayName = userData.name || loggedInUser.username;
            if (userData.email && emailToNameMap[userData.email]) {
                displayName = emailToNameMap[userData.email];
                // Update userData if name changed
                if (userData.name !== displayName) {
                    userData.name = displayName;
                    registeredUsers[loggedInUser.username] = userData;
                    localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
                    loggedInUser.name = displayName;
                    saveSession(loggedInUser);
                }
            }
           
            // Update name
            const bannerUser = document.querySelector('.banner-username');
            if (bannerUser) bannerUser.textContent = displayName;
           
            // Update sidebar name
            const sidebarName = document.getElementById('sidebar-username');
            if (sidebarName) sidebarName.textContent = displayName;
           
            // Update sidebar ID
            const sidebarId = document.getElementById('sidebar-id');
            if (sidebarId) sidebarId.textContent = userData.id || loggedInUser.id || 'N/A';
           
            // Update batch info
            const batchInfo = document.getElementById('dashboard-batch-info');
            if (batchInfo) {
                if (userData.batchId) {
                    const batches = safeParseJSON('spark_batches', []);
                    const batch = batches.find(b => b.id === userData.batchId);
                    if (batch) {
                        batchInfo.textContent = `Batch: ${batch.name}`;
                    } else {
                        batchInfo.textContent = 'Batch: Not selected';
                    }
                } else {
                    batchInfo.textContent = 'Batch: Not selected';
                }
            }
           
            // Update sidebar batch
            const sidebarBatch = document.getElementById('sidebar-batch');
            if (sidebarBatch) {
                if (userData.batchId) {
                    const batches = safeParseJSON('spark_batches', []);
                    const batch = batches.find(b => b.id === userData.batchId);
                    if (batch) {
                        sidebarBatch.textContent = `Batch: ${batch.name}`;
                    } else {
                        sidebarBatch.textContent = 'Batch: -';
                    }
                } else {
                    sidebarBatch.textContent = 'Batch: -';
                }
            }
           
            // Update sidebar photo
            const sidebarImg = document.getElementById('sidebar-profile-photo');
            if (sidebarImg && userData.profilePhoto) {
                sidebarImg.src = userData.profilePhoto;
            }
           
            // Update navbar photo
            const navImg = document.getElementById('nav-profile-photo');
            if (navImg && userData.profilePhoto) {
                navImg.src = userData.profilePhoto;
            }
        };
       
        // Populate student batch dropdown
        function populateStudentBatchDropdown() {
            const batchSelect = document.getElementById('profile-batch');
            if (!batchSelect) return;
           
            const batches = safeParseJSON('spark_batches', []);
            const userData = loggedInUser ? registeredUsers[loggedInUser.username] : {};
            const currentBatchId = userData.batchId || '';
           
            batchSelect.innerHTML = '<option value="">Select your batch</option>';
            batches.forEach(batch => {
                const option = document.createElement('option');
                option.value = batch.id;
                option.textContent = batch.name;
                if (batch.id === currentBatchId) option.selected = true;
                batchSelect.appendChild(option);
            });
        }
       
        // Update student batch
        window.updateStudentBatch = function () {
            if (!loggedInUser) return;
            const batchSelect = document.getElementById('profile-batch');
            const emailInput = document.getElementById('profile-email');
           
            if (!batchSelect || !emailInput) return;
           
            const batchId = batchSelect.value;
            const email = emailInput.value.trim().toLowerCase();
           
            if (!email || !email.includes('@')) {
                showMessage("Please enter a valid email address first");
                return;
            }
           
            const batches = safeParseJSON('spark_batches', []);
            const emailToBatchMap = safeParseJSON('spark_email_batch_map', {});
           
            // Remove from old batch if exists
            if (emailToBatchMap[email] && emailToBatchMap[email] !== batchId) {
                const oldBatch = batches.find(b => b.id === emailToBatchMap[email]);
                if (oldBatch) {
                    oldBatch.students = oldBatch.students.filter(e => e !== email);
                }
            }
           
            // Add to new batch
            if (batchId) {
                const batch = batches.find(b => b.id === batchId);
                if (batch && !batch.students.includes(email)) {
                    batch.students.push(email);
                    emailToBatchMap[email] = batchId;
                }
            } else {
                delete emailToBatchMap[email];
            }
           
            // Update user data
            if (registeredUsers[loggedInUser.username]) {
                registeredUsers[loggedInUser.username].batchId = batchId;
                localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
            }
           
            localStorage.setItem('spark_batches', JSON.stringify(batches));
            localStorage.setItem('spark_email_batch_map', JSON.stringify(emailToBatchMap));
           
            showMessage("Batch updated successfully");
        };

        // Save Profile Logic
        const saveProfileBtn = document.getElementById('saveProfileBtn');
        if (saveProfileBtn) {
            saveProfileBtn.onclick = () => {
                if (!loggedInUser) return;

                const userData = registeredUsers[loggedInUser.username] || {};
                const updatedData = {
                    ...userData,
                    name: document.getElementById('profile-name').value,
                    id: document.getElementById('profile-id').value,
                    email: document.getElementById('profile-email').value,
                    course: document.getElementById('profile-course').value,
                    batchId: document.getElementById('profile-batch').value,
                    goals: document.getElementById('profile-goals')?.value || '',
                    skills: userData.skills || [],
                    profilePhoto: userData.profilePhoto || ''
                };
               
                // Update batch assignment if email changed
                const oldEmail = userData.email;
                const newEmail = updatedData.email.toLowerCase();
                if (oldEmail && oldEmail !== newEmail && updatedData.batchId) {
                    updateStudentBatch();
                }
               
                registeredUsers[loggedInUser.username] = updatedData;
                localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
               
                // Update dashboard
                updateDashboardProfile();
               
                showMessage("Profile saved successfully!");

                registeredUsers[loggedInUser.username] = {
                    ...registeredUsers[loggedInUser.username],
                    ...updatedData
                };

                localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
                loggedInUser = { ...loggedInUser, ...updatedData };
                saveSession(loggedInUser);

                // Update UI safely
                const navUser = document.getElementById('nav-username');
                if (navUser) navUser.textContent = loggedInUser.name;

                const sideUser = document.getElementById('sidebar-username');
                if (sideUser) sideUser.textContent = loggedInUser.name;

                const sideId = document.getElementById('sidebar-id');
                if (sideId) sideId.textContent = loggedInUser.id;

                const bannerUser = document.querySelector('.banner-username');
                if (bannerUser) bannerUser.textContent = loggedInUser.name;

                const sidebarName = document.getElementById('sidebar-username');
                if (sidebarName) sidebarName.textContent = loggedInUser.name;

                const sidebarId = document.getElementById('sidebar-id');
                if (sidebarId) sidebarId.textContent = loggedInUser.id;


                updateDashboardStats();
                showMessage("Profile updated successfully!");
            };
        }


        // ===== TEACHER PORTAL LOGIC =====


        window.toggleAttendancePortal = function (isOpen) {
            const batchSelect = document.getElementById('teacher-portal-batch-select');
            const selectedBatchId = batchSelect?.value || '';
           
            if (isOpen && !selectedBatchId) {
                showMessage("Please select a batch first.");
                return;
            }
           
            const batches = safeParseJSON('spark_batches', []);
            const selectedBatch = batches.find(b => b.id === selectedBatchId);
            const batchName = selectedBatch ? selectedBatch.name : '';
           
            const badge = document.getElementById('attendance-portal-status-badge');
            const btnOpen = document.getElementById('btn-open-portal');
            const btnClose = document.getElementById('btn-close-portal');
            const info = document.getElementById('portal-active-info');
            const infoName = document.getElementById('active-portal-name');

            if (isOpen) {
                // Store batch ID in localStorage
                localStorage.setItem('spark_active_attendance_portal', selectedBatchId);
                localStorage.setItem('spark_active_attendance_portal_name', batchName);
               
                if (badge) {
                    badge.textContent = "OPEN";
                    badge.classList.remove('bg-red-900/40', 'text-red-400', 'border-red-900/50');
                    badge.classList.add('bg-green-900/40', 'text-green-400', 'border-green-900/50');
                }
                if (btnOpen) btnOpen.classList.add('hidden');
                if (btnClose) btnClose.classList.remove('hidden');
                if (info) info.classList.remove('hidden');
                if (infoName) infoName.textContent = batchName;
                showMessage(`Attendance portal opened for ${batchName}`);
               
                // Update student overview immediately when portal opens
                updateTeacherStudentOverview();
            } else {
                localStorage.removeItem('spark_active_attendance_portal');
                localStorage.removeItem('spark_active_attendance_portal_name');
               
                if (badge) {
                    badge.textContent = "CLOSED";
                    badge.classList.add('bg-red-900/40', 'text-red-400', 'border-red-900/50');
                    badge.classList.remove('bg-green-900/40', 'text-green-400', 'border-green-900/50');
                }
                if (btnOpen) btnOpen.classList.remove('hidden');
                if (btnClose) btnClose.classList.add('hidden');
                if (info) info.classList.add('hidden');
                showMessage("Attendance portal closed.");
                updateTeacherStudentOverview(); // Update on close
            }
            updateTeacherStudentOverview(); // Update immediately
        };

        // Update Teacher Student Overview Table
        window.updateTeacherStudentOverview = function () {
            const tbody = document.getElementById('teacher-student-overview-tbody');
            if (!tbody) return;

            const activePortalBatchId = localStorage.getItem('spark_active_attendance_portal');
            const batchSelect = document.getElementById('teacher-portal-batch-select');
            const selectedBatchId = batchSelect?.value || '';

            if (!activePortalBatchId || activePortalBatchId !== selectedBatchId) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center italic">Open portal to view live attendance</td></tr>';
                return;
            }

            // Get the batch to find its students
            const batches = safeParseJSON('spark_batches', []);
            const batch = batches.find(b => b.id === activePortalBatchId);
           
            if (!batch) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center italic">Batch not found</td></tr>';
                return;
            }

            // Get attendance log
            const log = safeParseJSON('spark_attendance_log', []);

            // Filter for current portal session (last 2 hours) and batch students
            const twoHoursAgo = Date.now() - (2 * 60 * 60 * 1000);
            const batchStudentEmails = batch.students || [];
            const batchName = batch.name || '';
           
            const recentLog = log.filter(entry => {
                // Check timestamp first
                if (!entry.timestamp || entry.timestamp <= twoHoursAgo) {
                    return false;
                }
               
                // Check if entry is for this batch (by batchId or className matching batch name)
                const isForThisBatch = (entry.batchId === activePortalBatchId) ||
                                      (entry.className === batchName && !entry.batchId);
               
                if (!isForThisBatch) {
                    return false;
                }
               
                // Get student data from registeredUsers
                if (!entry.student || !registeredUsers[entry.student]) {
                    return false;
                }
               
                const userData = registeredUsers[entry.student];
                const studentEmail = userData.email?.toLowerCase() || '';
               
                // Check if student email is in the batch's students array
                if (studentEmail && batchStudentEmails.includes(studentEmail)) {
                    return true;
                }
               
                return false;
            });

            // Get unique students who attended
            const studentsMap = new Map();
            recentLog.forEach(entry => {
                if (entry.student && !studentsMap.has(entry.student)) {
                    studentsMap.set(entry.student, entry);
                }
            });

            if (studentsMap.size === 0) {
                const batchName = batch.name || 'selected batch';
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="p-4 text-center">
                            <div class="flex flex-col items-center gap-2 py-4">
                                <i class="fas fa-users text-3xl text-gray-600"></i>
                                <p class="text-gray-400">Waiting for students to mark attendance...</p>
                                <p class="text-xs text-gray-500">Portal is LIVE for ${batchName}</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            // Build table rows
            let html = '';
            let index = 1;
            studentsMap.forEach((entry, studentName) => {
                const userData = registeredUsers[studentName] || {};
                const rollNo = userData.id || `STU-${index}`;
                const timeAgo = getTimeAgo(entry.timestamp);

                html += `
                    <tr class="hover:bg-gray-700/30 transition">
                        <td class="p-3 font-mono text-blue-400">${rollNo}</td>
                        <td class="p-3 font-medium text-white">${studentName}</td>
                        <td class="p-3">
                            <span class="px-2 py-1 bg-green-900/40 text-green-400 text-xs rounded-full border border-green-900/50">
                                <i class="fas fa-check-circle mr-1"></i>Present
                            </span>
                        </td>
                        <td class="p-3 text-right text-gray-400">${timeAgo}</td>
                    </tr>
                `;
                index++;
            });

            tbody.innerHTML = html;
        };

        // Helper function to get time ago
        function getTimeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            if (seconds < 60) return 'Just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            return `${hours}h ago`;
        }

        // Auto-refresh student overview every 5 seconds when portal is open (reduced frequency)
        setInterval(() => {
            const activePortal = localStorage.getItem('spark_active_attendance_portal');
            if (activePortal) {
                updateTeacherStudentOverview();
            }
        }, 5000);

        // Populate analysis batch select
        function populateAnalysisBatchSelect() {
            const batchSelect = document.getElementById('teacher-analysis-batch-select');
            if (!batchSelect) return;
           
            const batches = safeParseJSON('spark_batches', []);
            batchSelect.innerHTML = '<option value="">All Batches</option>';
            batches.forEach(batch => {
                const option = document.createElement('option');
                option.value = batch.id;
                option.textContent = batch.name;
                batchSelect.appendChild(option);
            });
        }

        // Toggle between Overview and Analysis
        window.toggleTeacherAnalysis = function (showAnalysis) {
            const overviewSec = document.getElementById('teacher-student-overview-section');
            const analysisSec = document.getElementById('teacher-attendance-analysis-section');
            const analysisBtn = document.getElementById('teacher-btn-analysis');

            if (showAnalysis) {
                overviewSec.classList.add('hidden');
                analysisSec.classList.remove('hidden');
                analysisBtn.classList.add('ring-2', 'ring-amber-500');

                // Populate batch select
                populateAnalysisBatchSelect();

                // Set default date to today
                const dateInput = document.getElementById('teacher-analysis-date');
                if (dateInput && !dateInput.value) {
                    dateInput.value = new Date().toISOString().split('T')[0];
                }
                renderAttendanceAnalysis();
            } else {
                overviewSec.classList.remove('hidden');
                analysisSec.classList.add('hidden');
                analysisBtn.classList.remove('ring-2', 'ring-amber-500');
            }
        };

        // Render Attendance Analysis Table
        window.renderAttendanceAnalysis = function () {
            const tbody = document.getElementById('teacher-analysis-tbody');
            const dateInput = document.getElementById('teacher-analysis-date');
            const batchSelect = document.getElementById('teacher-analysis-batch-select');
            if (!tbody || !dateInput) return;

            const selectedDate = dateInput.value;
            const selectedBatchId = batchSelect?.value || '';
           
            if (!selectedDate) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center italic text-gray-500">Please select a date</td></tr>';
                return;
            }

            const log = safeParseJSON('spark_attendance_log', []);
            const batches = safeParseJSON('spark_batches', []);
           
            // Filter by selected date and batch
            let filteredLog = log.filter(entry => {
                const entryDate = new Date(entry.timestamp).toISOString().split('T')[0];
                if (entryDate !== selectedDate) {
                    return false;
                }
               
                // If batch is selected, filter by batch
                if (selectedBatchId) {
                    // Check by batchId first
                    if (entry.batchId && entry.batchId === selectedBatchId) {
                        return true;
                    }
                    // Check by batch name (for backward compatibility)
                    const selectedBatch = batches.find(b => b.id === selectedBatchId);
                    if (selectedBatch && entry.className === selectedBatch.name) {
                        return true;
                    }
                    return false;
                }
               
                return true; // Show all if no batch selected
            });

            // If batch is selected, also filter by batch students
            if (selectedBatchId) {
                const selectedBatch = batches.find(b => b.id === selectedBatchId);
                if (selectedBatch && selectedBatch.students) {
                    const batchStudentEmails = selectedBatch.students.map(e => e.toLowerCase());
                    filteredLog = filteredLog.filter(entry => {
                        const userData = registeredUsers[entry.student] || {};
                        const studentEmail = userData.email?.toLowerCase() || '';
                        return studentEmail && batchStudentEmails.includes(studentEmail);
                    });
                }
            }

            // Only show present students (entries with status 'Present' or no status field)
            filteredLog = filteredLog.filter(entry => {
                return !entry.status || entry.status === 'Present';
            });

            if (filteredLog.length === 0) {
                const batchName = selectedBatchId ? batches.find(b => b.id === selectedBatchId)?.name || 'selected batch' : '';
                const message = selectedBatchId
                    ? `No attendance records found for ${batchName} on ${selectedDate}`
                    : `No attendance records found for ${selectedDate}`;
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="p-4 text-center py-10">
                            <i class="fas fa-calendar-times text-gray-700 text-4xl mb-3 block"></i>
                            <span class="text-gray-500">${message}</span>
                        </td>
                    </tr>
                `;
                return;
            }

            // Sort by time (newest first)
            filteredLog.sort((a, b) => b.timestamp - a.timestamp);

            let html = '';
            let index = 1;
            filteredLog.forEach((entry) => {
                const userData = registeredUsers[entry.student] || {};
                const rollNo = userData.id || `STU-${index}`;
                const timeStr = new Date(entry.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const batchName = entry.className || entry.batchId || 'N/A';

                html += `
                    <tr class="hover:bg-gray-700/30 transition">
                        <td class="p-3 font-mono text-amber-400">${rollNo}</td>
                        <td class="p-3 font-medium text-white">${entry.student}</td>
                        <td class="p-3 text-gray-400">${batchName}</td>
                        <td class="p-3 text-right text-gray-500">${timeStr}</td>
                    </tr>
                `;
                index++;
            });

            tbody.innerHTML = html;
        };

        // Populate teacher portal batch select
        function populateTeacherPortalBatchSelect() {
            const batchSelect = document.getElementById('teacher-portal-batch-select');
            if (!batchSelect) return;
           
            const batches = safeParseJSON('spark_batches', []);
            batchSelect.innerHTML = '<option value="">Select a batch</option>';
            batches.forEach(batch => {
                const option = document.createElement('option');
                option.value = batch.id;
                option.textContent = batch.name;
                batchSelect.appendChild(option);
            });
           
            // Restore selected batch if portal is active
            const activeBatchId = localStorage.getItem('spark_active_attendance_portal');
            if (activeBatchId) {
                batchSelect.value = activeBatchId;
            }
        }

        // Sync Portal UI on load/tab switch
        function syncTeacherPortalUI() {
            try {
                const activeBatchId = localStorage.getItem('spark_active_attendance_portal');
                const activeBatchName = localStorage.getItem('spark_active_attendance_portal_name') || '';
                const badge = document.getElementById('attendance-portal-status-badge');
                const btnOpen = document.getElementById('btn-open-portal');
                const btnClose = document.getElementById('btn-close-portal');
                const info = document.getElementById('portal-active-info');
                const infoName = document.getElementById('active-portal-name');
                const batchSelect = document.getElementById('teacher-portal-batch-select');

                if (activeBatchId) {
                    if (batchSelect && batchSelect.value === activeBatchId) {
                        if (badge) {
                            badge.textContent = "OPEN";
                            badge.classList.remove('bg-red-900/40', 'text-red-400', 'border-red-900/50');
                            badge.classList.add('bg-green-900/40', 'text-green-400', 'border-green-900/50');
                        }
                        if (btnOpen) btnOpen.classList.add('hidden');
                        if (btnClose) btnClose.classList.remove('hidden');
                        if (info) info.classList.remove('hidden');
                        if (infoName) infoName.textContent = activeBatchName;
                    } else {
                        if (badge) {
                            badge.textContent = "CLOSED (Active for " + activeBatchName + ")";
                            badge.classList.add('bg-red-900/40', 'text-red-400', 'border-red-900/50');
                            badge.classList.remove('bg-green-900/40', 'text-green-400', 'border-green-900/50');
                        }
                        if (btnOpen) btnOpen.classList.remove('hidden');
                        if (btnClose) btnClose.classList.add('hidden');
                        if (info) info.classList.remove('hidden');
                        if (infoName) infoName.textContent = activeBatchName;
                    }
                } else {
                    if (badge) {
                        badge.textContent = "CLOSED";
                        badge.classList.add('bg-red-900/40', 'text-red-400', 'border-red-900/50');
                        badge.classList.remove('bg-green-900/40', 'text-green-400', 'border-green-900/50');
                    }
                    if (btnOpen) btnOpen.classList.remove('hidden');
                    if (btnClose) btnClose.classList.add('hidden');
                    if (info) info.classList.add('hidden');
                }
            } catch (e) {
                console.warn("syncTeacherPortalUI suppressed error:", e);
            }
        }


        // Add listener for batch select
        const teacherBatchSelect = document.getElementById('teacher-portal-batch-select');
        if (teacherBatchSelect) {
            teacherBatchSelect.addEventListener('change', syncTeacherPortalUI);
        }


        // Duplicate definition removed (already hoisted at the top)




        window.logoutTeacher = function () {
            localStorage.removeItem('spark_teacher_active');
            location.reload();
        };


        // Teacher Tab Switching
        document.querySelectorAll('.tab-btn-teacher').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.dataset.tab;
                localStorage.setItem('spark_teacher_tab', tabId);

                // Active Button State
                document.querySelectorAll('.tab-btn-teacher').forEach(b => {
                    b.classList.remove('text-green-400', 'bg-green-900/50', 'border', 'border-green-500/20');
                    b.classList.add('text-gray-400');
                });
                btn.classList.add('text-green-400', 'bg-green-900/50', 'border', 'border-green-500/20');
                btn.classList.remove('text-gray-400');

                // Show Content
                document.querySelectorAll('.tab-content-teacher').forEach(c => c.classList.add('hidden'));
                const target = document.getElementById(tabId);
                if (target) target.classList.remove('hidden');
               
                // Populate batch select when attendance tab is opened
                if (tabId === 'teacher-attendance') {
                    if (typeof populateTeacherPortalBatchSelect === 'function') {
                        populateTeacherPortalBatchSelect();
                    }
                    if (typeof syncTeacherPortalUI === 'function') {
                        syncTeacherPortalUI();
                    }
                }
            });
        });



        // ===== ADMIN PORTAL LOGIC =====


        // Duplicate definition removed (already hoisted at the top)




        window.logoutAdmin = function () {
            localStorage.removeItem('spark_admin_active');
            location.reload();
        };


        // Admin Tab Switching
        document.querySelectorAll('.tab-btn-admin').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.dataset.tab;
                localStorage.setItem('spark_admin_tab', tabId);

                // Active Button State
                document.querySelectorAll('.tab-btn-admin').forEach(b => {
                    b.classList.remove('text-purple-400', 'bg-purple-900/50', 'border', 'border-purple-500/20');
                    b.classList.add('text-gray-400');
                });
                btn.classList.add('text-purple-400', 'bg-purple-900/50', 'border', 'border-purple-500/20');
                btn.classList.remove('text-gray-400');

                // Show Content
                document.querySelectorAll('.tab-content-admin').forEach(c => c.classList.add('hidden'));
                const target = document.getElementById(tabId);
                if (target) target.classList.remove('hidden');

                if (tabId === 'admin-attendance') renderAdminAttendance();
            });
        });



        // User Management
        window.adminAddUserManual = function () {
            const name = document.getElementById('admin-add-name').value;
            const id = document.getElementById('admin-add-id').value;
            const email = document.getElementById('admin-add-email').value.trim();
            const role = document.getElementById('admin-add-role').value;

            if (!name || !id) { showMessage("Please enter Name and ID"); return; }

            // Check if user already exists by name, id, or email
            const existingByName = registeredUsers[name];
            const existingById = Object.values(registeredUsers).find(u => u.id === id);
            const existingByEmail = email ? Object.values(registeredUsers).find(u => u.email && u.email.toLowerCase() === email.toLowerCase()) : null;
           
            if (existingByName || existingById || existingByEmail) {
                showMessage("User already exists!");
                return;
            }

            registeredUsers[name] = {
                descriptor: [],
                id: id,
                role: role,
                name: name,
                email: email || undefined
            };
            localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
            showMessage(`User ${name} added successfully!`);

            document.getElementById('admin-add-name').value = '';
            document.getElementById('admin-add-id').value = '';
            document.getElementById('admin-add-email').value = '';
        };

        window.handleAdminFileUpload = function (input) {
            const file = input.files[0];
            if (!file) return;

            const status = document.getElementById('admin-upload-status');
            if (status) {
                status.textContent = "Processing " + file.name + "...";

                setTimeout(() => {
                    if (status) {
                        status.textContent = "Imported 24 users from " + file.name;
                        status.classList.add('text-green-400');
                    }
                    showMessage("Import Successful! (Simulation)");
                }, 1500);
            }
        };

        // PDF Import Function
        window.handlePDFImport = async function (input) {
            const file = input.files[0];
            if (!file) return;

            const status = document.getElementById('admin-pdf-status');
            if (status) {
                status.textContent = "Processing PDF: " + file.name + "...";
                status.className = "mt-3 text-sm text-yellow-400 text-center";
            }

            try {
                // Initialize PDF.js
                if (typeof pdfjsLib === 'undefined') {
                    if (status) {
                        status.textContent = "PDF.js library not loaded. Please refresh the page.";
                        status.className = "mt-3 text-sm text-red-400 text-center";
                    }
                    return;
                }

                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
               
                let extractedText = '';
                const registeredUsers = safeParseJSON('registeredUsers', {});
                let importedCount = 0;

                // Extract text from all pages
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    const page = await pdf.getPage(pageNum);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    extractedText += pageText + '\n';
                }

                // Parse the extracted text to find user data
                // This parser handles multiple formats: Name ID, Name Email ID, etc.
                const lines = extractedText.split('\n').filter(line => line.trim());
               
                lines.forEach((line, index) => {
                    // Pattern 1: Name followed by ID (e.g., "John Doe CS202501")
                    const nameIdPattern1 = /([A-Z][a-z]+(?:\s+[A-Z][a-z]+)+)\s+([A-Z]{2,}\d+)/;
                    // Pattern 2: ID followed by Name (e.g., "CS202501 John Doe")
                    const nameIdPattern2 = /([A-Z]{2,}\d+)\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)+)/;
                    // Pattern 3: Name, Email, ID (comma or tab separated)
                    const csvPattern = /([A-Z][a-z]+(?:\s+[A-Z][a-z]+)+)[,\t]\s*([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})?[,\t]?\s*([A-Z]{2,}\d+)?/;
                   
                    const emailPattern = /([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/;
                   
                    let name = null;
                    let id = null;
                    let email = null;
                   
                    // Try different patterns
                    const nameIdMatch1 = line.match(nameIdPattern1);
                    const nameIdMatch2 = line.match(nameIdPattern2);
                    const csvMatch = line.match(csvPattern);
                    const emailMatch = line.match(emailPattern);
                   
                    if (nameIdMatch1) {
                        name = nameIdMatch1[1].trim();
                        id = nameIdMatch1[2].trim();
                    } else if (nameIdMatch2) {
                        id = nameIdMatch2[1].trim();
                        name = nameIdMatch2[2].trim();
                    } else if (csvMatch) {
                        name = csvMatch[1].trim();
                        email = csvMatch[2] ? csvMatch[2].trim() : null;
                        id = csvMatch[3] ? csvMatch[3].trim() : null;
                    }
                   
                    // Extract email if not found yet
                    if (!email && emailMatch) {
                        email = emailMatch[1].trim();
                    }
                   
                    // If we have at least name and id, create user
                    if (name && id) {
                        // Check if user already exists
                        const existingByName = registeredUsers[name];
                        const existingById = Object.values(registeredUsers).find(u => u.id === id);
                        const existingByEmail = email ? Object.values(registeredUsers).find(u => u.email && u.email.toLowerCase() === email.toLowerCase()) : null;
                       
                        if (!existingByName && !existingById && !existingByEmail) {
                            registeredUsers[name] = {
                                descriptor: [],
                                id: id,
                                role: 'student',
                                name: name,
                                email: email || undefined
                            };
                            importedCount++;
                        }
                    }
                });

                if (importedCount > 0) {
                    localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
                    if (status) {
                        status.textContent = `Successfully imported ${importedCount} users from PDF!`;
                        status.className = "mt-3 text-sm text-green-400 text-center";
                    }
                    showMessage(`Imported ${importedCount} users from PDF successfully!`);
                   
                    // Refresh tables if they're visible
                    if (document.getElementById('admin-user-table-body')) {
                        renderAdminUserTable();
                    }
                    if (document.getElementById('admin-edit-table-body')) {
                        renderAdminEditTable();
                    }
                } else {
                    if (status) {
                        status.textContent = "No new users found in PDF. Please check the format.";
                        status.className = "mt-3 text-sm text-yellow-400 text-center";
                    }
                    showMessage("No new users found in PDF. The PDF may not contain data in the expected format.");
                }
            } catch (error) {
                console.error('PDF import error:', error);
                if (status) {
                    status.textContent = "Error importing PDF: " + error.message;
                    status.className = "mt-3 text-sm text-red-400 text-center";
                }
                showMessage("Error importing PDF. Please check the file format.");
            }
        };

        // Export Data Management to PDF
        window.exportDataManagementToPDF = function () {
            try {
                if (typeof window.jspdf === 'undefined') {
                    showMessage("PDF library not loaded. Please refresh the page.");
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
               
                const registeredUsers = safeParseJSON('registeredUsers', {});
                const batches = safeParseJSON('spark_batches', []);

                // Title
                doc.setFontSize(18);
                doc.text('Data Management Export', 14, 20);
                doc.setFontSize(12);
                doc.text(`Generated on: ${new Date().toLocaleString()}`, 14, 30);

                let yPos = 40;
                const pageHeight = doc.internal.pageSize.height;
                const margin = 14;
                const lineHeight = 7;

                // Registered Users Section
                doc.setFontSize(14);
                doc.text('Registered Users', margin, yPos);
                yPos += 10;

                doc.setFontSize(10);
                const userHeaders = ['Name', 'ID', 'Email', 'Role', 'Course'];
                const userColWidths = [50, 40, 60, 30, 40];
                let xPos = margin;

                // Table headers
                doc.setFont(undefined, 'bold');
                userHeaders.forEach((header, i) => {
                    doc.text(header, xPos, yPos);
                    xPos += userColWidths[i];
                });
                yPos += lineHeight;
                doc.setFont(undefined, 'normal');

                // Table rows
                Object.keys(registeredUsers).forEach(key => {
                    if (yPos > pageHeight - 20) {
                        doc.addPage();
                        yPos = margin;
                    }

                    const user = registeredUsers[key];
                    xPos = margin;
                    const rowData = [
                        (user.name || key).substring(0, 20),
                        (user.id || 'N/A').substring(0, 15),
                        (user.email || '-').substring(0, 25),
                        (user.role || 'student').substring(0, 10),
                        (user.course || '-').substring(0, 15)
                    ];

                    rowData.forEach((data, i) => {
                        doc.text(data, xPos, yPos);
                        xPos += userColWidths[i];
                    });
                    yPos += lineHeight;
                });

                // Batches Section
                yPos += 10;
                if (yPos > pageHeight - 30) {
                    doc.addPage();
                    yPos = margin;
                }

                doc.setFontSize(14);
                doc.text('Batches', margin, yPos);
                yPos += 10;

                doc.setFontSize(10);
                batches.forEach(batch => {
                    if (yPos > pageHeight - 20) {
                        doc.addPage();
                        yPos = margin;
                    }

                    doc.setFont(undefined, 'bold');
                    doc.text(`Batch: ${batch.name || batch.id}`, margin, yPos);
                    yPos += lineHeight;
                    doc.setFont(undefined, 'normal');
                    doc.text(`Students: ${batch.students ? batch.students.length : 0}`, margin + 10, yPos);
                    yPos += lineHeight + 2;
                });

                // Save PDF
                const fileName = `data_management_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                showMessage("Data Management exported to PDF successfully!");
            } catch (error) {
                console.error('PDF export error:', error);
                showMessage("Error exporting to PDF: " + error.message);
            }
        };

        // Export Results to PDF
        window.exportResultsToPDF = function () {
            try {
                if (typeof window.jspdf === 'undefined') {
                    showMessage("PDF library not loaded. Please refresh the page.");
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
               
                const batchId = document.getElementById('admin-result-batch')?.value;
                if (!batchId) {
                    showMessage("Please select a batch first.");
                    return;
                }

                const results = getResultsStorage();
                const batches = safeParseJSON('spark_batches', []);
                const batch = batches.find(b => b.id === batchId);
                const emailToNameMap = safeParseJSON('spark_email_name_map', {});
                const registeredUsers = safeParseJSON('registeredUsers', {});

                if (!batch) {
                    showMessage("Batch not found.");
                    return;
                }

                // Find all results for this batch
                const batchResults = [];
                Object.keys(results).forEach(key => {
                    const resultData = results[key];
                    const metadata = resultData._metadata || {};
                    if (metadata.batchId === batchId) {
                        batchResults.push({
                            key: key,
                            subject: metadata.subject || 'Unknown',
                            examType: metadata.examType || 'Unknown',
                            data: resultData,
                            updatedAt: metadata.updatedAt || ''
                        });
                    }
                });

                if (batchResults.length === 0) {
                    showMessage("No results found for this batch.");
                    return;
                }

                // Title
                doc.setFontSize(18);
                doc.text(`Results - ${batch.name || batch.id}`, 14, 20);
                doc.setFontSize(12);
                doc.text(`Generated on: ${new Date().toLocaleString()}`, 14, 30);

                let yPos = 40;
                const pageHeight = doc.internal.pageSize.height;
                const margin = 14;
                const lineHeight = 6;

                // Group by subject and exam type
                batchResults.forEach(resultInfo => {
                    const { subject, examType, data, updatedAt } = resultInfo;
                    const date = updatedAt ? new Date(updatedAt).toLocaleDateString() : '-';

                    // Check if we need a new page
                    if (yPos > pageHeight - 40) {
                        doc.addPage();
                        yPos = margin;
                    }

                    // Subject and Exam Type Header
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text(`${subject} - ${examType}`, margin, yPos);
                    yPos += 8;
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text(`Updated: ${date}`, margin, yPos);
                    yPos += 10;

                    // Table headers
                    doc.setFont(undefined, 'bold');
                    doc.text('Roll No', margin, yPos);
                    doc.text('Student Name', margin + 30, yPos);
                    doc.text('Email', margin + 80, yPos);
                    doc.text('Marks', margin + 140, yPos);
                    yPos += lineHeight;
                    doc.setFont(undefined, 'normal');

                    // Get students from batch
                    if (batch && batch.students) {
                        let rollNo = 1;
                        batch.students.forEach(email => {
                            if (yPos > pageHeight - 20) {
                                doc.addPage();
                                yPos = margin;
                            }

                            const userData = Object.values(registeredUsers).find(u => u.email?.toLowerCase() === email.toLowerCase());
                            const studentName = userData?.name || emailToNameMap[email] || email.split('@')[0];
                            const studentId = userData?.id || `STU-${rollNo}`;
                            const marks = data[email] !== undefined ? data[email] : '-';

                            doc.text(rollNo.toString(), margin, yPos);
                            doc.text(studentName.substring(0, 25), margin + 30, yPos);
                            doc.text(email.substring(0, 30), margin + 80, yPos);
                            doc.text(marks.toString(), margin + 140, yPos);
                            yPos += lineHeight;
                            rollNo++;
                        });
                    }

                    yPos += 10; // Space between result sets
                });

                // Save PDF
                const fileName = `results_${batch.name || batch.id}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                showMessage("Results exported to PDF successfully!");
            } catch (error) {
                console.error('PDF export error:', error);
                showMessage("Error exporting to PDF: " + error.message);
            }
        };

        window.renderAdminUserTable = function () {
            const tbody = document.getElementById('admin-user-table-body');
            if (tbody) tbody.innerHTML = '';

            const filterRole = document.getElementById('admin-filter-role')?.value || 'all';
            const filterSearch = document.getElementById('admin-filter-search')?.value.toLowerCase() || '';

            Object.keys(registeredUsers).forEach(key => {
                const user = registeredUsers[key];
                const name = user.name || key;
                const id = user.id || 'N/A';
                const email = user.email || '-';
                const role = user.role || 'student';
                const course = user.course || '-';

                // Filter logic
                let match = true;
                if (filterRole !== 'all' && role !== filterRole) match = false;
                if (filterSearch) {
                    const searchLower = filterSearch.toLowerCase();
                    if (!name.toLowerCase().includes(searchLower) &&
                        !id.toLowerCase().includes(searchLower) &&
                        !email.toLowerCase().includes(searchLower)) {
                        match = false;
                    }
                }

                if (match) {
                    const row = `
                        <tr class="hover:bg-gray-700/50 transition border-b border-gray-800">
                            <td class="p-4 font-medium">${name}</td>
                            <td class="p-4 text-gray-400">${id}</td>
                            <td class="p-4 text-gray-400">${email}</td>
                            <td class="p-4"><span class="px-2 py-1 rounded text-xs bg-gray-700 border border-gray-600 uppercase">${role}</span></td>
                            <td class="p-4 text-gray-400">${course}</td>
                            <td class="p-4 text-right">
                                <button class="text-blue-400 hover:text-blue-300 mr-2" onclick="openEditModal('${key}')" title="Edit"><i class="fas fa-edit"></i></button>
                                <button class="text-red-400 hover:text-red-300" onclick="adminRemoveUser('${key}')" title="Delete"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                }
            });
        };

        window.renderAdminEditTable = function () {
            const tbody = document.getElementById('admin-edit-table-body');
            if (tbody) tbody.innerHTML = '';

            const filterRole = document.getElementById('admin-edit-filter-role')?.value || 'all';
            const filterSearch = document.getElementById('admin-edit-search')?.value.toLowerCase() || '';

            Object.keys(registeredUsers).forEach(key => {
                const user = registeredUsers[key];
                const name = user.name || key;
                const id = user.id || 'N/A';
                const email = user.email || '-';
                const role = user.role || 'student';
                const course = user.course || '-';

                // Filter logic
                let match = true;
                if (filterRole !== 'all' && role !== filterRole) match = false;
                if (filterSearch) {
                    const searchLower = filterSearch.toLowerCase();
                    if (!name.toLowerCase().includes(searchLower) &&
                        !id.toLowerCase().includes(searchLower) &&
                        !email.toLowerCase().includes(searchLower)) {
                        match = false;
                    }
                }

                if (match) {
                    const row = `
                        <tr class="hover:bg-gray-700/50 transition border-b border-gray-800">
                            <td class="p-4 font-medium">${name}</td>
                            <td class="p-4 text-gray-400">${id}</td>
                            <td class="p-4 text-gray-400">${email}</td>
                            <td class="p-4"><span class="px-2 py-1 rounded text-xs bg-gray-700 border border-gray-600 uppercase">${role}</span></td>
                            <td class="p-4 text-gray-400">${course}</td>
                            <td class="p-4 text-right">
                                <button class="text-blue-400 hover:text-blue-300" onclick="openEditModal('${key}')" title="Edit"><i class="fas fa-edit"></i></button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                }
            });
        };

        window.openEditModal = function (userKey) {
            const user = registeredUsers[userKey];
            if (!user) {
                showMessage("User not found.");
                return;
            }

            document.getElementById('edit-user-key').value = userKey;
            document.getElementById('edit-user-name').value = user.name || '';
            document.getElementById('edit-user-id').value = user.id || '';
            document.getElementById('edit-user-email').value = user.email || '';
            document.getElementById('edit-user-role').value = user.role || 'student';
            document.getElementById('edit-user-course').value = user.course || '';
            document.getElementById('edit-user-class').value = user.studentClass || '';

            const modal = document.getElementById('admin-edit-modal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        };

        window.closeEditModal = function () {
            const modal = document.getElementById('admin-edit-modal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
            document.getElementById('admin-edit-form').reset();
        };

        window.saveUserEdit = function (event) {
            event.preventDefault();
            const userKey = document.getElementById('edit-user-key').value;
            const name = document.getElementById('edit-user-name').value.trim();
            const id = document.getElementById('edit-user-id').value.trim();
            const email = document.getElementById('edit-user-email').value.trim();
            const role = document.getElementById('edit-user-role').value;
            const course = document.getElementById('edit-user-course').value.trim();
            const studentClass = document.getElementById('edit-user-class').value.trim();

            if (!name || !id) {
                showMessage("Name and ID are required.");
                return;
            }

            const user = registeredUsers[userKey];
            if (!user) {
                showMessage("User not found.");
                return;
            }

            // Check if ID is being changed and if new ID already exists
            if (id !== user.id) {
                for (const key in registeredUsers) {
                    if (key !== userKey && registeredUsers[key].id === id) {
                        showMessage("This ID is already in use by another user.");
                        return;
                    }
                }
            }

            // Check if email is being changed and if new email already exists
            if (email && email !== user.email) {
                for (const key in registeredUsers) {
                    if (key !== userKey && registeredUsers[key].email && registeredUsers[key].email.toLowerCase() === email.toLowerCase()) {
                        showMessage("This email is already in use by another user.");
                        return;
                    }
                }
            }

            // Update user data, preserving descriptor and other important fields
            registeredUsers[userKey] = {
                ...user,
                name: name,
                id: id,
                email: email || undefined,
                role: role,
                course: course || undefined,
                studentClass: studentClass || undefined
            };

            localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
            showMessage("User updated successfully!");
            closeEditModal();
            renderAdminUserTable();
            renderAdminEditTable();
        };

        window.adminRemoveUser = function (key) {
            if (confirm('Are you sure you want to remove this user?')) {
                delete registeredUsers[key];
                localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
                renderAdminUserTable();
                showMessage("User removed.");
            }
        };

        // Attendance Aggregation
        window.renderAdminAttendance = function () {
            const log = safeParseJSON('spark_attendance_log', []);
            const tbody = document.getElementById('admin-attendance-log-body');
            const totalCountDisplay = document.getElementById('admin-total-checkins');

            if (totalCountDisplay) totalCountDisplay.textContent = log.length;

            if (tbody) {
                tbody.innerHTML = '';
                const recent = log.sort((a, b) => b.timestamp - a.timestamp).slice(0, 50);

                recent.forEach(entry => {
                    const date = new Date(entry.timestamp);
                    const row = `
                        <tr class="hover:bg-gray-700/50 transition border-b border-gray-800">
                            <td class="p-4 text-gray-400">${date.toLocaleTimeString()}</td>
                            <td class="p-4 font-medium text-white">${entry.className}</td>
                            <td class="p-4 text-green-400"><i class="fas fa-check-circle mr-2"></i>Present</td>
                            <td class="p-4 text-right">
                                <button class="text-gray-500 hover:text-white"><i class="fas fa-ellipsis-h"></i></button>
                            </td>
                        </tr>
                     `;
                    tbody.innerHTML += row;
                });
            }
        };

        // ===== BATCH MANAGEMENT FUNCTIONS =====
       
        // Initialize batches data structure
        let batches = safeParseJSON('spark_batches', []);
        let emailToBatchMap = safeParseJSON('spark_email_batch_map', {});
        let emailToNameMap = safeParseJSON('spark_email_name_map', {});

        // Save batches to localStorage
        function saveBatches() {
            localStorage.setItem('spark_batches', JSON.stringify(batches));
            localStorage.setItem('spark_email_batch_map', JSON.stringify(emailToBatchMap));
            localStorage.setItem('spark_email_name_map', JSON.stringify(emailToNameMap));
        }

        // Show batch section
        window.showBatchSection = function (section) {
            document.querySelectorAll('.batch-sub-content').forEach(c => c.classList.add('hidden'));
            const target = document.getElementById('batch-sub-' + section);
            if (target) {
                target.classList.remove('hidden');
                if (section === 'view') {
                    renderBatchesList();
                } else if (section === 'add-student' || section === 'add-teacher') {
                    populateBatchSelects();
                }
            }
           
            // Update tab button states
            document.querySelectorAll('.sub-tab-btn').forEach(b => {
                b.classList.remove('text-blue-400', 'text-green-300', 'text-yellow-300', 'border-b-2', 'border-blue-400', 'border-green-400', 'border-yellow-400');
                b.classList.add('text-gray-400');
            });
            const activeBtn = document.querySelector(`[data-sub="${section}"]`);
            if (activeBtn) {
                // Remove all active states first
                activeBtn.classList.remove('text-gray-400');
               
                // Add appropriate classes based on section
                if (section === 'create') {
                    activeBtn.classList.add('text-blue-400', 'border-b-2', 'border-blue-400');
                } else if (section === 'add-student') {
                    activeBtn.classList.add('text-green-300', 'border-b-2', 'border-green-400');
                } else if (section === 'add-teacher') {
                    activeBtn.classList.add('text-yellow-300', 'border-b-2', 'border-yellow-400');
                } else {
                    activeBtn.classList.add('text-blue-400', 'border-b-2', 'border-blue-400');
                }
            }
        };

        // Create new batch
        window.createBatch = function () {
            const name = document.getElementById('batch-name').value.trim();
            const description = document.getElementById('batch-description').value.trim();

            if (!name) {
                showMessage("Please enter a batch name");
                return;
            }

            // Check if batch name already exists
            if (batches.find(b => b.name.toLowerCase() === name.toLowerCase())) {
                showMessage("Batch name already exists!");
                return;
            }

            const newBatch = {
                id: 'batch_' + Date.now(),
                name: name,
                description: description,
                students: [],
                teachers: [],
                timetable: {}
            };

            batches.push(newBatch);
            saveBatches();
            showMessage(`Batch "${name}" created successfully!`);
           
            document.getElementById('batch-name').value = '';
            document.getElementById('batch-description').value = '';
           
            populateBatchSelects();
            renderBatchesList();
        };

        // Populate batch select dropdowns
        function populateBatchSelects() {
            const studentSelect = document.getElementById('batch-select-student');
            const teacherSelect = document.getElementById('batch-select-teacher');
            const scheduleSelect = document.getElementById('schedule-batch-select');

            const options = batches.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
            const defaultOption = '<option value="">Select Batch</option>';

            if (studentSelect) studentSelect.innerHTML = defaultOption + options;
            if (teacherSelect) teacherSelect.innerHTML = defaultOption + options;
            if (scheduleSelect) scheduleSelect.innerHTML = defaultOption + options;
        }

        // Add student to batch
        window.addStudentToBatch = function () {
            // Refresh batches and maps to get latest data
            batches = safeParseJSON('spark_batches', []);
            emailToBatchMap = safeParseJSON('spark_email_batch_map', {});
            emailToNameMap = safeParseJSON('spark_email_name_map', {});
           
            const batchId = document.getElementById('batch-select-student').value;
            const fullName = document.getElementById('student-full-name').value.trim();
            const email = document.getElementById('student-email').value.trim().toLowerCase();
            const statusDiv = document.getElementById('student-email-status');

            if (!batchId) {
                showMessage("Please select a batch");
                return;
            }

            if (!fullName) {
                showMessage("Please enter student's full name");
                return;
            }

            if (!email || !email.includes('@')) {
                showMessage("Please enter a valid email address");
                return;
            }

            // Check if email is already in another batch
            if (emailToBatchMap[email] && emailToBatchMap[email] !== batchId) {
                const existingBatch = batches.find(b => b.id === emailToBatchMap[email]);
                showMessage(`This email is already assigned to batch: ${existingBatch ? existingBatch.name : 'Unknown'}`);
                if (statusDiv) {
                    statusDiv.textContent = `Email already in batch: ${existingBatch ? existingBatch.name : 'Unknown'}`;
                    statusDiv.className = 'text-sm text-red-400';
                }
                return;
            }

            const batch = batches.find(b => b.id === batchId);
            if (!batch) {
                showMessage("Batch not found");
                return;
            }

            // Check if email already in this batch
            if (batch.students.includes(email)) {
                showMessage("Student already in this batch");
                if (statusDiv) {
                    statusDiv.textContent = 'Student already in this batch';
                    statusDiv.className = 'text-sm text-yellow-400';
                }
                return;
            }

            batch.students.push(email);
            emailToBatchMap[email] = batchId;
            emailToNameMap[email] = fullName;
           
            // Update user data if user exists
            for (let username in registeredUsers) {
                if (registeredUsers[username].email === email) {
                    registeredUsers[username].name = fullName;
                    localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
                    break;
                }
            }
           
            saveBatches();
            showMessage(`Student ${fullName} (${email}) added to batch ${batch.name}`);
           
            document.getElementById('student-full-name').value = '';
            document.getElementById('student-email').value = '';
            if (statusDiv) {
                statusDiv.textContent = '';
                statusDiv.className = 'text-sm text-gray-400';
            }
           
            renderBatchesList();
        };

        // Add teacher to batch
        window.addTeacherToBatch = function () {
            const batchId = document.getElementById('batch-select-teacher').value;
            const email = document.getElementById('teacher-email').value.trim().toLowerCase();

            if (!batchId) {
                showMessage("Please select a batch");
                return;
            }

            if (!email || !email.includes('@')) {
                showMessage("Please enter a valid email address");
                return;
            }

            const batch = batches.find(b => b.id === batchId);
            if (!batch) {
                showMessage("Batch not found");
                return;
            }

            // Check if email already in this batch
            if (batch.teachers.includes(email)) {
                showMessage("Teacher already in this batch");
                return;
            }

            batch.teachers.push(email);
            saveBatches();
            showMessage(`Teacher ${email} added to batch ${batch.name}`);
           
            document.getElementById('teacher-email').value = '';
            renderBatchesList();
        };

        // Render batches list
        function renderBatchesList() {
            const container = document.getElementById('batches-list');
            if (!container) return;

            if (batches.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-center py-8">No batches created yet</div>';
                return;
            }

            container.innerHTML = batches.map(batch => `
                <div class="bg-gray-700/50 p-6 rounded-xl border border-gray-600">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-white mb-1">${batch.name}</h3>
                            ${batch.description ? `<p class="text-gray-400 text-sm">${batch.description}</p>` : ''}
                        </div>
                        <button onclick="deleteBatch('${batch.id}')"
                            class="text-red-400 hover:text-red-300 p-2">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div>
                            <h4 class="text-sm font-semibold text-gray-300 mb-2">Students (${batch.students.length})</h4>
                            <div class="space-y-1 max-h-32 overflow-y-auto">
                                ${batch.students.length > 0 ?
                                    batch.students.map(email => `
                                        <div class="text-sm text-gray-400 flex justify-between items-center bg-gray-800/50 p-2 rounded">
                                            <span>${email}</span>
                                            <button onclick="removeStudentFromBatch('${batch.id}', '${email}')"
                                                class="text-red-400 hover:text-red-300 text-xs">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    `).join('') :
                                    '<div class="text-sm text-gray-500">No students added</div>'
                                }
                            </div>
                        </div>
                        <div>
                            <h4 class="text-sm font-semibold text-gray-300 mb-2">Teachers (${batch.teachers.length})</h4>
                            <div class="space-y-1 max-h-32 overflow-y-auto">
                                ${batch.teachers.length > 0 ?
                                    batch.teachers.map(email => `
                                        <div class="text-sm text-gray-400 flex justify-between items-center bg-gray-800/50 p-2 rounded">
                                            <span>${email}</span>
                                            <button onclick="removeTeacherFromBatch('${batch.id}', '${email}')"
                                                class="text-red-400 hover:text-red-300 text-xs">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    `).join('') :
                                    '<div class="text-sm text-gray-500">No teachers added</div>'
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Remove student from batch
        window.removeStudentFromBatch = function (batchId, email) {
            if (!confirm(`Remove ${email} from this batch?`)) return;
           
            const batch = batches.find(b => b.id === batchId);
            if (batch) {
                batch.students = batch.students.filter(e => e !== email);
                delete emailToBatchMap[email];
                saveBatches();
                renderBatchesList();
                showMessage("Student removed from batch");
            }
        };

        // Remove teacher from batch
        window.removeTeacherFromBatch = function (batchId, email) {
            if (!confirm(`Remove ${email} from this batch?`)) return;
           
            const batch = batches.find(b => b.id === batchId);
            if (batch) {
                batch.teachers = batch.teachers.filter(e => e !== email);
                saveBatches();
                renderBatchesList();
                showMessage("Teacher removed from batch");
            }
        };

        // Delete batch
        window.deleteBatch = function (batchId) {
            if (!confirm("Are you sure you want to delete this batch? All students and teachers will be removed.")) return;
           
            const batch = batches.find(b => b.id === batchId);
            if (batch) {
                // Remove all student emails from map
                batch.students.forEach(email => {
                    delete emailToBatchMap[email];
                });
               
                batches = batches.filter(b => b.id !== batchId);
                saveBatches();
                renderBatchesList();
                populateBatchSelects();
                showMessage("Batch deleted");
            }
        };

        // ===== SCHEDULE/TIMETABLE FUNCTIONS =====

        // Load batch schedule
        window.loadBatchSchedule = function () {
            const batchId = document.getElementById('schedule-batch-select').value;
            const container = document.getElementById('schedule-container');
            const empty = document.getElementById('schedule-empty');

            if (!batchId) {
                if (container) container.classList.add('hidden');
                if (empty) empty.classList.remove('hidden');
                return;
            }

            // Refresh batches to get latest data
            batches = safeParseJSON('spark_batches', []);
            const batch = batches.find(b => b.id === batchId);
            if (!batch) return;

            if (container) container.classList.remove('hidden');
            if (empty) empty.classList.add('hidden');

            // Initialize timetable if not exists
            if (!batch.timetable || Object.keys(batch.timetable).length === 0) {
                batch.timetable = {};
                saveBatches();
            }

            renderScheduleGrid(batch.timetable);
        };

        // Render schedule grid
        function renderScheduleGrid(timetable) {
            const tbody = document.getElementById('schedule-tbody');
            if (!tbody) return;

            // Refresh batches from localStorage to ensure we have latest data
            batches = safeParseJSON('spark_batches', []);

            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
           
            // Get all time slots that exist in the timetable (either with data or empty)
            const timeSlotsSet = new Set();
           
            Object.keys(timetable || {}).forEach(key => {
                // Keys are in format: "monday_09:00" or "monday_09:00_room"
                const parts = key.split('_');
                if (parts.length >= 2 && days.includes(parts[0])) {
                    // For room keys: "monday_09:00_room" -> time is parts[1]
                    // For class keys: "monday_09:00" -> time is parts[1]
                    if (parts.length === 3 && parts[2] === 'room') {
                        // Room key - time is in parts[1]
                        const time = parts[1];
                        if (time) {
                            timeSlotsSet.add(time);
                        }
                    } else if (parts.length === 2) {
                        // Class key - time is in parts[1]
                        const time = parts[1];
                        if (time) {
                            timeSlotsSet.add(time);
                        }
                    }
                }
            });

            // Convert to sorted array (sort by time, not alphabetically)
            let timeSlots = Array.from(timeSlotsSet).sort((a, b) => {
                // Convert time strings to minutes for proper sorting
                const timeToMinutes = (timeStr) => {
                    const [hours, minutes] = timeStr.split(':').map(Number);
                    return (hours || 0) * 60 + (minutes || 0);
                };
                return timeToMinutes(a) - timeToMinutes(b);
            });
           
            // If no time slots exist, show default time slots (8 AM to 6 PM) for initial setup
            if (timeSlots.length === 0) {
                for (let hour = 8; hour <= 18; hour++) {
                    timeSlots.push(`${hour.toString().padStart(2, '0')}:00`);
                }
            }

            tbody.innerHTML = timeSlots.map((time, timeIndex) => {
                // Escape time for use in HTML attributes
                const timeEscaped = time.replace(/'/g, "\\'");
                return `
                    <tr data-time="${time}" data-row-index="${timeIndex}">
                        <td class="p-3 border border-gray-700 text-gray-300 font-semibold bg-gray-800 align-top">${time}</td>
                        ${days.map(day => {
                            const key = `${day}_${time}`;
                            const roomKey = `${day}_${time}_room`;
                            const value = (timetable[key] || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                            const roomValue = (timetable[roomKey] || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                            return `
                                <td class="p-2 border border-gray-700 align-top">
                                    <div class="space-y-2">
                                        <input type="text"
                                            data-day="${day}"
                                            data-time="${time}"
                                            data-type="class"
                                            value="${value}"
                                            placeholder="Subject/Teacher"
                                            class="w-full p-2 bg-gray-800/50 border border-gray-600 rounded text-white text-sm focus:border-blue-500 outline-none">
                                        <input type="text"
                                            data-day="${day}"
                                            data-time="${time}"
                                            data-type="room"
                                            value="${roomValue}"
                                            placeholder="Room No."
                                            class="w-full p-1.5 bg-gray-800/30 border border-gray-600 rounded text-white text-xs focus:border-blue-500 outline-none">
                                    </div>
                                </td>
                            `;
                        }).join('')}
                        <td class="p-2 border border-gray-700 align-top">
                            <div class="flex gap-2 justify-center">
                                <button onclick="editTimetableRow('${timeEscaped}')"
                                    class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs font-semibold transition flex items-center gap-1"
                                    title="Edit Row">
                                    <i class="fas fa-edit text-xs"></i>
                                    <span>Edit</span>
                                </button>
                                <button onclick="deleteTimetableRow('${timeEscaped}')"
                                    class="px-3 py-1.5 bg-red-600 hover:bg-red-700 text-white rounded text-xs font-semibold transition flex items-center gap-1"
                                    title="Delete Row">
                                    <i class="fas fa-trash text-xs"></i>
                                    <span>Delete</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            // Add event listeners for real-time updates
            tbody.querySelectorAll('input[data-type="class"]').forEach(input => {
                input.addEventListener('input', function() {
                    const day = this.dataset.day;
                    const time = this.dataset.time;
                    const key = `${day}_${time}`;
                    const batchId = document.getElementById('schedule-batch-select').value;
                    if (!batchId) return;
                   
                    // Refresh batches to get latest data
                    batches = safeParseJSON('spark_batches', []);
                    const batch = Array.isArray(batches) ? batches.find(b => b && b.id === batchId) : null;
                    if (batch) {
                        if (!batch.timetable) batch.timetable = {};
                        batch.timetable[key] = this.value;
                        saveBatches();
                    }
                });
            });

            // Add event listeners for room number updates
            tbody.querySelectorAll('input[data-type="room"]').forEach(input => {
                input.addEventListener('input', function() {
                    const day = this.dataset.day;
                    const time = this.dataset.time;
                    const key = `${day}_${time}_room`;
                    const batchId = document.getElementById('schedule-batch-select').value;
                    if (!batchId) return;
                   
                    // Refresh batches to get latest data
                    batches = safeParseJSON('spark_batches', []);
                    const batch = Array.isArray(batches) ? batches.find(b => b && b.id === batchId) : null;
                    if (batch) {
                        if (!batch.timetable) batch.timetable = {};
                        batch.timetable[key] = this.value;
                        saveBatches();
                    }
                });
            });
        }

        // Save batch schedule
        window.saveBatchSchedule = function () {
            const batchId = document.getElementById('schedule-batch-select').value;
            if (!batchId) {
                showMessage("Please select a batch");
                return;
            }

            // Refresh batches to get latest data
            batches = safeParseJSON('spark_batches', []);
            const batch = batches.find(b => b.id === batchId);
            if (!batch) {
                showMessage("Batch not found");
                return;
            }

            if (!batch.timetable) batch.timetable = {};

            // Collect all input values (both class and room)
            const inputs = document.querySelectorAll('#schedule-tbody input');
            inputs.forEach(input => {
                const day = input.dataset.day;
                const time = input.dataset.time;
                const type = input.dataset.type || 'class';
                const key = type === 'room' ? `${day}_${time}_room` : `${day}_${time}`;
                batch.timetable[key] = input.value.trim();
            });

            saveBatches();
            showMessage(`Schedule saved for ${batch.name}`);
        };

        // Edit timetable row - focuses on the first input of the row
        window.editTimetableRow = function (time) {
            const row = document.querySelector(`#schedule-tbody tr[data-time="${time}"]`);
            if (!row) return;
           
            const firstInput = row.querySelector('input[data-type="class"]');
            if (firstInput) {
                firstInput.focus();
                firstInput.select();
            }
        };

        // Delete timetable row - removes all data for that time slot and removes the row
        window.deleteTimetableRow = function (time) {
            if (!confirm(`Are you sure you want to delete all classes for time slot ${time}? This will remove the entire row.`)) {
                return;
            }

            const batchId = document.getElementById('schedule-batch-select').value;
            if (!batchId) {
                showMessage("Please select a batch");
                return;
            }

            // Refresh batches to get latest data
            batches = safeParseJSON('spark_batches', []);
            const batch = batches.find(b => b.id === batchId);
            if (!batch) {
                showMessage("Batch not found");
                return;
            }

            if (!batch.timetable) batch.timetable = {};

            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
           
            // Remove all entries for this time slot
            days.forEach(day => {
                const classKey = `${day}_${time}`;
                const roomKey = `${day}_${time}_room`;
                delete batch.timetable[classKey];
                delete batch.timetable[roomKey];
            });

            saveBatches();
           
            // Remove the row from DOM immediately (escape time for querySelector)
            const escapedTime = time.replace(/"/g, '\\"').replace(/'/g, "\\'");
            const row = document.querySelector(`#schedule-tbody tr[data-time="${escapedTime}"]`);
            if (row) {
                row.remove();
            }
           
            // Also reload the schedule grid to ensure consistency
            renderScheduleGrid(batch.timetable);

            showMessage(`Time slot ${time} deleted successfully`);
        };

        // Add new time slot
        window.addNewTimeSlot = function () {
            const batchId = document.getElementById('schedule-batch-select').value;
            if (!batchId) {
                showMessage("Please select a batch first");
                return;
            }

            // Prompt for time input
            const timeInput = prompt("Enter time slot (e.g., 09:30, 14:15):");
            if (!timeInput || !timeInput.trim()) {
                return;
            }

            // Validate time format (HH:MM)
            const timePattern = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
            if (!timePattern.test(timeInput.trim())) {
                showMessage("Invalid time format. Please use HH:MM format (e.g., 09:30)");
                return;
            }

            const time = timeInput.trim();
           
            // Refresh batches to get latest data
            batches = safeParseJSON('spark_batches', []);
            const batch = batches.find(b => b.id === batchId);
            if (!batch) {
                showMessage("Batch not found");
                return;
            }

            if (!batch.timetable) batch.timetable = {};

            // Check if time slot already exists (check if any day has this time slot, even if empty)
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const existingKey = days.find(day => batch.timetable.hasOwnProperty(`${day}_${time}`));
            if (existingKey) {
                showMessage("This time slot already exists");
                return;
            }

            // Add empty entries for the new time slot (so it appears in the grid)
            // We don't set values, just ensure the keys exist so the row shows up
            days.forEach(day => {
                const classKey = `${day}_${time}`;
                if (!batch.timetable[classKey]) {
                    batch.timetable[classKey] = '';
                }
            });

            saveBatches();
           
            // Reload the schedule grid to show the new row
            renderScheduleGrid(batch.timetable);

            showMessage(`Time slot ${time} added successfully`);
        };

        // Initialize batch selects when admin tab is opened
        document.querySelectorAll('.tab-btn-admin').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.dataset.tab;
                if (tabId === 'admin-batch' || tabId === 'admin-timetable') {
                    populateBatchSelects();
                    if (tabId === 'admin-batch') {
                        renderBatchesList();
                    }
                }
            });
        });

        // ===== TEACHER BATCH TIMETABLE FUNCTIONS =====

        // Populate teacher batch select
        function populateTeacherBatchSelect() {
            const teacherSelect = document.getElementById('teacher-batch-select');
            if (!teacherSelect) return;
           
            const batches = safeParseJSON('spark_batches', []);
            const options = batches.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
            teacherSelect.innerHTML = '<option value="">Select Batch</option>' + options;
        }

        // Load teacher batch schedule
        window.loadTeacherBatchSchedule = function () {
            const batchId = document.getElementById('teacher-batch-select').value;
            const container = document.getElementById('teacher-schedule-container');
            const empty = document.getElementById('teacher-schedule-empty');

            if (!batchId) {
                if (container) container.classList.add('hidden');
                if (empty) empty.classList.remove('hidden');
                return;
            }

            // Always get fresh batches data from localStorage
            const batches = safeParseJSON('spark_batches', []);
            const batch = batches.find(b => b.id === batchId);
            if (!batch) return;

            if (container) container.classList.remove('hidden');
            if (empty) empty.classList.add('hidden');

            // Initialize timetable if not exists
            if (!batch.timetable || Object.keys(batch.timetable).length === 0) {
                batch.timetable = {};
                localStorage.setItem('spark_batches', JSON.stringify(batches));
            }

            // Always render with fresh data from localStorage
            renderTeacherScheduleGrid(batch.timetable, batchId);
        };

        // Render teacher schedule grid
        function renderTeacherScheduleGrid(timetable, batchId) {
            const tbody = document.getElementById('teacher-schedule-tbody');
            if (!tbody) return;

            // Always get fresh timetable data from localStorage to ensure we have latest changes
            const batches = safeParseJSON('spark_batches', []);
            const batch = batches.find(b => b.id === batchId);
            if (batch && batch.timetable) {
                timetable = batch.timetable; // Use fresh data
            }

            // Get time slots from timetable data (same logic as admin)
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const timeSlotsSet = new Set();
           
            Object.keys(timetable || {}).forEach(key => {
                const parts = key.split('_');
                if (parts.length >= 2 && days.includes(parts[0])) {
                    if (parts.length === 3 && parts[2] === 'room') {
                        const time = parts[1];
                        if (time) timeSlotsSet.add(time);
                    } else if (parts.length === 2) {
                        const time = parts[1];
                        if (time) timeSlotsSet.add(time);
                    }
                }
            });

            // Convert to sorted array (sort by time value)
            let timeSlots = Array.from(timeSlotsSet).sort((a, b) => {
                const timeToMinutes = (timeStr) => {
                    const [hours, minutes] = timeStr.split(':').map(Number);
                    return (hours || 0) * 60 + (minutes || 0);
                };
                return timeToMinutes(a) - timeToMinutes(b);
            });
           
            // If no time slots exist, show default time slots (8 AM to 6 PM) for initial setup
            if (timeSlots.length === 0) {
                for (let hour = 8; hour <= 18; hour++) {
                    timeSlots.push(`${hour.toString().padStart(2, '0')}:00`);
                }
            }

            tbody.innerHTML = timeSlots.map((time, timeIndex) => {
                // Escape time for use in HTML attributes
                const timeEscaped = time.replace(/'/g, "\\'");
                return `
                    <tr data-time="${time}" data-row-index="${timeIndex}">
                        <td class="p-3 border border-gray-700 text-gray-300 font-semibold bg-gray-800 align-top">${time}</td>
                        ${days.map(day => {
                            const key = `${day}_${time}`;
                            const roomKey = `${day}_${time}_room`;
                            const value = (timetable[key] || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                            const roomValue = (timetable[roomKey] || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                            return `
                                <td class="p-2 border border-gray-700 align-top">
                                    <div class="space-y-2">
                                        <input type="text"
                                            data-day="${day}"
                                            data-time="${time}"
                                            data-type="class"
                                            data-batch-id="${batchId}"
                                            value="${value}"
                                            placeholder="Subject/Teacher"
                                            class="w-full p-2 bg-gray-800/50 border border-gray-600 rounded text-white text-sm focus:border-green-500 outline-none">
                                        <input type="text"
                                            data-day="${day}"
                                            data-time="${time}"
                                            data-type="room"
                                            data-batch-id="${batchId}"
                                            value="${roomValue}"
                                            placeholder="Room No."
                                            class="w-full p-1.5 bg-gray-800/30 border border-gray-600 rounded text-white text-xs focus:border-green-500 outline-none">
                                    </div>
                                </td>
                            `;
                        }).join('')}
                        <td class="p-2 border border-gray-700 align-top">
                            <div class="flex gap-2 justify-center">
                                <button onclick="editTeacherTimetableRow('${timeEscaped}')"
                                    class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs font-semibold transition flex items-center gap-1"
                                    title="Edit Row">
                                    <i class="fas fa-edit text-xs"></i>
                                    <span>Edit</span>
                                </button>
                                <button onclick="deleteTeacherTimetableRow('${timeEscaped}')"
                                    class="px-3 py-1.5 bg-red-600 hover:bg-red-700 text-white rounded text-xs font-semibold transition flex items-center gap-1"
                                    title="Delete Row">
                                    <i class="fas fa-trash text-xs"></i>
                                    <span>Delete</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            // Add event listeners for real-time updates (class inputs)
            tbody.querySelectorAll('input[data-type="class"]').forEach(input => {
                input.addEventListener('input', function() {
                    const day = this.dataset.day;
                    const time = this.dataset.time;
                    const batchId = this.dataset.batchId;
                    const key = `${day}_${time}`;
                    const batches = safeParseJSON('spark_batches', []);
                    const batch = Array.isArray(batches) ? batches.find(b => b && b.id === batchId) : null;
                    if (batch) {
                        if (!batch.timetable) batch.timetable = {};
                        batch.timetable[key] = this.value;
                        localStorage.setItem('spark_batches', JSON.stringify(batches));
                    }
                });
            });

            // Add event listeners for room number updates
            tbody.querySelectorAll('input[data-type="room"]').forEach(input => {
                input.addEventListener('input', function() {
                    const day = this.dataset.day;
                    const time = this.dataset.time;
                    const batchId = this.dataset.batchId;
                    const key = `${day}_${time}_room`;
                    const batches = safeParseJSON('spark_batches', []);
                    const batch = Array.isArray(batches) ? batches.find(b => b && b.id === batchId) : null;
                    if (batch) {
                        if (!batch.timetable) batch.timetable = {};
                        batch.timetable[key] = this.value;
                        localStorage.setItem('spark_batches', JSON.stringify(batches));
                    }
                });
            });
        }

        // Save teacher batch schedule
        window.saveTeacherBatchSchedule = function () {
            const batchId = document.getElementById('teacher-batch-select').value;
            if (!batchId) {
                showMessage("Please select a batch");
                return;
            }

            const batches = safeParseJSON('spark_batches', []);
            const batch = batches.find(b => b.id === batchId);
            if (!batch) {
                showMessage("Batch not found");
                return;
            }

            if (!batch.timetable) batch.timetable = {};

            // Collect all input values (both class and room)
            const inputs = document.querySelectorAll('#teacher-schedule-tbody input');
            inputs.forEach(input => {
                const day = input.dataset.day;
                const time = input.dataset.time;
                const type = input.dataset.type || 'class';
                const key = type === 'room' ? `${day}_${time}_room` : `${day}_${time}`;
                batch.timetable[key] = input.value.trim();
            });

            localStorage.setItem('spark_batches', JSON.stringify(batches));
            showMessage(`Schedule saved for ${batch.name}`);
        };

        // Edit teacher timetable row - focuses on the first input of the row
        window.editTeacherTimetableRow = function (time) {
            const row = document.querySelector(`#teacher-schedule-tbody tr[data-time="${time}"]`);
            if (!row) return;
           
            const firstInput = row.querySelector('input[data-type="class"]');
            if (firstInput) {
                firstInput.focus();
                firstInput.select();
            }
        };

        // Delete teacher timetable row - removes all data for that time slot and removes the row
        window.deleteTeacherTimetableRow = function (time) {
            if (!confirm(`Are you sure you want to delete all classes for time slot ${time}? This will remove the entire row.`)) {
                return;
            }

            const batchId = document.getElementById('teacher-batch-select').value;
            if (!batchId) {
                showMessage("Please select a batch");
                return;
            }

            // Refresh batches to get latest data
            const batches = safeParseJSON('spark_batches', []);
            const batch = batches.find(b => b.id === batchId);
            if (!batch) {
                showMessage("Batch not found");
                return;
            }

            if (!batch.timetable) batch.timetable = {};

            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
           
            // Remove all entries for this time slot
            days.forEach(day => {
                const classKey = `${day}_${time}`;
                const roomKey = `${day}_${time}_room`;
                delete batch.timetable[classKey];
                delete batch.timetable[roomKey];
            });

            localStorage.setItem('spark_batches', JSON.stringify(batches));
           
            // Remove the row from DOM immediately (escape time for querySelector)
            const escapedTime = time.replace(/"/g, '\\"').replace(/'/g, "\\'");
            const row = document.querySelector(`#teacher-schedule-tbody tr[data-time="${escapedTime}"]`);
            if (row) {
                row.remove();
            }
           
            // Also reload the schedule grid to ensure consistency
            renderTeacherScheduleGrid(batch.timetable, batchId);

            showMessage(`Time slot ${time} deleted successfully`);
        };

        // Add new time slot for teacher
        window.addNewTeacherTimeSlot = function () {
            const batchId = document.getElementById('teacher-batch-select').value;
            if (!batchId) {
                showMessage("Please select a batch first");
                return;
            }

            // Prompt for time input
            const timeInput = prompt("Enter time slot (e.g., 09:30, 14:15):");
            if (!timeInput || !timeInput.trim()) {
                return;
            }

            // Validate time format (HH:MM)
            const timePattern = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
            if (!timePattern.test(timeInput.trim())) {
                showMessage("Invalid time format. Please use HH:MM format (e.g., 09:30)");
                return;
            }

            const time = timeInput.trim();
           
            // Refresh batches to get latest data
            const batches = safeParseJSON('spark_batches', []);
            const batch = batches.find(b => b.id === batchId);
            if (!batch) {
                showMessage("Batch not found");
                return;
            }

            if (!batch.timetable) batch.timetable = {};

            // Check if time slot already exists
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const existingKey = days.find(day => batch.timetable.hasOwnProperty(`${day}_${time}`));
            if (existingKey) {
                showMessage("This time slot already exists");
                return;
            }

            // Add empty entries for the new time slot (so it appears in the grid)
            days.forEach(day => {
                const classKey = `${day}_${time}`;
                if (!batch.timetable[classKey]) {
                    batch.timetable[classKey] = '';
                }
            });

            localStorage.setItem('spark_batches', JSON.stringify(batches));
           
            // Reload the schedule grid to show the new row
            renderTeacherScheduleGrid(batch.timetable, batchId);

            showMessage(`Time slot ${time} added successfully`);
        };

        // Initialize teacher batch select when teacher tab is opened
        document.querySelectorAll('.tab-btn-teacher').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.dataset.tab;
                if (tabId === 'teacher-timetable') {
                    populateTeacherBatchSelect();
                    // Reload schedule if batch is already selected
                    const batchSelect = document.getElementById('teacher-batch-select');
                    if (batchSelect && batchSelect.value) {
                        loadTeacherBatchSchedule();
                    }
                } else if (tabId === 'teacher-results') {
                    populateTeacherResultBatchSelect();
                }
            });
        });

        // ===== RESULT MANAGEMENT FUNCTIONS =====

        // Initialize result storage structure
        function getResultsStorage() {
            return safeParseJSON('spark_results', {});
        }

        function saveResultsStorage(results) {
            localStorage.setItem('spark_results', JSON.stringify(results));
        }

        // Populate teacher result batch select
        function populateTeacherResultBatchSelect() {
            const batchSelect = document.getElementById('teacher-result-batch');
            if (!batchSelect) return;
           
            const batches = safeParseJSON('spark_batches', []);
            batchSelect.innerHTML = '<option value="">Select a batch</option>';
            batches.forEach(batch => {
                const option = document.createElement('option');
                option.value = batch.id;
                option.textContent = batch.name;
                batchSelect.appendChild(option);
            });
        }

        // Populate admin result batch select
        function populateAdminResultBatchSelect() {
            const batchSelect = document.getElementById('admin-result-batch');
            if (!batchSelect) return;
           
            const batches = safeParseJSON('spark_batches', []);
            batchSelect.innerHTML = '<option value="">Select a batch</option>';
            batches.forEach(batch => {
                const option = document.createElement('option');
                option.value = batch.id;
                option.textContent = batch.name;
                batchSelect.appendChild(option);
            });
        }

        // Load students for result entry (Teacher)
        window.loadStudentsForResultEntry = function () {
            const batchId = document.getElementById('teacher-result-batch')?.value;
            const subject = document.getElementById('teacher-result-subject')?.value.trim();
            const examType = document.getElementById('teacher-result-exam-type')?.value;
            const container = document.getElementById('teacher-result-students-container');
            const empty = document.getElementById('teacher-result-empty');
            const tbody = document.getElementById('teacher-result-students-tbody');

            if (!batchId) {
                if (container) container.classList.add('hidden');
                if (empty) empty.classList.remove('hidden');
                return;
            }

            if (!subject || !examType) {
                showMessage("Please enter subject and select exam type");
                return;
            }

            const batches = safeParseJSON('spark_batches', []);
            const batch = batches.find(b => b.id === batchId);
            if (!batch) {
                showMessage("Batch not found");
                return;
            }

            const emailToNameMap = safeParseJSON('spark_email_name_map', {});
            const registeredUsers = safeParseJSON('registeredUsers', {});
           
            // Get existing results for this batch/subject/exam
            const results = getResultsStorage();
            const resultKey = `${batchId}_${subject}_${examType}`;
            const existingResults = results[resultKey] || {};

            // Build student list
            let html = '';
            let rollNo = 1;
           
            batch.students.forEach(email => {
                const userData = Object.values(registeredUsers).find(u => u.email?.toLowerCase() === email.toLowerCase());
                const studentName = userData?.name || emailToNameMap[email] || email.split('@')[0];
                const studentId = userData?.id || `STU-${rollNo}`;
                const existingMark = existingResults[email] || '';

                html += `
                    <tr class="hover:bg-gray-700/30 transition">
                        <td class="p-3 border border-gray-700 text-gray-300 font-mono">${studentId}</td>
                        <td class="p-3 border border-gray-700 text-white">${studentName}</td>
                        <td class="p-3 border border-gray-700 text-gray-400 text-sm">${email}</td>
                        <td class="p-3 border border-gray-700">
                            <input type="number"
                                data-email="${email}"
                                min="0"
                                max="100"
                                step="0.01"
                                value="${existingMark}"
                                placeholder="Enter marks"
                                class="w-full px-3 py-2 bg-gray-800 border border-gray-600 rounded text-white focus:border-green-500 outline-none">
                        </td>
                    </tr>
                `;
                rollNo++;
            });

            if (tbody) tbody.innerHTML = html;
            if (container) container.classList.remove('hidden');
            if (empty) empty.classList.add('hidden');
        };

        // Save student results (Teacher)
        window.saveStudentResults = function () {
            const batchId = document.getElementById('teacher-result-batch')?.value;
            const subject = document.getElementById('teacher-result-subject')?.value.trim();
            const examType = document.getElementById('teacher-result-exam-type')?.value;

            if (!batchId || !subject || !examType) {
                showMessage("Please fill in all fields (Batch, Subject, Exam Type)");
                return;
            }

            const inputs = document.querySelectorAll('#teacher-result-students-tbody input[data-email]');
            const results = getResultsStorage();
            const resultKey = `${batchId}_${subject}_${examType}`;
           
            if (!results[resultKey]) {
                results[resultKey] = {};
            }

            let hasMarks = false;
            inputs.forEach(input => {
                const email = input.dataset.email;
                const marks = input.value.trim();
                if (marks) {
                    results[resultKey][email] = parseFloat(marks);
                    hasMarks = true;
                } else {
                    delete results[resultKey][email];
                }
            });

            if (!hasMarks) {
                showMessage("Please enter at least one mark");
                return;
            }

            // Add metadata
            results[resultKey]._metadata = {
                batchId: batchId,
                subject: subject,
                examType: examType,
                updatedAt: new Date().toISOString(),
                updatedBy: 'teacher'
            };

            saveResultsStorage(results);
            showMessage("Results saved successfully!");
        };

        // Load student results (Student Portal)
        function loadStudentResults() {
            const container = document.getElementById('student-results-container');
            const empty = document.getElementById('student-results-empty');
           
            if (!loggedInUser) {
                if (empty) empty.classList.remove('hidden');
                return;
            }

            const userData = registeredUsers[loggedInUser.username] || {};
            const studentEmail = userData.email?.toLowerCase();
           
            if (!studentEmail) {
                if (empty) empty.classList.remove('hidden');
                return;
            }

            const results = getResultsStorage();
            const studentResults = [];

            // Find all results for this student
            Object.keys(results).forEach(key => {
                const resultData = results[key];
                if (resultData[studentEmail] !== undefined) {
                    const metadata = resultData._metadata || {};
                    studentResults.push({
                        subject: metadata.subject || 'Unknown',
                        examType: metadata.examType || 'Unknown',
                        marks: resultData[studentEmail],
                        batchId: metadata.batchId || '',
                        updatedAt: metadata.updatedAt || ''
                    });
                }
            });

            if (studentResults.length === 0) {
                if (empty) empty.classList.remove('hidden');
                if (container) container.innerHTML = '';
                return;
            }

            // Group by subject
            const groupedBySubject = {};
            studentResults.forEach(result => {
                if (!groupedBySubject[result.subject]) {
                    groupedBySubject[result.subject] = [];
                }
                groupedBySubject[result.subject].push(result);
            });

            // Build HTML
            let html = '';
            Object.keys(groupedBySubject).sort().forEach(subject => {
                html += `
                    <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-700 mb-4">
                        <h3 class="text-xl font-bold text-white mb-4">${subject}</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="bg-gray-800">
                                        <th class="p-3 border border-gray-700 text-gray-300 font-semibold">Exam Type</th>
                                        <th class="p-3 border border-gray-700 text-gray-300 font-semibold">Marks</th>
                                        <th class="p-3 border border-gray-700 text-gray-300 font-semibold">Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
               
                groupedBySubject[subject].forEach(result => {
                    const date = result.updatedAt ? new Date(result.updatedAt).toLocaleDateString() : '-';
                    html += `
                        <tr class="hover:bg-gray-700/30">
                            <td class="p-3 border border-gray-700 text-white">${result.examType}</td>
                            <td class="p-3 border border-gray-700">
                                <span class="text-lg font-bold text-blue-400">${result.marks}</span>
                                <span class="text-gray-400 text-sm ml-2">/ 100</span>
                            </td>
                            <td class="p-3 border border-gray-700 text-gray-400">${date}</td>
                        </tr>
                    `;
                });
               
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });

            if (container) {
                container.innerHTML = html;
                if (empty) empty.classList.add('hidden');
            }
        }

        // Load admin results (Admin Portal)
        window.loadAdminResults = function () {
            const batchId = document.getElementById('admin-result-batch')?.value;
            const container = document.getElementById('admin-results-container');
            const empty = document.getElementById('admin-results-empty');

            if (!batchId) {
                if (empty) empty.classList.remove('hidden');
                if (container) container.innerHTML = '';
                return;
            }

            const results = getResultsStorage();
            const batches = safeParseJSON('spark_batches', []);
            const batch = batches.find(b => b.id === batchId);
            const emailToNameMap = safeParseJSON('spark_email_name_map', {});
            const registeredUsers = safeParseJSON('registeredUsers', {});

            // Find all results for this batch
            const batchResults = [];
            Object.keys(results).forEach(key => {
                const resultData = results[key];
                const metadata = resultData._metadata || {};
                if (metadata.batchId === batchId) {
                    batchResults.push({
                        key: key,
                        subject: metadata.subject || 'Unknown',
                        examType: metadata.examType || 'Unknown',
                        data: resultData,
                        updatedAt: metadata.updatedAt || ''
                    });
                }
            });

            if (batchResults.length === 0) {
                if (empty) {
                    empty.innerHTML = `
                        <div class="w-20 h-20 rounded-full bg-gray-700/50 flex items-center justify-center mb-6 mx-auto">
                            <i class="fas fa-poll text-3xl text-gray-500"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-200 mb-2">No Results Found</h3>
                        <p class="text-gray-400">No results have been entered for this batch yet.</p>
                    `;
                    empty.classList.remove('hidden');
                }
                if (container) container.innerHTML = '';
                return;
            }

            // Build HTML grouped by subject and exam type
            let html = '';
            batchResults.forEach(resultInfo => {
                const { subject, examType, data, updatedAt } = resultInfo;
                const date = updatedAt ? new Date(updatedAt).toLocaleDateString() : '-';
               
                html += `
                    <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-700 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h3 class="text-xl font-bold text-white">${subject}</h3>
                                <p class="text-gray-400 text-sm">${examType} • Updated: ${date}</p>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="bg-gray-800">
                                        <th class="p-3 border border-gray-700 text-gray-300 font-semibold">Roll No</th>
                                        <th class="p-3 border border-gray-700 text-gray-300 font-semibold">Student Name</th>
                                        <th class="p-3 border border-gray-700 text-gray-300 font-semibold">Email</th>
                                        <th class="p-3 border border-gray-700 text-gray-300 font-semibold">Marks</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;

                // Get students from batch
                if (batch && batch.students) {
                    let rollNo = 1;
                    batch.students.forEach(email => {
                        const userData = Object.values(registeredUsers).find(u => u.email?.toLowerCase() === email.toLowerCase());
                        const studentName = userData?.name || emailToNameMap[email] || email.split('@')[0];
                        const studentId = userData?.id || `STU-${rollNo}`;
                        const marks = data[email] !== undefined ? data[email] : '-';

                        html += `
                            <tr class="hover:bg-gray-700/30">
                                <td class="p-3 border border-gray-700 text-gray-300 font-mono">${studentId}</td>
                                <td class="p-3 border border-gray-700 text-white">${studentName}</td>
                                <td class="p-3 border border-gray-700 text-gray-400 text-sm">${email}</td>
                                <td class="p-3 border border-gray-700">
                                    <span class="text-lg font-bold text-blue-400">${marks}</span>
                                    ${marks !== '-' ? '<span class="text-gray-400 text-sm ml-2">/ 100</span>' : ''}
                                </td>
                            </tr>
                        `;
                        rollNo++;
                    });
                }

                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            });

            if (container) {
                container.innerHTML = html;
                if (empty) empty.classList.add('hidden');
            }
        };

        // Initialize result batch selects when tabs are opened
        document.querySelectorAll('.tab-btn-admin').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.dataset.tab;
                if (tabId === 'admin-results') {
                    populateAdminResultBatchSelect();
                }
            });
        });

        // Load student results when results tab is clicked
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.dataset.tab;
                if (tabId === 'results') {
                    loadStudentResults();
                }
            });
        });

        window.addEventListener('load', async () => {
            // Show UI immediately without waiting for models
            const roleSelection = document.getElementById('role-selection');
            if (roleSelection) roleSelection.classList.remove('hidden');
            loading.classList.add('hidden');

            try {
                restoreSession();
            } catch (e) {
                console.error('Session restore error:', e);
            }

            try {
                restoreFormState();
            } catch (e) {
                console.error('Form restore error:', e);
            }

            // Load models in background (non-blocking)
            // Models will be loaded when actually needed (face recognition)
            loadModels().catch(err => {
                console.log('Background model loading failed, will retry when needed:', err);
            });
        });
    </script>

    <!-- Gemini Chat Widget -->
    <div id="gemini-chat-widget" class="gemini-chat-widget" style="display: none; flex-direction: column;">
        <div class="gemini-chat-header">
            <div class="gemini-icon">
                <i class="fas fa-robot text-slate-900"></i>
            </div>
            <h3>SmartClass AI Assistant</h3>
        </div>
        <div id="gemini-messages" class="gemini-chat-messages">
            <div class="gemini-message assistant">👋 Hi! I'm your spark AI. How can I help you today?</div>
        </div>
        <div class="gemini-chat-input-container">
            <input type="text" id="gemini-input" class="gemini-chat-input" placeholder="Type your message..." />
            <button id="gemini-send" class="gemini-send-btn">Send</button>
        </div>
    </div>

    <button id="gemini-toggle" class="gemini-toggle-btn">
        <i class="fas fa-robot text-2xl text-slate-900"></i>
    </button>



    <script type="module">
        // These variables are now declared ONLY ONCE to fix the "Redeclare" error
        const chatWidget = document.getElementById('gemini-chat-widget');
        const chatToggle = document.getElementById('gemini-toggle');
        const chatSendBtn = document.getElementById('gemini-send');
        const chatInputField = document.getElementById('gemini-input');
        const chatMessagesBox = document.getElementById('gemini-messages');

        // Check if all required elements exist before proceeding
        if (!chatWidget || !chatToggle || !chatSendBtn || !chatInputField || !chatMessagesBox) {
            console.error('Gemini chat widget elements not found. Some elements may be missing from the DOM.');
            // Exit early if elements are missing
        } else {
            let chatIsOpen = false;

            chatToggle.addEventListener('click', () => {
                chatIsOpen = !chatIsOpen;
                chatWidget.style.display = chatIsOpen ? 'flex' : 'none';
                if (chatIsOpen && chatInputField) chatInputField.focus();
            });

            // Close when clicking outside
            document.addEventListener('click', (e) => {
                if (chatIsOpen && chatWidget && chatToggle &&
                    !chatWidget.contains(e.target) && !chatToggle.contains(e.target)) {
                    chatIsOpen = false;
                    chatWidget.style.display = 'none';
                }
            });

            async function handleSendMessage() {
                if (!chatInputField || !chatMessagesBox || !chatSendBtn) return;
               
                const text = chatInputField.value.trim();
                if (!text) return;

                const userMsg = document.createElement('div');
                userMsg.className = 'gemini-message user';
                userMsg.textContent = text;
                chatMessagesBox.appendChild(userMsg);

                chatInputField.value = '';
                chatSendBtn.disabled = true;

                const aiMsg = document.createElement('div');
                aiMsg.className = 'gemini-message assistant';
                chatMessagesBox.appendChild(aiMsg);

                const typing = document.createElement('div');
                typing.className = 'gemini-typing';
                typing.innerHTML = '<span></span><span></span><span></span>';
                aiMsg.appendChild(typing);

                chatMessagesBox.scrollTop = chatMessagesBox.scrollHeight;

                try {
                    if (!window.geminiAI || typeof window.geminiAI.sendMessage !== 'function') {
                        throw new Error('AI service not available');
                    }
                    let isFirstChunk = true;
                    // Calls the Streaming Brain defined in the <head>
                    await window.geminiAI.sendMessage(text, (chunkText) => {
                        if (isFirstChunk && typing) {
                            typing.remove();
                            isFirstChunk = false;
                        }
                        if (aiMsg && chunkText) {
                            aiMsg.textContent += chunkText;
                        }
                        if (chatMessagesBox) {
                            chatMessagesBox.scrollTop = chatMessagesBox.scrollHeight;
                        }
                    });
                } catch (error) {
                    console.error('Chat error:', error);
                    if (typing) typing.remove();
                    if (aiMsg) {
                        aiMsg.textContent = '❌ Connection Error. Please check your API key or try again later.';
                    }
                }
                if (chatSendBtn) chatSendBtn.disabled = false;
            }

            chatSendBtn.onclick = handleSendMessage;
            chatInputField.onkeypress = (e) => { if (e.key === 'Enter') handleSendMessage(); };
        }
    </script>
</body>

</html>
